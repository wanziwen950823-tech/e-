<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>扫码平台 v2.6</title>
<style>
  body { background:#0d1117; color:#eee; font-family:'Segoe UI',sans-serif; padding:20px;}
  h2 { color:#4fa3ff; margin-bottom:10px;}
  .section { border:1px solid #333; padding:15px; border-radius:12px; margin-bottom:20px; background:#161b22;}
  input,select,button { padding:6px 10px; border-radius:6px; border:none; margin:3px;}
  input { width:200px;}
  table { width:100%; border-collapse:collapse; margin-top:10px;}
  th,td { border:1px solid #333; padding:6px; text-align:center;}
  th { background:#21262d;}
  tr.duplicate { background:#6e0101 !important; color:#fff;}
  button { background:#238636; color:white; cursor:pointer;}
  button:hover { background:#2ea043;}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<h2>扫码平台 v2.6</h2>

<div class="section">
  <h3>设备登记 (序列号 / UPC)</h3>
  <label>标签：</label>
  <select id="tag">
    <option>U1</option>
    <option>U2</option>
    <option>U3</option>
  </select>
  <input id="serial" placeholder="序列号 (Serial)">
  <input id="upc" placeholder="UPC">
  <button onclick="registerDevice()">登记设备</button>
  <button onclick="clearRecords()">清空记录</button>
  <button onclick="exportToExcel()">导出Excel</button>

  <p id="status" style="color:#aaa;font-size:13px;">扫描后自动提交</p>

  <table id="recordTable">
    <thead>
      <tr>
        <th>tag</th><th>serial</th><th>upc</th><th>device</th>
        <th>capacity</th><th>color</th><th>status</th><th>created_at</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="section">
  <h3>SKU映射录入</h3>
  <textarea id="skuInput" rows="5" style="width:100%;" placeholder="格式：UPC,Device,Capacity,Color，一行一条"></textarea><br>
  <button onclick="loadSKU()">加载SKU映射</button>
</div>

<script>
let scanRecords = [];
let skuMap = {};
let lastScanField = "serial";

// 输入框自动跳转逻辑
document.getElementById('serial').addEventListener('keydown', e=>{
  if(e.key==="Enter"){ e.preventDefault(); document.getElementById('upc').focus(); lastScanField="serial"; }
});
document.getElementById('upc').addEventListener('keydown', e=>{
  if(e.key==="Enter"){ e.preventDefault(); registerDevice(); lastScanField="upc"; }
});

// 设备登记函数
function registerDevice(){
  const tag = document.getElementById('tag').value.trim();
  const serial = document.getElementById('serial').value.trim();
  const upc = document.getElementById('upc').value.trim();

  if(!serial && !upc){ playError(); return; }

  // 检查重复
  const duplicate = scanRecords.some(r => r.serial===serial && serial);
  if(duplicate){ playError(); flashDuplicate(serial); return; }

  // 匹配 SKU
  const sku = skuMap[upc] || {};
  const now = new Date().toLocaleString('zh-CN',{hour12:false});
  const record = {
    tag, serial, upc,
    device: sku.device || "",
    capacity: sku.capacity || "",
    color: sku.color || "",
    status:"OK", created_at: now
  };
  scanRecords.push(record);
  renderTable();
  playOK();

  document.getElementById('serial').value="";
  document.getElementById('upc').value="";
  document.getElementById('serial').focus();
}

// 表格渲染
function renderTable(){
  const tbody=document.querySelector("#recordTable tbody");
  tbody.innerHTML="";
  scanRecords.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.tag}</td><td>${r.serial}</td><td>${r.upc}</td><td>${r.device}</td>
                  <td>${r.capacity}</td><td>${r.color}</td><td>${r.status}</td><td>${r.created_at}</td>`;
    tbody.appendChild(tr);
  });
}

// 清空
function clearRecords(){
  if(confirm("确定要清空全部记录吗？")){ scanRecords=[]; renderTable(); }
}

// 声音提示
function playOK(){
  const a=new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"); a.play();
}
function playError(){
  const a=new Audio("https://actions.google.com/sounds/v1/cartoon/metal_clang.ogg"); a.play();
}
function flashDuplicate(serial){
  const rows=document.querySelectorAll("#recordTable tbody tr");
  rows.forEach(r=>{ if(r.children[1].innerText===serial){ r.classList.add("duplicate"); }});
}

// SKU加载
function loadSKU(){
  const text=document.getElementById('skuInput').value.trim();
  const lines=text.split(/\n/);
  skuMap={};
  lines.forEach(line=>{
    const [upc,device,capacity,color]=line.split(',').map(v=>v.trim());
    if(upc) skuMap[upc]={device,capacity,color};
  });
  alert(`已加载 ${Object.keys(skuMap).length} 条 SKU 映射`);
}

// 导出Excel
function exportToExcel(){
  if(scanRecords.length===0){ alert("暂无数据可导出"); return; }

  const headers=["tag","serial","upc","device","capacity","color","status","created_at"];
  const data=[headers,...scanRecords.map(r=>[r.tag,r.serial,r.upc,r.device,r.capacity,r.color,r.status,r.created_at])];

  const ws=XLSX.utils.aoa_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"ScanLog");

  const now=new Date();
  const name=`scanlog_${now.getFullYear()}-${(now.getMonth()+1+"").padStart(2,"0")}-${(now.getDate()+"").padStart(2,"0")}_${now.getHours()}${now.getMinutes()}.xlsx`;
  XLSX.writeFile(wb,name);
}
</script>
</body>
</html>
