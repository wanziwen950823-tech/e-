<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>V3.5 标签系统完整版预览</title>
<style>
  body {
    background: #111;
    color: #fff;
    font-family: Arial, sans-serif;
    padding: 40px;
  }
  .container {
    width: 420px;
    margin: auto;
  }
  h2, h3 {
    margin: 0 0 12px;
  }
  .section {
    margin-bottom: 40px;
    padding: 16px;
    background: #1b1b1b;
    border-radius: 10px;
    border: 1px solid #333;
  }

  /* 输入框区域（扫描页标签选择） */
  .input-box {
    background: #222;
    padding: 12px;
    border-radius: 8px;
    position: relative;
  }
  .input-box input {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: none;
    outline: none;
    background: #333;
    color: #fff;
    font-size: 14px;
    cursor: pointer;
  }

  /* 下拉菜单（全局，脱离父级，避免被遮挡） */
  .dropdown-menu {
    position: fixed; /* 关键：相对视口定位，避免父元素 overflow 影响 */
    background: #1c1c1c;
    border: 1px solid #333;
    border-radius: 6px;
    z-index: 999999 !important;
    max-height: 240px;       /* 你指定的高度 */
    overflow-y: auto;
    overflow-x: hidden;
    padding: 5px 0;
    display: none;
  }
  .dropdown-item {
    padding: 8px 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    font-size: 14px;
  }
  .dropdown-item:hover {
    background: #333;
  }
  .dropdown-item input {
    margin-right: 8px;
  }

  /* 现代细滚动条 */
  .dropdown-menu::-webkit-scrollbar {
    width: 6px;
  }
  .dropdown-menu::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.25);
    border-radius: 3px;
  }
  .dropdown-menu::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.45);
  }
  .dropdown-menu::-webkit-scrollbar-track {
    background: transparent;
  }

  /* 导出区域 */
  .export-controls {
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
  }
  .export-controls select {
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid #444;
    background: #222;
    color: #fff;
    font-size: 14px;
  }

  .tag-list {
    max-height: 240px;     /* 同样 240px */
    overflow-y: auto;
    border: 1px solid #333;
    border-radius: 6px;
    padding: 8px;
    font-size: 14px;
  }
  .tag-row {
    padding: 6px 4px;
    border-bottom: 1px solid #333;
  }
  .tag-row:last-child {
    border-bottom: none;
  }

  .hint {
    font-size: 12px;
    color: #aaa;
    margin-top: 6px;
  }
</style>
</head>
<body>
<div class="container">
  <h2>V3.5 标签系统完整版预览</h2>

  <!-- ===================== 扫描页：多选标签下拉 ===================== -->
  <div class="section">
    <h3>扫描页：选择客户标签（多选）</h3>
    <div class="input-box" id="scanInputBox">
      <input
        type="text"
        id="tagInput"
        placeholder="点击选择客户标签（多选）"
        readonly
      />
    </div>
    <div class="hint">这里模拟你扫码时选择标签的效果：多选、240px 高度、细滚动条、不被遮挡。</div>
  </div>

  <!-- ===================== 导出页：按日期显示当天标签 ===================== -->
  <div class="section">
    <h3>导出页：根据日期只显示当天用过的标签</h3>

    <div class="export-controls">
      <span>选择日期：</span>
      <select id="dateSelect">
        <option value="2025-11-13">2025-11-13</option>
        <option value="2025-11-14">2025-11-14</option>
        <option value="2025-11-15">2025-11-15（10个客户示例）</option>
      </select>
    </div>

    <div class="tag-list" id="exportTagList"></div>
    <div class="hint">
      这里模拟你导出时的标签选择：只显示当天记录中出现过的客户，超过可视高度自动出现细滚动条。
    </div>
  </div>
</div>

<!-- 全局下拉菜单（脱离父级，防遮挡） -->
<div class="dropdown-menu" id="dropdownMenu"></div>

<script>
  /***********************
   * 模拟数据（你之后可以替换成真实数据）
   ***********************/

  // 扫描页：标签库（全部客户标签）
  const allTags = [
    "U1", "U2", "U3", "U4", "U5",
    "TIAND CHAO", "TIAND JIANG", "TIAND XIN", "TIAND BINGDAO",
    "ALEX", "ZHANGXIANSHENG", "KUN", "CUSTOMER 12"
  ];

  // 导出页：按日期保存当天的扫描记录（只看 tag 字段）
  const recordsByDate = {
    // 你举例的：只 3 个客户
    "2025-11-13": [
      { tag: "U3" },
      { tag: "U4" },
      { tag: "TIAND CHAO" }
    ],
    // 第二天 4 个
    "2025-11-14": [
      { tag: "U1" },
      { tag: "ZHANGXIANSHENG" },
      { tag: "TIAND CHAO" },
      { tag: "ALEX" },
      { tag: "U2" }
    ],
    // 第三天 10 个客户，演示滚动条
    "2025-11-15": [
      { tag: "U1" },
      { tag: "U2" },
      { tag: "U3" },
      { tag: "U4" },
      { tag: "U5" },
      { tag: "TIAND CHAO" },
      { tag: "TIAND JIANG" },
      { tag: "TIAND XIN" },
      { tag: "TIAND BINGDAO" },
      { tag: "ZHANGXIANSHENG" },
      { tag: "ALEX" },
      { tag: "KUN" }
    ]
  };

  /***********************
   * 扫描页：多选标签下拉
   ***********************/
  const scanInputBox = document.getElementById("scanInputBox");
  const tagInput = document.getElementById("tagInput");
  const dropdownMenu = document.getElementById("dropdownMenu");

  let dropdownOpen = false;
  let selectedTags = []; // 多选结果

  // 打开 / 关闭 下拉菜单
  function toggleDropdown() {
    if (!dropdownOpen) {
      openDropdown();
    } else {
      closeDropdown();
    }
  }

  function openDropdown() {
    dropdownMenu.innerHTML = "";
    // 生成多选项
    allTags.forEach(tag => {
      const div = document.createElement("div");
      div.className = "dropdown-item";

      const checked = selectedTags.includes(tag) ? "checked" : "";

      div.innerHTML = `
        <input type="checkbox" ${checked} />
        <span>${tag}</span>
      `;

      const checkbox = div.querySelector("input");

      // 点击行，切换选择
      div.addEventListener("click", (e) => {
        // 防止点击行时 checkbox 事件被触发两次
        if (e.target.tagName !== "INPUT") {
          checkbox.checked = !checkbox.checked;
        }
        onTagCheckedChange(tag, checkbox.checked);
      });

      dropdownMenu.appendChild(div);
    });

    // 计算位置（相对视口）
    const rect = scanInputBox.getBoundingClientRect();
    dropdownMenu.style.top = rect.bottom + "px";
    dropdownMenu.style.left = rect.left + "px";
    dropdownMenu.style.width = rect.width + "px";

    dropdownMenu.style.display = "block";
    dropdownOpen = true;
  }

  function closeDropdown() {
    dropdownMenu.style.display = "none";
    dropdownOpen = false;
  }

  // 更新选中标签数组 & 输入框显示
  function onTagCheckedChange(tag, isChecked) {
    if (isChecked) {
      if (!selectedTags.includes(tag)) {
        selectedTags.push(tag);
      }
    } else {
      selectedTags = selectedTags.filter(t => t !== tag);
    }
    updateTagInputText();
    // 这里你可以顺便把 selectedTags 同步到你真实的“当前扫描记录”里
  }

  function updateTagInputText() {
    if (selectedTags.length === 0) {
      tagInput.value = "";
      tagInput.placeholder = "点击选择客户标签（多选）";
    } else {
      tagInput.value = selectedTags.join(", ");
    }
  }

  // 点击输入框打开/关闭
  scanInputBox.addEventListener("click", (e) => {
    toggleDropdown();
  });

  // 点击页面其它地方时关闭下拉
  document.addEventListener("click", (e) => {
    if (!scanInputBox.contains(e.target) && !dropdownMenu.contains(e.target)) {
      if (dropdownOpen) {
        closeDropdown();
      }
    }
  });

  /***********************
   * 导出页：按日期显示当天标签（不排序 + 240px 滚动）
   ***********************/
  const dateSelect = document.getElementById("dateSelect");
  const exportTagList = document.getElementById("exportTagList");

  function renderExportTags(date) {
    const records = recordsByDate[date] || [];
    exportTagList.innerHTML = "";

    const usedTags = [];
    const set = new Set();

    // 不排序，按出现顺序
    records.forEach(r => {
      const tag = r.tag;
      if (!set.has(tag)) {
        set.add(tag);
        usedTags.push(tag);
      }
    });

    if (usedTags.length === 0) {
      const empty = document.createElement("div");
      empty.className = "tag-row";
      empty.textContent = "当天没有记录";
      exportTagList.appendChild(empty);
      return;
    }

    usedTags.forEach(tag => {
      const row = document.createElement("div");
      row.className = "tag-row";
      row.textContent = tag;
      exportTagList.appendChild(row);
    });
  }

  // 初始化默认日期
  renderExportTags(dateSelect.value);

  // 切换日期时重新渲染
  dateSelect.addEventListener("change", (e) => {
    renderExportTags(e.target.value);
  });
</script>
</body>
</html>
