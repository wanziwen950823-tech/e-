<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>扫码平台 · 运单/设备 双模块 · 暗色</title>
  <style>
    :root{
      --bg:#0b0f14;--panel:#121822;--card:#0f1520;--muted:#98a2b3;--text:#e8eef6;--accent:#4cc9f0;--accent2:#7c5cff;--good:#16a34a;--warn:#f59e0b;--bad:#ef4444;--line:#1f2937;
      --chip:#1b2331; --chip-b:#2b364a; --btn:#1a2232; --btn-b:#2a3448;
    }
    html,body{height:100%;}
    body{margin:0;background:linear-gradient(180deg,#0a0e14 0%,#0b111a 100%);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;}
    .wrap{max-width:1200px;margin:0 auto;padding:24px;}
    .title{display:flex;gap:12px;align-items:center;margin-bottom:16px}
    .logo{width:14px;height:14px;border-radius:4px;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 0 0 2px #111 inset}
    h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}

    /* tabs */
    .tabs{display:flex;gap:8px;margin:8px 0 20px}
    .tab{cursor:pointer;padding:10px 14px;border-radius:10px;background:var(--btn);border:1px solid var(--btn-b);color:var(--text);opacity:.85}
    .tab.active{background:linear-gradient(180deg,#151d2b,#0f1623);border-color:#2a3a55;opacity:1;box-shadow:0 0 0 1px #2a3a55 inset}

    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    .panel{background:linear-gradient(180deg,#0c1220,#0a111c);border:1px solid #1e2a3f;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #1f2a40}
    .head h2{font-size:14px;margin:0;color:#cdd6e5}

    .form{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;padding:16px}
    .form .full{grid-column:1/-1}
    input,select,button{height:38px;padding:0 10px;border-radius:10px;border:1px solid #2a3448;background:#0e1522;color:var(--text);outline:none}
    input::placeholder{color:#6b7280}
    button{cursor:pointer;background:linear-gradient(180deg,#1a2232,#121a28);border-color:#2a3448}
    .primary{background:linear-gradient(180deg,#1d2a40,#132135);border-color:#2f405e}
    .accent{background:linear-gradient(180deg,#214155,#163042);border-color:#2e5a76;color:#dbeafe}
    .good{background:linear-gradient(180deg,#12361f,#0f2a19);border-color:#1d4d2b}
    .bad{background:linear-gradient(180deg,#3a1212,#2a0f0f);border-color:#5a1f1f}

    table{width:100%;border-collapse:separate;border-spacing:0 8px;padding:0 16px 16px}
    thead th{font-size:12px;font-weight:600;color:#9fb0c7;text-align:left;padding:0 8px}
    tbody tr{background:linear-gradient(180deg,#0c1320,#0b101a);border:1px solid #1e2a40}
    tbody td{padding:10px 8px;border-top:1px solid #1e2a40;border-bottom:1px solid #1e2a40}
    tbody tr{border-radius:12px;overflow:hidden}

    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--chip-b);padding:4px 8px;border-radius:999px;font-size:12px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center}
    .stat{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;padding:12px 16px;border-top:1px dashed #23334d;background:linear-gradient(180deg,#0b111c,#0a0f18)}
    .card{background:linear-gradient(180deg,#0d1320,#0b111a);border:1px solid #1e2940;border-radius:12px;padding:12px}
    .card .v{font-size:20px;font-weight:700}

    .flex{display:flex;gap:10px;align-items:center}
    .right{margin-left:auto}

    .hidden{display:none}
    .btn-sm{height:30px;padding:0 10px;border-radius:8px;font-size:12px}
    .k{color:#7aa2f7}

    .footer{margin-top:22px;color:#8b9ab3;text-align:center;font-size:12px}
    .link{color:#9ecbff}

    .toggle{display:inline-flex;gap:8px;align-items:center}
    .toggle input{width:18px;height:18px}

    .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2a3a55;background:#121a2b;color:#c6d6f0}

    .tagbox{display:flex;gap:6px;flex-wrap:wrap}
    .tag{padding:4px 8px;background:#111827;border:1px solid #243047;border-radius:999px;font-size:12px}

    .exp-row{background:#0d1526;border-left:3px solid #2e4a7a}

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="title"><div class="logo"></div><h1>扫码平台 · 运单/设备双模块 · 暗色</h1><span class="pill">本地运行 / 可部署到 GitHub Pages</span><span class="right muted">v1.0</span></div>
  
  <div class="tabs">
    <div class="tab active" data-tab="tracking">运单登记</div>
    <div class="tab" data-tab="device">设备登记</div>
    <div class="tab" data-tab="summary">汇总 / 明细</div>
    <div class="tab" data-tab="settings">设置</div>
  </div>

  <!-- Tracking Panel -->
  <section id="panel-tracking" class="panel">
    <div class="head">
      <h2>运单登记（FedEx 截取后12位 / UPS 保留完整）</h2>
      <div class="flex">
        <button class="btn-sm" id="btnExportTracking">导出CSV</button>
        <label class="btn-sm accent" for="impT">导入CSV</label>
        <input id="impT" type="file" accept=".csv" class="hidden" />
        <button class="btn-sm bad" id="btnClearTracking">清空运单</button>
      </div>
    </div>

    <div class="form">
      <input id="t_tag" placeholder="标记（如 A001）" />
      <input id="t_input" placeholder="扫描或输入运单号（FedEx/UPS）" />
      <select id="t_type">
        <option value="auto">自动识别</option>
        <option value="FedEx">FedEx</option>
        <option value="UPS">UPS</option>
      </select>
      <input id="t_note" placeholder="备注（可选）" />
      <button id="btnAddTracking" class="primary">登记运单</button>
      <button id="btnFocusT" title="聚焦输入">聚焦</button>
    </div>

    <div class="stat" id="tStat">
      <div class="card"><div class="muted">运单总数</div><div class="v" id="tCount">0</div></div>
      <div class="card"><div class="muted">FedEx</div><div class="v" id="tFedex">0</div></div>
      <div class="card"><div class="muted">UPS</div><div class="v" id="tUps">0</div></div>
      <div class="card"><div class="muted">标记种类</div><div class="v" id="tTags">0</div></div>
    </div>

    <table>
      <thead>
        <tr><th>标记</th><th>运单号</th><th>类型</th><th>时间</th><th>备注</th><th>操作</th></tr>
      </thead>
      <tbody id="tBody"></tbody>
    </table>
  </section>

  <!-- Device Panel -->
  <section id="panel-device" class="panel hidden">
    <div class="head">
      <h2>设备登记（序列号 / UPC）</h2>
      <div class="flex">
        <button class="btn-sm" id="btnExportDevice">导出CSV</button>
        <label class="btn-sm accent" for="impD">导入CSV</label>
        <input id="impD" type="file" accept=".csv" class="hidden" />
        <button class="btn-sm bad" id="btnClearDevice">清空设备</button>
      </div>
    </div>

    <div class="form">
      <input id="d_tag" placeholder="标记（如 A001）" />
      <input id="d_serial" placeholder="序列号（Serial）" />
      <input id="d_upc" placeholder="UPC" />
      <div class="toggle"><input id="dupWarn" type="checkbox" checked /><label for="dupWarn">重复提示音</label></div>
      <button id="btnAddDevice" class="primary">登记设备</button>
      <button id="btnFocusD">聚焦</button>
      <div class="full muted">提示：序列号重复会高亮并播放提示音（可在设置中关闭）。</div>
    </div>

    <div class="stat" id="dStat">
      <div class="card"><div class="muted">设备总数</div><div class="v" id="dCount">0</div></div>
      <div class="card"><div class="muted">唯一序列号</div><div class="v" id="dUnique">0</div></div>
      <div class="card"><div class="muted">标记种类</div><div class="v" id="dTags">0</div></div>
      <div class="card"><div class="muted">最近登记</div><div class="v" id="dLast">-</div></div>
    </div>

    <table>
      <thead>
        <tr><th>标记</th><th>序列号</th><th>UPC</th><th>时间</th><th>状态</th><th>操作</th></tr>
      </thead>
      <tbody id="dBody"></tbody>
    </table>
  </section>

  <!-- Summary Panel -->
  <section id="panel-summary" class="panel hidden">
    <div class="head">
      <h2>汇总 / 明细（按标记 Tag 独立统计）</h2>
      <div class="flex">
        <button id="btnExpandAll" class="btn-sm">全部展开</button>
        <button id="btnCollapseAll" class="btn-sm">全部收起</button>
      </div>
    </div>

    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div>
        <div class="row" style="padding:12px 16px"><div class="chip">运单汇总</div><span class="muted">（点击行右侧 ▶ 展开明细）</span></div>
        <table>
          <thead><tr><th>标记</th><th>运单数量</th><th>最近时间</th><th>操作</th></tr></thead>
          <tbody id="sumT"></tbody>
        </table>
      </div>
      <div>
        <div class="row" style="padding:12px 16px"><div class="chip">设备汇总</div><span class="muted">（点击行右侧 ▶ 展开明细）</span></div>
        <table>
          <thead><tr><th>标记</th><th>设备数量</th><th>最近时间</th><th>操作</th></tr></thead>
          <tbody id="sumD"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Settings Panel -->
  <section id="panel-settings" class="panel hidden">
    <div class="head"><h2>设置</h2></div>
    <div class="form">
      <div class="toggle"><input id="setFedexTail" type="checkbox" checked /><label for="setFedexTail">FedEx 仅保留后 12 位</label></div>
      <div class="toggle"><input id="setSound" type="checkbox" checked /><label for="setSound">启用提示音</label></div>
      <div class="toggle"><input id="setConfirmDelete" type="checkbox" checked /><label for="setConfirmDelete">删除前确认</label></div>
      <div class="full muted">所有设置与数据均保存在本机浏览器（localStorage）。</div>
    </div>
  </section>

  <div class="footer">© 扫码平台 · 本地运行。建议部署到 <span class="link">GitHub Pages</span> 便于多人使用。</div>
</div>

<script>
/* ==========================
   本地存储（localStorage）
   ========================== */
const store = {
  load(){
    const d = JSON.parse(localStorage.getItem('SCAN_PLATFORM_V1')||'{}');
    return Object.assign({
      settings:{ fedexTail12:true, sound:true, confirmDelete:true },
      tracking:[], // {id, tag, tracking, type, note, created_at}
      device:[]    // {id, tag, serial, upc, status, created_at}
    }, d);
  },
  save(data){ localStorage.setItem('SCAN_PLATFORM_V1', JSON.stringify(data)); }
};
let DB = store.load();

/* ==========================
   工具函数
   ========================== */
const $ = sel => document.querySelector(sel);
const el = (tag, attrs={}, html='')=>{ const n=document.createElement(tag); for(const k in attrs){ if(k==='class') n.className=attrs[k]; else n.setAttribute(k, attrs[k]); } if(html) n.innerHTML=html; return n; }
const now = ()=> new Date().toLocaleString('zh-CN', {hour12:false});
const play = (type)=>{ if(!DB.settings.sound) return; const a = new Audio(); a.src = type==='ok'?URL_OK: type==='warn'?URL_WARN: URL_ERR; a.volume=.45; a.play(); };
const URL_OK = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAABkAAAA';
const URL_WARN='data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAABkAAAA';
const URL_ERR = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10 IBAAAAABAAEAESsAACJWAAACABYAAABkAAAA'.replace(/\s+/g,'');

/* ==========================
   Tabs 切换
   ========================== */
const tabs = document.querySelectorAll('.tab');
function showTab(name){
  tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
  $('#panel-tracking').classList.toggle('hidden', name!=='tracking');
  $('#panel-device').classList.toggle('hidden', name!=='device');
  $('#panel-summary').classList.toggle('hidden', name!=='summary');
  $('#panel-settings').classList.toggle('hidden', name!=='settings');
}
[...tabs].forEach(t=> t.addEventListener('click', ()=> showTab(t.dataset.tab)) );

/* ==========================
   规范化：运单号识别
   ========================== */
function normalizeTracking(raw, forceType){
  let s = (raw||'').trim().toUpperCase().replace(/\s+/g,'');
  let type = 'Unknown';
  if(forceType && forceType!=='auto') type = forceType;
  if(!forceType || forceType==='auto'){
    if(/^1Z[0-9A-Z]{16}$/.test(s)) type='UPS';
    else if(/^\d{12,22}$/.test(s)) type='FedEx';
  }
  if(type==='FedEx' && DB.settings.fedexTail12 && s.length>12 && /^\d+$/.test(s)) s = s.slice(-12);
  return {tracking:s, type};
}

/* ==========================
   运单登记
   ========================== */
const tTag = $('#t_tag'), tInput=$('#t_input'), tType=$('#t_type'), tNote=$('#t_note');
$('#btnAddTracking').addEventListener('click', addTracking);
$('#btnFocusT').addEventListener('click', ()=> tInput.focus());
$('#btnClearTracking').addEventListener('click', ()=> { if(!DB.settings.confirmDelete||confirm('确定清空所有运单记录？')){ DB.tracking=[]; store.save(DB); renderTracking(); renderSummary(); }});
$('#btnExportTracking').addEventListener('click', ()=> exportCSV('tracking'));
$('#impT').addEventListener('change', e=> importCSV(e,'tracking'));

tInput.addEventListener('keydown', e=>{ if(e.key==='Enter') addTracking(); });
function addTracking(){
  const tag = tTag.value.trim();
  const raw = tInput.value.trim();
  if(!raw){ tInput.focus(); return; }
  const {tracking, type} = normalizeTracking(raw, tType.value);
  DB.tracking.push({ id: Date.now()+Math.random(), tag, tracking, type, note:tNote.value.trim(), created_at: now() });
  store.save(DB);
  tInput.value=''; tNote.value=''; play('ok');
  renderTracking(); renderSummary();
}

function renderTracking(){
  const body = $('#tBody'); body.innerHTML='';
  // stats
  $('#tCount').textContent = DB.tracking.length;
  $('#tFedex').textContent = DB.tracking.filter(x=>x.type==='FedEx').length;
  $('#tUps').textContent   = DB.tracking.filter(x=>x.type==='UPS').length;
  $('#tTags').textContent  = new Set(DB.tracking.map(x=>x.tag||'')).size;

  DB.tracking.slice().reverse().forEach(r=>{
    const tr = el('tr');
    tr.appendChild(el('td',{},`<span class="chip mono">${r.tag||'-'}</span>`));
    tr.appendChild(el('td',{},`<span class="mono">${r.tracking}</span>`));
    tr.appendChild(el('td',{}, r.type));
    tr.appendChild(el('td',{}, r.created_at));
    tr.appendChild(el('td',{}, r.note||''));
    const ops = el('td');
    const del = el('button',{class:'btn-sm bad'},'删除');
    del.onclick=()=>{ if(!DB.settings.confirmDelete||confirm('删除该运单记录？')){ DB.tracking = DB.tracking.filter(x=>x.id!==r.id); store.save(DB); renderTracking(); renderSummary(); }};
    ops.appendChild(del);
    tr.appendChild(ops);
    $('#tBody').appendChild(tr);
  });
}

/* ==========================
   设备登记
   ========================== */
const dTag=$('#d_tag'), dSerial=$('#d_serial'), dUPC=$('#d_upc');
$('#btnAddDevice').addEventListener('click', addDevice);
$('#btnFocusD').addEventListener('click', ()=> (dSerial.value? dUPC : dSerial).focus());
$('#btnClearDevice').addEventListener('click', ()=> { if(!DB.settings.confirmDelete||confirm('确定清空所有设备记录？')){ DB.device=[]; store.save(DB); renderDevice(); renderSummary(); }});
$('#btnExportDevice').addEventListener('click', ()=> exportCSV('device'));
$('#impD').addEventListener('change', e=> importCSV(e,'device'));

dSerial.addEventListener('keydown', e=>{ if(e.key==='Enter'){ dUPC.focus(); } });
dUPC.addEventListener('keydown', e=>{ if(e.key==='Enter'){ addDevice(); } });

function addDevice(){
  const tag = dTag.value.trim();
  const serial = (dSerial.value||'').trim().toUpperCase();
  const upc = (dUPC.value||'').trim();
  if(!serial && !upc){ dSerial.focus(); return; }
  // 重复检查（序列号）
  if(serial){
    const dup = DB.device.some(x=>x.serial===serial);
    if(dup){ play('warn'); }
  }
  DB.device.push({ id: Date.now()+Math.random(), tag, serial, upc, status: 'OK', created_at: now() });
  store.save(DB);
  dSerial.value=''; dUPC.value=''; play('ok');
  renderDevice(); renderSummary();
}

function renderDevice(){
  const body=$('#dBody'); body.innerHTML='';
  const uniq = new Set(DB.device.map(x=>x.serial).filter(Boolean));
  $('#dCount').textContent = DB.device.length;
  $('#dUnique').textContent= uniq.size;
  $('#dTags').textContent  = new Set(DB.device.map(x=>x.tag||'')).size;
  $('#dLast').textContent  = DB.device.length? DB.device[DB.device.length-1].created_at : '-';

  DB.device.slice().reverse().forEach(r=>{
    const tr=el('tr');
    tr.appendChild(el('td',{},`<span class="chip mono">${r.tag||'-'}</span>`));
    const sCell=el('td'); sCell.innerHTML = r.serial? `<span class="mono">${r.serial}</span>`:'-';
    if(r.serial && DB.device.filter(x=>x.serial===r.serial).length>1){ sCell.style.color='var(--bad)'; sCell.style.fontWeight='700'; }
    tr.appendChild(sCell);
    tr.appendChild(el('td',{}, r.upc? `<span class="mono">${r.upc}</span>`:'-'));
    tr.appendChild(el('td',{}, r.created_at));
    tr.appendChild(el('td',{}, r.status));
    const ops=el('td');
    const del=el('button',{class:'btn-sm bad'},'删除');
    del.onclick=()=>{ if(!DB.settings.confirmDelete||confirm('删除该设备记录？')){ DB.device=DB.device.filter(x=>x.id!==r.id); store.save(DB); renderDevice(); renderSummary(); }};
    ops.appendChild(del); tr.appendChild(ops); body.appendChild(tr);
  });
}

/* ==========================
   汇总 / 明细（可展开）
   ========================== */
function groupByTag(list){
  const map=new Map();
  list.forEach(r=>{ const k=r.tag||''; if(!map.has(k)) map.set(k,[]); map.get(k).push(r); });
  return map;
}

function renderSummary(){
  // 运单
  const sumT=$('#sumT'); sumT.innerHTML='';
  const gT = groupByTag(DB.tracking);
  [...gT.entries()].sort((a,b)=> (a[0]||'').localeCompare(b[0]||'')).forEach(([tag, arr])=>{
    const last = arr[arr.length-1]?.created_at || '-';
    const tr=el('tr');
    tr.appendChild(el('td',{},`<span class="chip mono">${tag||'-'}</span>`));
    tr.appendChild(el('td',{}, String(arr.length)));
    tr.appendChild(el('td',{}, last));
    const op=el('td');
    const btn=el('button',{class:'btn-sm'},'▶ 展开');
    let open=false; let detailRows=[];
    btn.onclick=()=>{
      open=!open; btn.textContent=open?'▼ 收起':'▶ 展开';
      if(open){
        arr.forEach(r=>{
          const dr=el('tr',{class:'exp-row'});
          dr.appendChild(el('td',{},''));
          dr.appendChild(el('td',{},`<span class="mono">${r.type}</span> · <span class="mono">${r.tracking}</span>`));
          dr.appendChild(el('td',{}, r.created_at));
          const td=el('td');
          const dbtn=el('button',{class:'btn-sm bad'},'删除');
          dbtn.onclick=()=>{ if(!DB.settings.confirmDelete||confirm('删除该运单记录？')){ DB.tracking=DB.tracking.filter(x=>x.id!==r.id); store.save(DB); renderTracking(); renderSummary(); } };
          td.appendChild(dbtn); dr.appendChild(td);
          tr.parentNode.insertBefore(dr, tr.nextSibling);
          detailRows.push(dr);
        });
      }else{
        detailRows.forEach(n=> n.remove()); detailRows=[];
      }
    };
    op.appendChild(btn);
    const xbtn=el('button',{class:'btn-sm right'},'导出此标记');
    xbtn.onclick=()=> exportCSVTag('tracking', tag);
    op.appendChild(xbtn);
    tr.appendChild(op); sumT.appendChild(tr);
  });

  // 设备
  const sumD=$('#sumD'); sumD.innerHTML='';
  const gD = groupByTag(DB.device);
  [...gD.entries()].sort((a,b)=> (a[0]||'').localeCompare(b[0]||'')).forEach(([tag, arr])=>{
    const last = arr[arr.length-1]?.created_at || '-';
    const tr=el('tr');
    tr.appendChild(el('td',{},`<span class="chip mono">${tag||'-'}</span>`));
    tr.appendChild(el('td',{}, String(arr.length)));
    tr.appendChild(el('td',{}, last));
    const op=el('td');
    const btn=el('button',{class:'btn-sm'},'▶ 展开');
    let open=false; let detailRows=[];
    btn.onclick=()=>{
      open=!open; btn.textContent=open?'▼ 收起':'▶ 展开';
      if(open){
        arr.forEach(r=>{
          const dr=el('tr',{class:'exp-row'});
          dr.appendChild(el('td',{},''));
          dr.appendChild(el('td',{},`SN <span class="mono">${r.serial||'-'}</span> · UPC <span class="mono">${r.upc||'-'}</span>`));
          dr.appendChild(el('td',{}, r.created_at));
          const td=el('td');
          const dbtn=el('button',{class:'btn-sm bad'},'删除');
          dbtn.onclick=()=>{ if(!DB.settings.confirmDelete||confirm('删除该设备记录？')){ DB.device=DB.device.filter(x=>x.id!==r.id); store.save(DB); renderDevice(); renderSummary(); } };
          td.appendChild(dbtn); dr.appendChild(td);
          tr.parentNode.insertBefore(dr, tr.nextSibling);
          detailRows.push(dr);
        });
      }else{
        detailRows.forEach(n=> n.remove()); detailRows=[];
      }
    };
    op.appendChild(btn);
    const xbtn=el('button',{class:'btn-sm right'},'导出此标记');
    xbtn.onclick=()=> exportCSVTag('device', tag);
    op.appendChild(xbtn);
    tr.appendChild(op); sumD.appendChild(tr);
  });
}

$('#btnExpandAll').addEventListener('click', ()=> {
  document.querySelectorAll('#sumT .btn-sm, #sumD .btn-sm').forEach(b=>{ if(b.textContent==='▶ 展开') b.click(); });
});
$('#btnCollapseAll').addEventListener('click', ()=> {
  document.querySelectorAll('#sumT .btn-sm, #sumD .btn-sm').forEach(b=>{ if(b.textContent==='▼ 收起') b.click(); });
});

/* ==========================
   导入 / 导出 CSV
   ========================== */
function toCSV(rows){
  return rows.map(r=> r.map(v=> {
    const s = (v==null?'':String(v));
    return /[",\n]/.test(s)? '"'+s.replace(/"/g,'""')+'"' : s;
  }).join(',')).join('\n');
}

function exportCSV(kind){
  let rows=[], name='';
  if(kind==='tracking'){
    rows=[['tag','tracking','type','note','created_at']].concat(DB.tracking.map(r=>[r.tag||'',r.tracking,r.type,r.note||'',r.created_at]));
    name='tracking';
  }else{
    rows=[['tag','serial','upc','status','created_at']].concat(DB.device.map(r=>[r.tag||'',r.serial||'',r.upc||'',r.status||'',r.created_at]));
    name='device';
  }
  const blob=new Blob(["\ufeff"+toCSV(rows)],{type:'text/csv;charset=utf-8;'});
  const a=el('a',{download:`${name}_${Date.now()}.csv`}); a.href=URL.createObjectURL(blob); a.click();
}

function exportCSVTag(kind, tag){
  let rows=[], name='';
  if(kind==='tracking'){
    const arr = DB.tracking.filter(r=> (r.tag||'')===tag);
    rows=[['tag','tracking','type','note','created_at']].concat(arr.map(r=>[r.tag||'',r.tracking,r.type,r.note||'',r.created_at]));
    name='tracking_'+(tag||'blank');
  }else{
    const arr = DB.device.filter(r=> (r.tag||'')===tag);
    rows=[['tag','serial','upc','status','created_at']].concat(arr.map(r=>[r.tag||'',r.serial||'',r.upc||'',r.status||'',r.created_at]));
    name='device_'+(tag||'blank');
  }
  const blob=new Blob(["\ufeff"+toCSV(rows)],{type:'text/csv;charset=utf-8;'});
  const a=el('a',{download:`${name}_${Date.now()}.csv`}); a.href=URL.createObjectURL(blob); a.click();
}

function importCSV(evt, kind){
  const file=evt.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    const text=reader.result; const lines = text.split(/\r?\n/).filter(x=>x.trim().length);
    const head = lines.shift().split(',').map(x=>x.replace(/^\uFEFF/,''));
    const rows = lines.map(l=> l.split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/));
    if(kind==='tracking'){
      // 期望列：tag,tracking,type,note,created_at
      rows.forEach(r=>{
        const [tag,tracking,type,note,created_at] = r.map(s=> s.replace(/^"|"$/g,'').replace(/""/g,'"'));
        const norm = normalizeTracking(tracking, type==='auto'? 'auto': type);
        DB.tracking.push({ id: Date.now()+Math.random(), tag:tag||'', tracking:norm.tracking, type:norm.type||'Unknown', note:note||'', created_at: created_at||now() });
      });
      store.save(DB); renderTracking(); renderSummary();
    }else{
      // 期望列：tag,serial,upc,status,created_at
      rows.forEach(r=>{
        const [tag,serial,upc,status,created_at] = r.map(s=> s.replace(/^"|"$/g,'').replace(/""/g,'"'));
        DB.device.push({ id: Date.now()+Math.random(), tag:tag||'', serial:(serial||'').toUpperCase(), upc:upc||'', status: status||'OK', created_at: created_at||now() });
      });
      store.save(DB); renderDevice(); renderSummary();
    }
    evt.target.value='';
  };
  reader.readAsText(file, 'utf-8');
}

/* ==========================
   设置
   ========================== */
const setFedexTail=$('#setFedexTail'); const setSound=$('#setSound'); const setConfirm=$('#setConfirmDelete');
setFedexTail.checked = !!DB.settings.fedexTail12;
setSound.checked = !!DB.settings.sound;
setConfirm.checked = !!DB.settings.confirmDelete;
setFedexTail.addEventListener('change', ()=>{ DB.settings.fedexTail12=setFedexTail.checked; store.save(DB); });
setSound.addEventListener('change', ()=>{ DB.settings.sound=setSound.checked; store.save(DB); });
setConfirm.addEventListener('change', ()=>{ DB.settings.confirmDelete=setConfirm.checked; store.save(DB); });

/* ==========================
   初始化渲染
   ========================== */
renderTracking();
renderDevice();
renderSummary();
showTab('tracking');
</script>
</body>
</html>
