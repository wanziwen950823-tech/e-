<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>扫码平台 · 运单号 + 序列号 + SKU 自动识别</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body { background: #f8fafc; font-family: ui-sans-serif, system-ui; }
.card { background: #fff; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 1.5rem; margin-top: 1.5rem; }
.btn { background: #2563eb; color: #fff; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
.btn:hover { background: #1e40af; }
input, select { border: 1px solid #ddd; border-radius: 0.375rem; padding: 0.4rem; }
table { width: 100%; border-collapse: collapse; }
th, td { border: 1px solid #ddd; padding: 0.5rem; text-align: center; }
th { background: #f1f5f9; }
tr:nth-child(even) { background: #f9fafb; }
textarea { width: 100%; height: 60px; border: 1px solid #ccc; border-radius: 0.375rem; padding: 0.5rem; }
</style>
</head>

<body class="p-6">
  <h1 class="text-2xl font-bold text-gray-800 mb-4">📦 Apple 扫码登记平台</h1>
  <p class="text-gray-600 mb-6">支持：运单号登记 + 序列号/UPC登记 + SKU自动匹配 + 手动关联 + CSV导出</p>

  <!-- SKU 导入 -->
  <div class="card">
    <h2 class="text-xl font-semibold mb-3">🔗 SKU 映射表</h2>
    <button class="btn" onclick="document.getElementById('skuUpload').click()">上传 SKU 映射（CSV）</button>
    <input type="file" id="skuUpload" accept=".csv" style="display:none">
    <span id="skuStatus" class="ml-3 text-sm text-gray-600"></span>
  </div>

  <!-- 运单号登记 -->
  <div class="card">
    <h2 class="text-xl font-semibold mb-3">🚚 运单号登记</h2>
    <div class="flex gap-2 mb-3">
      <input type="text" id="mark" placeholder="标记编号 (例: A001)" class="w-1/4">
      <input type="text" id="tracking" placeholder="运单号 (FedEx/UPS)" class="flex-1">
      <button class="btn" onclick="addTracking()">登记运单号</button>
    </div>
    <table id="trackingTable">
      <thead><tr><th>标记编号</th><th>运单号</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 序列号/UPC 登记 -->
  <div class="card">
    <h2 class="text-xl font-semibold mb-3">📱 序列号 / UPC 登记</h2>
    <div class="flex gap-2 mb-3">
      <input type="text" id="refMark" placeholder="关联标记 (例: A001)" class="w-1/4">
      <input type="text" id="serial" placeholder="序列号" class="w-1/4">
      <input type="text" id="upc" placeholder="UPC" class="w-1/4">
      <input type="text" id="device" placeholder="Device" class="w-1/5 device">
      <input type="text" id="capacity" placeholder="Capacity" class="w-1/5 capacity">
      <input type="text" id="color" placeholder="Color" class="w-1/5 color">
      <button class="btn" onclick="addDevice()">登记设备</button>
    </div>
    <table id="deviceTable">
      <thead><tr><th>标记编号</th><th>序列号</th><th>UPC</th><th>Device</th><th>Capacity</th><th>Color</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 导出 -->
  <div class="card">
    <h2 class="text-xl font-semibold mb-3">💾 数据导出</h2>
    <button class="btn" onclick="exportCSV()">导出所有数据 (CSV)</button>
  </div>

<script>
let skuMap = {};
let trackingData = [];
let deviceData = [];

// 上传 SKU CSV
document.getElementById('skuUpload').addEventListener('change', e => {
  if (e.target.files.length > 0) loadSkuMap(e.target.files[0]);
});

function loadSkuMap(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const rows = e.target.result.split(/\r?\n/);
    rows.slice(1).forEach(row => {
      const [upc, device, capacity, color] = row.split(',');
      if (upc) skuMap[upc.trim()] = {device, capacity, color};
    });
    localStorage.setItem('skuMap', JSON.stringify(skuMap));
    document.getElementById('skuStatus').innerText = `✅ SKU 映射加载成功，共 ${Object.keys(skuMap).length} 条`;
  };
  reader.readAsText(file, 'utf-8');
}

// 加载缓存 SKU
window.addEventListener('load', () => {
  const cached = localStorage.getItem('skuMap');
  if (cached) {
    skuMap = JSON.parse(cached);
    document.getElementById('skuStatus').innerText = `✅ 已加载缓存映射 ${Object.keys(skuMap).length} 条`;
  }
});

// 自动匹配 UPC
document.getElementById('upc').addEventListener('input', e => {
  const upc = e.target.value.trim();
  const sku = skuMap[upc];
  if (sku) {
    document.getElementById('device').value = sku.device || '';
    document.getElementById('capacity').value = sku.capacity || '';
    document.getElementById('color').value = sku.color || '';
  }
});

// 添加运单号
function addTracking() {
  const mark = document.getElementById('mark').value.trim();
  let tracking = document.getElementById('tracking').value.trim();
  if (!mark || !tracking) return alert('请填写标记编号与运单号');
  if (tracking.startsWith('96') || tracking.length > 12) tracking = tracking.slice(-12); // FedEx 截取后12位
  trackingData.push({ mark, tracking });
  updateTrackingTable();
  document.getElementById('mark').value = '';
  document.getElementById('tracking').value = '';
}

function updateTrackingTable() {
  const tbody = document.querySelector('#trackingTable tbody');
  tbody.innerHTML = '';
  trackingData.forEach(item => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${item.mark}</td><td>${item.tracking}</td>`;
    tbody.appendChild(tr);
  });
}

// 添加设备
function addDevice() {
  const refMark = document.getElementById('refMark').value.trim();
  const serial = document.getElementById('serial').value.trim();
  const upc = document.getElementById('upc').value.trim();
  const device = document.getElementById('device').value.trim();
  const capacity = document.getElementById('capacity').value.trim();
  const color = document.getElementById('color').value.trim();
  if (!serial && !upc) return alert('请输入序列号或UPC');
  deviceData.push({ refMark, serial, upc, device, capacity, color });
  updateDeviceTable();
  document.getElementById('serial').value = '';
  document.getElementById('upc').value = '';
  document.getElementById('device').value = '';
  document.getElementById('capacity').value = '';
  document.getElementById('color').value = '';
}

// 更新设备表
function updateDeviceTable() {
  const tbody = document.querySelector('#deviceTable tbody');
  tbody.innerHTML = '';
  deviceData.forEach(item => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${item.refMark}</td><td>${item.serial}</td><td>${item.upc}</td><td>${item.device}</td><td>${item.capacity}</td><td>${item.color}</td>`;
    tbody.appendChild(tr);
  });
}

// 导出所有数据
function exportCSV() {
  let csv = '标记编号,运单号,序列号,UPC,Device,Capacity,Color\n';
  deviceData.forEach(dev => {
    const match = trackingData.find(t => t.mark === dev.refMark);
    csv += `${dev.refMark},${match ? match.tracking : ''},${dev.serial},${dev.upc},${dev.device},${dev.capacity},${dev.color}\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'scan_export.csv';
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
