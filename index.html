<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>工业扫码平台 · 单码枪 / FS40 / FS42 通用版</title>
<style>
:root {
  --bg:#0b0f14;--panel:#121821;--card:#0e141d;--accent:#27e6a7;
  --accent2:#00b3ff;--text:#e7eef7;--muted:#9db0c3;
  --bd:#1d2732;--warn:#ffb648;--bad:#ff6b6b;
}
body {margin:0;background:var(--bg);color:var(--text);
font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,"Noto Sans SC";}
h2{margin-top:0}
.container {max-width:1200px;margin:auto;padding:24px}
.card {background:var(--panel);padding:16px;border-radius:12px;margin-bottom:16px;
box-shadow:0 4px 20px rgba(0,0,0,.25)}
input,button {font-size:15px;padding:10px;border-radius:8px;border:1px solid var(--bd);
background:var(--card);color:var(--text);outline:none}
button {cursor:pointer;background:linear-gradient(90deg,var(--accent),var(--accent2));border:none}
button:hover {opacity:.9}
.table {width:100%;border-collapse:collapse;font-size:14px}
.table th,.table td {padding:8px;border-top:1px solid var(--bd)}
.table th {background:#0c121a;color:#9db0c3}
.detail td{background:#0a121a}
.muted{color:var(--muted)}
.flex{display:flex;gap:10px;flex-wrap:wrap}
input:focus{border-color:var(--accent)}
</style>
</head>
<body>
<div class="container">
  <h1>📦 工业扫码平台 <small style="color:var(--muted)">（单码枪 & FS40/FS42 兼容）</small></h1>

  <div class="card">
    <h2>🚚 运单登记</h2>
    <div class="flex">
      <input id="trkTag" placeholder="标记 (Tag) 如 A001" />
      <input id="tracking" placeholder="扫描或输入运单号" />
      <button id="addTracking">添加</button>
    </div>
    <small class="muted">FedEx 自动取后 12 位数字；UPS 以 1Z 开头原样保留。</small>
  </div>

  <div class="card">
    <h2>📱 设备登记</h2>
    <div class="flex">
      <input id="devTag" placeholder="标记 (Tag)" />
      <input id="serial" placeholder="序列号 Serial" />
      <input id="upc" placeholder="UPC（可自动匹配）" />
      <button id="addDevice">添加</button>
    </div>
    <div class="flex">
      <input id="device" placeholder="Device" />
      <input id="capacity" placeholder="Capacity" />
      <input id="color" placeholder="Color" />
    </div>
  </div>

  <div class="card">
    <h2>🧩 SKU 映射导入</h2>
    <input type="file" id="skuUpload" accept=".csv" />
    <p class="muted">格式：UPC,Device,Capacity,Color（导入后自动缓存）</p>
    <button id="exportAll">导出全部数据 CSV</button>
    <button style="background:var(--bad)" id="clearAll">清空数据</button>
  </div>

  <div class="card">
    <h2>📊 汇总总览</h2>
    <table class="table" id="summary"><thead>
      <tr><th>Tag</th><th>运单数量</th><th>设备数量</th><th>最近时间</th></tr>
    </thead><tbody></tbody></table>
  </div>
</div>

<script>
let trackingData = JSON.parse(localStorage.getItem('tracks')||'[]');
let deviceData = JSON.parse(localStorage.getItem('devices')||'[]');
let skuMap = JSON.parse(localStorage.getItem('skuMap')||'{}');

function now(){return new Date().toISOString();}
function fmt(t){return new Date(t).toLocaleString('zh-CN',{hour12:false});}
function save(){localStorage.setItem('tracks',JSON.stringify(trackingData));
                localStorage.setItem('devices',JSON.stringify(deviceData));}

/* --- FedEx/UPS 自动识别 --- */
function normalizeTracking(v){
  v=String(v).trim(); if(!v) return null;
  if(v.startsWith('1Z')) return {carrier:'UPS',number:v};
  let digits=v.replace(/\D+/g,''); if(digits.length>=12)
    return {carrier:'FedEx',number:digits.slice(-12)};
  return {carrier:'Other',number:v};
}

/* --- 添加运单 --- */
document.getElementById('addTracking').onclick=()=>{
  const tag=document.getElementById('trkTag').value.trim();
  const raw=document.getElementById('tracking').value.trim();
  if(!tag||!raw) return alert('请填写 Tag 与运单号');
  const t=normalizeTracking(raw);
  trackingData.push({tag,carrier:t.carrier,number:t.number,time:now()});
  save(); renderSummary(); document.getElementById('tracking').value='';
};

/* --- 添加设备 --- */
document.getElementById('addDevice').onclick=()=>{
  const tag=document.getElementById('devTag').value.trim();
  const serial=document.getElementById('serial').value.trim();
  const upc=document.getElementById('upc').value.trim();
  if(!tag||!serial) return alert('请填写 Tag 与 Serial');
  const info=skuMap[upc]; 
  deviceData.push({
    tag,serial,upc,
    device:info?.device||document.getElementById('device').value.trim(),
    capacity:info?.capacity||document.getElementById('capacity').value.trim(),
    color:info?.color||document.getElementById('color').value.trim(),
    time:now()
  });
  save(); renderSummary();
  ['serial','upc','device','capacity','color'].forEach(id=>document.getElementById(id).value='');
};

/* --- SKU 导入 --- */
document.getElementById('skuUpload').onchange=e=>{
  const file=e.target.files[0]; if(!file) return;
  const r=new FileReader();
  r.onload=ev=>{
    const rows=ev.target.result.split(/\r?\n/);
    skuMap={};
    rows.slice(1).forEach(line=>{
      const [u,d,c,col]=line.split(',');
      if(u) skuMap[u.trim()]={device:d,capacity:c,color:col};
    });
    localStorage.setItem('skuMap',JSON.stringify(skuMap));
    alert('SKU 映射已导入：'+Object.keys(skuMap).length+' 条');
  };
  r.readAsText(file);
};

/* --- 导出/清空 --- */
document.getElementById('exportAll').onclick=()=>{
  let csv='type,tag,time,carrier/serial,number/upc,device,capacity,color\n';
  trackingData.forEach(t=>{
    csv+=`tracking,${t.tag},${fmt(t.time)},${t.carrier},${t.number},,,\n`;
  });
  deviceData.forEach(d=>{
    csv+=`device,${d.tag},${fmt(d.time)},${d.serial},${d.upc},${d.device},${d.capacity},${d.color}\n`;
  });
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download='scan_export.csv';a.click();
};
document.getElementById('clearAll').onclick=()=>{
  if(confirm('确定清空所有数据？')){
    trackingData=[];deviceData=[];save();renderSummary();
  }
};

/* --- 汇总 --- */
function renderSummary(){
  const tb=document.querySelector('#summary tbody');tb.innerHTML='';
  const tags=[...new Set([...trackingData.map(x=>x.tag),...deviceData.map(x=>x.tag)])];
  tags.forEach(tag=>{
    const trk=trackingData.filter(x=>x.tag===tag);
    const dev=deviceData.filter(x=>x.tag===tag);
    const all=[...trk,...dev].sort((a,b)=>a.time.localeCompare(b.time));
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${tag}</td>
      <td>${trk.length}</td><td>${dev.length}</td>
      <td class="muted">${all.length?fmt(all.slice(-1)[0].time):'-'}</td>`;
    tb.appendChild(tr);
  });
}
renderSummary();

/* --- 兼容扫描枪：自动聚焦输入框 --- */
document.addEventListener('keydown',()=>{
  const trk=document.getElementById('tracking');
  if(document.activeElement!==trk && !trk.value) trk.focus();
});
</script>
</body>
</html>
