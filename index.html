<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>扫码平台 v1.6 · 运单/设备/汇总 · 暗色</title>
<style>
:root{
  --bg:#0b0f14;--panel:#121822;--card:#0f1520;--muted:#98a2b3;--text:#e8eef6;--accent:#4cc9f0;--accent2:#7c5cff;--good:#16a34a;--warn:#f59e0b;--bad:#ef4444;--line:#1f2937;
  --chip:#1b2331; --chip-b:#2b364a; --btn:#1a2232; --btn-b:#2a3448;
}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0a0e14 0%,#0b111a 100%);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif}
.wrap{max-width:1220px;margin:0 auto;padding:24px}
.title{display:flex;gap:12px;align-items:center;margin-bottom:14px}
.logo{width:14px;height:14px;border-radius:4px;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 0 0 2px #111 inset}
h1{font-size:18px;margin:0;font-weight:700}
.tabbar{display:flex;gap:8px;margin:8px 0 16px}
.tab{cursor:pointer;padding:9px 12px;border-radius:10px;background:var(--btn);border:1px solid var(--btn-b);opacity:.88}
.tab.active{background:linear-gradient(180deg,#151d2b,#0f1623);border-color:#2a3a55;opacity:1;box-shadow:0 0 0 1px #2a3a55 inset}
.panel{background:linear-gradient(180deg,#0c1220,#0a111c);border:1px solid #1e2a3f;border-radius:14px;margin-bottom:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #1f2a40}
.head h2{font-size:14px;margin:0;color:#cdd6e5}
.form{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;padding:14px}
.form .full{grid-column:1/-1}
input,select,button{height:38px;padding:0 10px;border-radius:10px;border:1px solid #2a3448;background:#0e1522;color:var(--text);outline:none}
input::placeholder{color:#6b7280}
button{cursor:pointer;background:linear-gradient(180deg,#1a2232,#121a28);border-color:#2a3448}
.primary{background:linear-gradient(180deg,#1d2a40,#132135);border-color:#2f405e}
.accent{background:linear-gradient(180deg,#214155,#163042);border-color:#2e5a76;color:#dbeafe}
.good{background:linear-gradient(180deg,#12361f,#0f2a19);border-color:#1d4d2b}
.bad{background:linear-gradient(180deg,#3a1212,#2a0f0f);border-color:#5a1f1f}
.btn-sm{height:30px;padding:0 10px;border-radius:8px;font-size:12px}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.k{color:#7aa2f7}
.muted{color:var(--muted)}
.row{display:flex;gap:8px;align-items:center}
.right{margin-left:auto}
table{width:100%;border-collapse:separate;border-spacing:0 8px;padding:0 14px 14px}
thead th{font-size:12px;font-weight:600;color:#9fb0c7;text-align:left;padding:0 8px}
tbody tr{background:linear-gradient(180deg,#0c1320,#0b101a);border:1px solid #1e2a40}
tbody td{padding:10px 8px;border-top:1px solid #1e2a40;border-bottom:1px solid #1e2a40}
tbody tr{border-radius:12px;overflow:hidden}
.chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--chip-b);padding:4px 8px;border-radius:999px;font-size:12px}
.warn{color:#fff;background:#3a1a0a;border-color:#5a2a12}
.err{color:#fff;background:#3a0f0f;border-color:#5a1f1f}
.ok{background:#14281a;border-color:#1f5033}
.pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2a3a55;background:#121a2b;color:#c6d6f0}
.exp-row{background:#0d1526;border-left:3px solid #2e4a7a}
.stat{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:12px 14px;border-top:1px dashed #23334d;background:linear-gradient(180deg,#0b111c,#0a0f18)}
.card{background:linear-gradient(180deg,#0d1320,#0b111a);border:1px solid #1e2940;border-radius:12px;padding:12px}
.card .v{font-size:20px;font-weight:700}
.hidden{display:none}
.footer{margin-top:6px;color:#8b9ab3;text-align:center;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <div class="logo"></div><h1>扫码平台 · v1.6</h1>
    <span class="pill">运单 + 设备 + SKU 映射 + 汇总留档</span>
    <span class="right muted">暗色科技风</span>
  </div>

  <div class="tabbar">
    <div class="tab active" data-tab="tracking">运单登记</div>
    <div class="tab" data-tab="device">设备登记</div>
    <div class="tab" data-tab="summary">汇总/明细</div>
    <div class="tab" data-tab="report">统计留档</div>
    <div class="tab" data-tab="sku">SKU 映射</div>
    <div class="tab" data-tab="settings">设置</div>
  </div>

  <!-- 运单 -->
  <section id="panel-tracking" class="panel">
    <div class="head">
      <h2>运单登记（FedEx 截取后12位 / UPS 保留完整）</h2>
      <div class="row">
        <button class="btn-sm" id="btnExportTracking">导出CSV</button>
        <button class="btn-sm bad" id="btnClearTracking">清空运单</button>
      </div>
    </div>
    <div class="form">
      <input id="t_tag" placeholder="标记（如 U3 / A001）" />
      <input id="t_input" placeholder="扫描运单号（FedEx/UPS）" />
      <select id="t_type"><option value="auto">自动识别</option><option value="FedEx">FedEx</option><option value="UPS">UPS</option></select>
      <input id="t_note" placeholder="备注（可选）" />
      <button id="btnAddTracking" class="primary">登记运单</button>
      <div class="row"><input id="t_auto" type="checkbox" checked/><label for="t_auto">扫描后自动提交</label></div>
      <div class="full muted">同一标记（如 U3）的运单与设备将**自动关联为一组**，无需逐条绑定。</div>
    </div>
    <div class="stat">
      <div class="card"><div class="muted">运单总数</div><div class="v" id="tCount">0</div></div>
      <div class="card"><div class="muted">FedEx</div><div class="v" id="tFedex">0</div></div>
      <div class="card"><div class="muted">UPS</div><div class="v" id="tUps">0</div></div>
      <div class="card"><div class="muted">标记种类</div><div class="v" id="tTags">0</div></div>
    </div>
    <table>
      <thead><tr><th>标记</th><th>运单号</th><th>类型</th><th>时间</th><th>备注</th><th>操作</th></tr></thead>
      <tbody id="tBody"></tbody>
    </table>
  </section>

  <!-- 设备 -->
  <section id="panel-device" class="panel hidden">
    <div class="head">
      <h2>设备登记（序列号 / UPC）</h2>
      <div class="row">
        <button class="btn-sm" id="btnExportDevice">导出CSV</button>
        <button class="btn-sm bad" id="btnClearDevice">清空设备</button>
      </div>
    </div>
    <div class="form">
      <input id="d_tag" placeholder="标记（如 U3 / A001）" />
      <input id="d_serial" placeholder="序列号（Serial）" />
      <input id="d_upc" placeholder="UPC（自动匹配型号/容量/颜色）" />
      <input id="d_device" placeholder="Device" />
      <input id="d_capacity" placeholder="Capacity" />
      <input id="d_color" placeholder="Color" />
      <div class="row"><input id="dupWarn" type="checkbox" checked/><label for="dupWarn">重复提示音</label></div>
      <button id="btnAddDevice" class="primary">登记设备</button>
      <div class="row"><input id="d_auto" type="checkbox" checked/><label for="d_auto">扫描后自动提交（Enter）</label></div>
      <div class="full muted">序列号重复 > 红字高亮 + 蜂鸣；UPC 命中 SKU 映射 > 自动填充型号/容量/颜色。</div>
    </div>
    <div class="stat">
      <div class="card"><div class="muted">设备总数</div><div class="v" id="dCount">0</div></div>
      <div class="card"><div class="muted">唯一序列号</div><div class="v" id="dUnique">0</div></div>
      <div class="card"><div class="muted">标记种类</div><div class="v" id="dTags">0</div></div>
      <div class="card"><div class="muted">最近登记</div><div class="v" id="dLast">-</div></div>
    </div>
    <table>
      <thead><tr><th>标记</th><th>序列号</th><th>UPC</th><th>Device</th><th>Capacity</th><th>Color</th><th>时间</th><th>状态</th><th>操作</th></tr></thead>
      <tbody id="dBody"></tbody>
    </table>
  </section>

  <!-- 汇总/明细 -->
  <section id="panel-summary" class="panel hidden">
    <div class="head">
      <h2>汇总 / 明细（按标记聚合，点击展开）</h2>
      <div class="row">
        <button id="btnExpandAll" class="btn-sm">全部展开</button>
        <button id="btnCollapseAll" class="btn-sm">全部收起</button>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;padding-bottom:8px">
      <div>
        <div class="row" style="padding:10px 14px"><span class="chip">运单汇总</span><span class="muted">（按标记）</span></div>
        <table>
          <thead><tr><th>标记</th><th>运单数量</th><th>最近时间</th><th>操作</th></tr></thead>
          <tbody id="sumT"></tbody>
        </table>
      </div>
      <div>
        <div class="row" style="padding:10px 14px"><span class="chip">设备汇总</span><span class="muted">（按标记）</span></div>
        <table>
          <thead><tr><th>标记</th><th>设备数量</th><th>最近时间</th><th>操作</th></tr></thead>
          <tbody id="sumD"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 统计留档（日报样式） -->
  <section id="panel-report" class="panel hidden">
    <div class="head">
      <h2>统计留档（按 日期 + Device + Capacity + Color + 标记 聚合）</h2>
      <div class="row">
        <input id="reportDate" type="date" />
        <button class="btn-sm" id="btnMakeReport">生成统计</button>
        <button class="btn-sm" id="btnExportReport">导出CSV</button>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Date</th><th>Device</th><th>Capacity</th><th>Color</th><th>Qty</th><th>Customer(标记)</th>
        </tr>
      </thead>
      <tbody id="reportBody"></tbody>
    </table>
    <div class="row" style="padding:0 14px 14px"><span class="muted">说明：同一“标记”代表一组，系统自动把该标记下的所有设备汇总成行。</span></div>
  </section>

  <!-- SKU -->
  <section id="panel-sku" class="panel hidden">
    <div class="head">
      <h2>SKU 映射（UPC → Device/Capacity/Color）</h2>
      <div class="row">
        <label class="btn-sm accent" for="skuFile">上传 CSV</label>
        <input id="skuFile" type="file" accept=".csv" class="hidden" />
        <button id="btnPickSku" class="btn-sm">选择本地 SKU 文件（记住此文件）</button>
        <button id="btnReloadSku" class="btn-sm">从已记住的文件刷新</button>
        <button id="btnExportSkuCache" class="btn-sm">导出本地 SKU JSON</button>
      </div>
    </div>
    <div class="form">
      <div class="full">
        <span class="chip" id="skuStatus">尚未加载映射</span>
        <span class="muted">建议：把 Google Drive 里的 <b>sku_map.csv</b> 下载到电脑固定位置；用“选择本地 SKU 文件”绑定一次，以后点“刷新”即可。</span>
      </div>
    </div>
    <table>
      <thead><tr><th>示例（前 10 条）</th></tr></thead>
      <tbody id="skuPreview"></tbody>
    </table>
  </section>

  <!-- 设置 -->
  <section id="panel-settings" class="panel hidden">
    <div class="head"><h2>设置</h2></div>
    <div class="form">
      <div class="row"><input id="setFedexTail" type="checkbox" checked/><label for="setFedexTail">FedEx 仅保留后 12 位</label></div>
      <div class="row"><input id="setSound" type="checkbox" checked/><label for="setSound">启用提示音</label></div>
      <div class="row"><input id="setConfirmDelete" type="checkbox" checked/><label for="setConfirmDelete">删除前确认</label></div>
      <div class="full muted">数据与设置存储在浏览器（localStorage）。</div>
    </div>
  </section>

  <div class="footer">© 扫码平台 v1.6 — 单码扫描枪 & Zebra FS40/FS42（键盘输出）即插即用；支持 SKU 本地文件记忆与一键刷新。</div>
</div>

<script>
/*** ========= 基础存储 ========= ***/
const store = {
  load(){
    const d = JSON.parse(localStorage.getItem('SCAN_PLATFORM_V16')||'{}');
    return Object.assign({
      settings:{ fedexTail12:true, sound:true, confirmDelete:true },
      tracking:[], // {id, tag, tracking, type, note, created_at}
      device:[],   // {id, tag, serial, upc, device, capacity, color, status, created_at}
      skuMap:{},   // upc -> {device,capacity,color}
      skuHandle:null // FileSystemHandle (serialize key)
    }, d);
  },
  save(data){ localStorage.setItem('SCAN_PLATFORM_V16', JSON.stringify(data)); }
};
let DB = store.load();

/*** ========= 工具 ========= ***/
const $ = s=>document.querySelector(s);
const el=(t,a={},h='')=>{const n=document.createElement(t);for(const k in a){k==='class'?n.className=a[k]:n.setAttribute(k,a[k])} if(h) n.innerHTML=h; return n;}
const now = ()=> new Date().toLocaleString('zh-CN',{hour12:false});
const todayStr = ()=> new Date().toISOString().slice(0,10);
const URL_OK='data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAABkAAAA';
const URL_WARN=URL_OK, URL_ERR=URL_OK;
const beep = (type)=>{ if(!DB.settings.sound) return; const a=new Audio(); a.src=(type==='err')?URL_ERR:(type==='warn')?URL_WARN:URL_OK; a.volume=.5; a.play(); };

/*** ========= Tab ========= ***/
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const name=t.dataset.tab;
    ['tracking','device','summary','report','sku','settings'].forEach(id=>{
      $('#panel-'+id).classList.toggle('hidden', id!==name);
    });
  };
});

/*** ========= 运单 ========= ***/
function normalizeTracking(raw, forceType){
  let s=(raw||'').trim().toUpperCase().replace(/\s+/g,'');
  let type='Unknown';
  if(forceType && forceType!=='auto') type=forceType;
  if(!forceType || forceType==='auto'){
    if(/^1Z[0-9A-Z]{16}$/.test(s)) type='UPS';
    else if(/^\d{12,22}$/.test(s)) type='FedEx';
  }
  if(type==='FedEx' && DB.settings.fedexTail12 && /^\d+$/.test(s) && s.length>12) s=s.slice(-12);
  return {tracking:s, type};
}
const tTag=$('#t_tag'), tInput=$('#t_input'), tType=$('#t_type'), tNote=$('#t_note'), tAuto=$('#t_auto');
$('#btnAddTracking').onclick=addTracking;
$('#btnClearTracking').onclick=()=>{ if(!DB.settings.confirmDelete||confirm('清空所有运单？')){ DB.tracking=[]; store.save(DB); renderTracking(); renderSummary(); }};
$('#btnExportTracking').onclick=()=> exportCSV('tracking');
tInput.addEventListener('keydown',e=>{ if(e.key==='Enter' || (tAuto.checked && e.key==='Enter')) addTracking(); });
function addTracking(){
  const tag=tTag.value.trim(); const raw=tInput.value.trim();
  if(!raw){ tInput.focus(); return; }
  const {tracking,type}=normalizeTracking(raw,tType.value);
  DB.tracking.push({ id:Date.now()+Math.random(), tag, tracking, type, note:tNote.value.trim(), created_at:now() });
  tInput.value=''; tNote.value=''; beep('ok'); store.save(DB);
  renderTracking(); renderSummary();
}
function renderTracking(){
  $('#tCount').textContent=DB.tracking.length;
  $('#tFedex').textContent=DB.tracking.filter(x=>x.type==='FedEx').length;
  $('#tUps').textContent=DB.tracking.filter(x=>x.type==='UPS').length;
  $('#tTags').textContent=new Set(DB.tracking.map(x=>x.tag||'')).size;
  const body=$('#tBody'); body.innerHTML='';
  DB.tracking.slice().reverse().forEach(r=>{
    const tr=el('tr');
    tr.appendChild(el('td',{},`<span class="chip mono">${r.tag||'-'}</span>`));
    tr.appendChild(el('td',{},`<span class="mono">${r.tracking}</span>`));
    tr.appendChild(el('td',{},r.type));
    tr.appendChild(el('td',{},r.created_at));
    tr.appendChild(el('td',{},r.note||'' ));
    const ops=el('td'); const del=el('button',{class:'btn-sm bad'},'删除');
    del.onclick=()=>{ if(!DB.settings.confirmDelete||confirm('删除该运单？')){ DB.tracking=DB.tracking.filter(x=>x.id!==r.id); store.save(DB); renderTracking(); renderSummary(); } };
    ops.appendChild(del); tr.appendChild(ops); body.appendChild(tr);
  });
}

/*** ========= 设备 ========= ***/
const dTag=$('#d_tag'), dSerial=$('#d_serial'), dUPC=$('#d_upc'),
      dDev=$('#d_device'), dCap=$('#d_capacity'), dCol=$('#d_color'), dAuto=$('#d_auto');
$('#btnAddDevice').onclick=addDevice;
$('#btnClearDevice').onclick=()=>{ if(!DB.settings.confirmDelete||confirm('清空所有设备？')){ DB.device=[]; store.save(DB); renderDevice(); renderSummary(); }};
$('#btnExportDevice').onclick=()=> exportCSV('device');

dUPC.addEventListener('input', ()=>{
  const upc=dUPC.value.trim();
  if(DB.skuMap && DB.skuMap[upc]){
    const s=DB.skuMap[upc];
    dDev.value=s.device||''; dCap.value=s.capacity||''; dCol.value=s.color||'';
  }
});

[dSerial,dUPC].forEach(inp=>{
  inp.addEventListener('keydown',e=>{
    if(e.key==='Enter' && dAuto.checked) addDevice();
  });
});

function addDevice(){
  const tag=dTag.value.trim();
  const serial=(dSerial.value||'').trim().toUpperCase();
  const upc=(dUPC.value||'').trim();
  const device=dDev.value.trim(), capacity=dCap.value.trim(), color=dCol.value.trim();
  if(!serial && !upc){ dSerial.focus(); return; }
  // 重复序列号检测
  if(serial){
    const cnt=DB.device.filter(x=>x.serial===serial).length;
    if(cnt>0){ beep('warn'); }
  }
  DB.device.push({ id:Date.now()+Math.random(), tag, serial, upc, device, capacity, color, status:'OK', created_at:now() });
  dSerial.value=''; dUPC.value=''; dDev.value=''; dCap.value=''; dCol.value=''; beep('ok'); store.save(DB);
  renderDevice(); renderSummary();
}

function renderDevice(){
  const body=$('#dBody'); body.innerHTML='';
  const uniq=new Set(DB.device.map(x=>x.serial).filter(Boolean));
  $('#dCount').textContent=DB.device.length;
  $('#dUnique').textContent=uniq.size;
  $('#dTags').textContent=new Set(DB.device.map(x=>x.tag||'')).size;
  $('#dLast').textContent=DB.device.length? DB.device[DB.device.length-1].created_at : '-';

  DB.device.slice().reverse().forEach(r=>{
    const tr=el('tr');
    tr.appendChild(el('td',{},`<span class="chip mono">${r.tag||'-'}</span>`));
    const s=el('td'); s.innerHTML=r.serial?`<span class="mono">${r.serial}</span>`:'-';
    if(r.serial && DB.device.filter(x=>x.serial===r.serial).length>1){ s.classList.add('err'); s.style.fontWeight='700'; }
    tr.appendChild(s);
    tr.appendChild(el('td',{}, r.upc?`<span class="mono">${r.upc}</span>`:'-'));
    tr.appendChild(el('td',{}, r.device||'' ));
    tr.appendChild(el('td',{}, r.capacity||'' ));
    tr.appendChild(el('td',{}, r.color||'' ));
    tr.appendChild(el('td',{}, r.created_at ));
    tr.appendChild(el('td',{}, r.status ));
    const ops=el('td'); const del=el('button',{class:'btn-sm bad'},'删除');
    del.onclick=()=>{ if(!DB.settings.confirmDelete||confirm('删除该设备？')){ DB.device=DB.device.filter(x=>x.id!==r.id); store.save(DB); renderDevice(); renderSummary(); } };
    ops.appendChild(del); tr.appendChild(ops); body.appendChild(tr);
  });
}

/*** ========= 汇总（按标记） ========= ***/
function groupBy(list, keyfn){
  const map=new Map(); list.forEach(r=>{ const k=keyfn(r); if(!map.has(k)) map.set(k,[]); map.get(k).push(r); }); return map;
}
function renderSummary(){
  // 运单
  const sumT=$('#sumT'); sumT.innerHTML='';
  const gT=groupBy(DB.tracking, r=>r.tag||'');
  [...gT.entries()].sort((a,b)=>a[0].localeCompare(b[0])).forEach(([tag,arr])=>{
    const tr=el('tr');
    tr.appendChild(el('td',{},`<span class="chip mono">${tag||'-'}</span>`));
    tr.appendChild(el('td',{}, String(arr.length)));
    tr.appendChild(el('td',{}, arr[arr.length-1]?.created_at || '-'));
    const op=el('td');
    const btn=el('button',{class:'btn-sm'},'▶ 展开');
    let open=false, rows=[];
    btn.onclick=()=>{ open=!open; btn.textContent=open?'▼ 收起':'▶ 展开';
      if(open){
        arr.forEach(r=>{
          const dr=el('tr',{class:'exp-row'});
          dr.appendChild(el('td',{},'')); 
          dr.appendChild(el('td',{}, `<span class="mono">${r.type}</span> · <span class="mono">${r.tracking}</span>`));
          dr.appendChild(el('td',{}, r.created_at));
          const d=el('td'); const del=el('button',{class:'btn-sm bad'},'删除');
          del.onclick=()=>{ if(!DB.settings.confirmDelete||confirm('删除该运单？')){ DB.tracking=DB.tracking.filter(x=>x.id!==r.id); store.save(DB); renderTracking(); renderSummary(); } };
          d.appendChild(del); dr.appendChild(d); tr.parentNode.insertBefore(dr,tr.nextSibling); rows.push(dr);
        });
      }else{ rows.forEach(n=>n.remove()); rows=[]; }
    };
    const ex=el('button',{class:'btn-sm right'},'导出此标记'); ex.onclick=()=> exportCSVTag('tracking', tag);
    op.appendChild(btn); op.appendChild(ex); tr.appendChild(op); sumT.appendChild(tr);
  });

  // 设备
  const sumD=$('#sumD'); sumD.innerHTML='';
  const gD=groupBy(DB.device, r=>r.tag||'');
  [...gD.entries()].sort((a,b)=>a[0].localeCompare(b[0])).forEach(([tag,arr])=>{
    const tr=el('tr');
    tr.appendChild(el('td',{},`<span class="chip mono">${tag||'-'}</span>`));
    tr.appendChild(el('td',{}, String(arr.length)));
    tr.appendChild(el('td',{}, arr[arr.length-1]?.created_at || '-'));
    const op=el('td');
    const btn=el('button',{class:'btn-sm'},'▶ 展开');
    let open=false, rows=[];
    btn.onclick=()=>{ open=!open; btn.textContent=open?'▼ 收起':'▶ 展开';
      if(open){
        arr.forEach(r=>{
          const dr=el('tr',{class:'exp-row'});
          dr.appendChild(el('td',{},'')); 
          dr.appendChild(el('td',{}, `SN <span class="mono">${r.serial||'-'}</span> · UPC <span class="mono">${r.upc||'-'}</span>`));
          dr.appendChild(el('td',{}, r.created_at));
          const d=el('td'); const del=el('button',{class:'btn-sm bad'},'删除');
          del.onclick=()=>{ if(!DB.settings.confirmDelete||confirm('删除该设备？')){ DB.device=DB.device.filter(x=>x.id!==r.id); store.save(DB); renderDevice(); renderSummary(); } };
          d.appendChild(del); dr.appendChild(d); tr.parentNode.insertBefore(dr,tr.nextSibling); rows.push(dr);
        });
      }else{ rows.forEach(n=>n.remove()); rows=[]; }
    };
    const ex=el('button',{class:'btn-sm right'},'导出此标记'); ex.onclick=()=> exportCSVTag('device', tag);
    op.appendChild(btn); op.appendChild(ex); tr.appendChild(op); sumD.appendChild(tr);
  });
}
$('#btnExpandAll').onclick=()=>{ document.querySelectorAll('#sumT .btn-sm, #sumD .btn-sm').forEach(b=>{ if(b.textContent==='▶ 展开') b.click(); }); };
$('#btnCollapseAll').onclick=()=>{ document.querySelectorAll('#sumT .btn-sm, #sumD .btn-sm').forEach(b=>{ if(b.textContent==='▼ 收起') b.click(); }); };

/*** ========= 统计留档（日报） ========= ***/
function buildReportRows(dateStr){
  // 取当天的设备（根据 created_at 日期）
  const day = (r)=> (r.created_at || '').slice(0,10) === dateStr;
  const rows = DB.device.filter(day);
  // key: device|capacity|color|tag
  const map = new Map();
  rows.forEach(r=>{
    const k=[r.device||'', r.capacity||'', r.color||'', r.tag||''].join('|');
    map.set(k,(map.get(k)||0)+1);
  });
  // 输出
  const result=[];
  map.forEach((qty,k)=>{
    const [device,capacity,color,tag]=k.split('|');
    result.push({date:dateStr, device, capacity, color, qty, customer:tag});
  });
  return result.sort((a,b)=> (a.device+a.capacity+a.color+a.customer).localeCompare(b.device+b.capacity+b.color+b.customer));
}
function renderReport(){
  const d=$('#reportDate').value || todayStr();
  const data=buildReportRows(d);
  const body=$('#reportBody'); body.innerHTML='';
  data.forEach(r=>{
    const tr=el('tr');
    tr.appendChild(el('td',{},r.date));
    tr.appendChild(el('td',{},r.device||'' ));
    tr.appendChild(el('td',{},r.capacity||'' ));
    tr.appendChild(el('td',{},r.color||'' ));
    tr.appendChild(el('td',{},String(r.qty)));
    tr.appendChild(el('td',{},r.customer||'' ));
    body.appendChild(tr);
  });
}
$('#btnMakeReport').onclick=renderReport;
$('#btnExportReport').onclick=()=>{
  const d=$('#reportDate').value || todayStr();
  const data=buildReportRows(d);
  const rows=[['Date','Device','Capacity','Color','Qty','Customer']].concat(
    data.map(r=>[r.date,r.device,r.capacity,r.color,r.qty,r.customer])
  );
  downloadCSV(rows,'daily_report_'+d+'.csv');
};

/*** ========= CSV 导入/导出 ========= ***/
function toCSV(rows){ return rows.map(r=> r.map(v=>{const s=v==null?'':String(v);return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s;}).join(',')).join('\n'); }
function downloadCSV(rows, name){
  const blob=new Blob(["\ufeff"+toCSV(rows)],{type:'text/csv;charset=utf-8;'});
  const a=el('a',{download:name}); a.href=URL.createObjectURL(blob); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
}
function exportCSV(kind){
  let rows=[], name='';
  if(kind==='tracking'){
    rows=[['tag','tracking','type','note','created_at']].concat(DB.tracking.map(r=>[r.tag||'',r.tracking,r.type,r.note||'',r.created_at]));
    name='tracking_'+Date.now()+'.csv';
  }else{
    rows=[['tag','serial','upc','device','capacity','color','status','created_at']]
      .concat(DB.device.map(r=>[r.tag||'',r.serial||'',r.upc||'',r.device||'',r.capacity||'',r.color||'',r.status||'',r.created_at]));
    name='device_'+Date.now()+'.csv';
  }
  downloadCSV(rows,name);
}
function exportCSVTag(kind, tag){
  let rows=[], name='';
  if(kind==='tracking'){
    const arr=DB.tracking.filter(r=>(r.tag||'')===tag);
    rows=[['tag','tracking','type','note','created_at']].concat(arr.map(r=>[r.tag||'',r.tracking,r.type,r.note||'',r.created_at]));
    name='tracking_'+(tag||'blank')+'_'+Date.now()+'.csv';
  }else{
    const arr=DB.device.filter(r=>(r.tag||'')===tag);
    rows=[['tag','serial','upc','device','capacity','color','status','created_at']]
      .concat(arr.map(r=>[r.tag||'',r.serial||'',r.upc||'',r.device||'',r.capacity||'',r.color||'',r.status||'',r.created_at]));
    name='device_'+(tag||'blank')+'_'+Date.now()+'.csv';
  }
  downloadCSV(rows,name);
}

/*** ========= SKU 映射 ========= ***/
// 1) 直接上传 CSV
$('#skuFile').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  loadSkuFromFile(f);
  e.target.value='';
});
// 2) 选择本地文件（记住此文件；需要支持 File System Access API 的浏览器）
$('#btnPickSku').onclick=async()=>{
  try{
    const [handle]=await window.showOpenFilePicker({types:[{description:'CSV',accept:{'text/csv':['.csv']}}]});
    DB.skuHandle=await handleToStorable(handle);
    store.save(DB);
    const file=await handle.getFile();
    await loadSkuFromFile(file,true);
  }catch(e){/* 取消 */ }
};
$('#btnReloadSku').onclick=async()=>{
  if(!DB.skuHandle){ alert('未记住任何 SKU 文件，请先“选择本地 SKU 文件”'); return; }
  try{
    const handle=await storableToHandle(DB.skuHandle);
    const file=await handle.getFile();
    await loadSkuFromFile(file,true);
  }catch(e){ alert('无法访问已记住的文件，请重新选择。'); }
};
$('#btnExportSkuCache').onclick=()=>{
  const data=Object.entries(DB.skuMap).slice(0,50000); // 防止超大
  const blob=new Blob([JSON.stringify(Object.fromEntries(data),null,2)],{type:'application/json'});
  const a=el('a',{download:'sku_cache.json'}); a.href=URL.createObjectURL(blob); a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
};

async function loadSkuFromFile(file,remember=false){
  const text=await file.text();
  const rows=text.split(/\r?\n/).filter(x=>x.trim().length);
  const map={};
  // 兼容带表头：UPC,Device,Capacity,Color
  const start = rows[0].toLowerCase().includes('upc')?1:0;
  for(let i=start;i<rows.length;i++){
    const cols = rows[i].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s=>s.replace(/^"|"$/g,'').replace(/""/g,'"'));
    const [upc,device,capacity,color]=cols;
    if(upc) map[String(upc).trim()]={device,capacity,color};
  }
  DB.skuMap=map; store.save(DB);
  $('#skuStatus').innerHTML=`<span class="chip ok">✅ 已加载 SKU：${Object.keys(map).length} 条</span>`;
  renderSkuPreview();
}
function renderSkuPreview(){
  const body=$('#skuPreview'); body.innerHTML='';
  const keys=Object.keys(DB.skuMap).slice(0,10);
  const box=el('tr'); const td=el('td');
  td.innerHTML = keys.length? keys.map(k=>`<div class="chip mono">${k}</div> → ${DB.skuMap[k].device||''} / ${DB.skuMap[k].capacity||''} / ${DB.skuMap[k].color||''}`).join('<br/>') : '<span class="muted">无数据</span>';
  box.appendChild(td); body.appendChild(box);
}
// File System Access 句柄序列化（简化）
async function handleToStorable(handle){ return {name:handle.name, kind:handle.kind, handle}; }
async function storableToHandle(st){ return st.handle; }

/*** ========= 设置 ========= ***/
const setFedexTail=$('#setFedexTail'), setSound=$('#setSound'), setConfirm=$('#setConfirmDelete');
setFedexTail.checked=!!DB.settings.fedexTail12;
setSound.checked=!!DB.settings.sound;
setConfirm.checked=!!DB.settings.confirmDelete;
setFedexTail.onchange=()=>{ DB.settings.fedexTail12=setFedexTail.checked; store.save(DB); };
setSound.onchange=()=>{ DB.settings.sound=setSound.checked; store.save(DB); };
setConfirm.onchange=()=>{ DB.settings.confirmDelete=setConfirm.checked; store.save(DB); };

/*** ========= 初始化 ========= ***/
$('#reportDate').value=todayStr();
renderTracking(); renderDevice(); renderSummary(); renderReport(); renderSkuPreview();
</script>
</body>
</html>
