<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>æ‰«ç å¹³å° v1.4 Â· è¿å•/è®¾å¤‡/SKU/å…³è”</title>
<style>
:root{
  --bg:#0b0f14;--panel:#121822;--card:#0f1520;--muted:#9aa4b2;--text:#e8eef6;--accent:#4cc9f0;--accent2:#7c5cff;
  --good:#16a34a;--warn:#f59e0b;--bad:#ef4444;--line:#1f2937;--chip:#1b2331;--chip-b:#2b364a;--btn:#1a2232;--btn-b:#2a3448;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0a0e14 0%,#0b111a 100%);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;}
.wrap{max-width:1240px;margin:0 auto;padding:20px}
.title{display:flex;gap:12px;align-items:center;margin-bottom:12px}
.logo{width:14px;height:14px;border-radius:4px;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 0 0 2px #111 inset}
h1{font-size:18px;margin:0 6px 0 0}
.pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2a3a55;background:#121a2b;color:#c6d6f0}
.right{margin-left:auto}
.toolbar{display:flex;gap:8px;align-items:center}
button,input,select{height:38px;padding:0 10px;border-radius:10px;border:1px solid #2a3448;background:#0e1522;color:var(--text);outline:none}
button{cursor:pointer;background:linear-gradient(180deg,#1a2232,#121a28)}
.btn{border-color:#2a3448}
.btn.primary{background:linear-gradient(180deg,#1d2a40,#132135);border-color:#2f405e}
.btn.accent{background:linear-gradient(180deg,#214155,#163042);border-color:#2e5a76;color:#dbeafe}
.btn.good{background:linear-gradient(180deg,#12361f,#0f2a19);border-color:#1d4d2b}
.btn.bad{background:linear-gradient(180deg,#3a1212,#2a0f0f);border-color:#5a1f1f}
.btn.sm{height:30px;padding:0 10px;border-radius:8px;font-size:12px}
.tabs{display:flex;gap:8px;margin:8px 0 16px}
.tab{padding:10px 14px;border-radius:10px;background:var(--btn);border:1px solid var(--btn-b);opacity:.85;cursor:pointer}
.tab.active{background:linear-gradient(180deg,#151d2b,#0f1623);border-color:#2a3a55;opacity:1;box-shadow:0 0 0 1px #2a3a55 inset}
.panel{background:linear-gradient(180deg,#0c1220,#0a111c);border:1px solid #1e2a3f;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);margin-bottom:14px}
.head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #1f2a40}
.head h2{font-size:14px;margin:0;color:#cdd6e5}
.form{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;padding:14px}
.form .full{grid-column:1/-1}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.stat{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;padding:12px 14px;border-top:1px dashed #23334d;background:linear-gradient(180deg,#0b111c,#0a0f18)}
.card{background:linear-gradient(180deg,#0d1320,#0b111a);border:1px solid #1e2940;border-radius:12px;padding:10px}
.card .v{font-size:20px;font-weight:700}
table{width:100%;border-collapse:separate;border-spacing:0 8px;padding:0 14px 14px}
thead th{font-size:12px;font-weight:600;color:#9fb0c7;text-align:left;padding:0 8px}
tbody tr{background:linear-gradient(180deg,#0c1320,#0b101a);border:1px solid #1e2a40}
tbody td{padding:10px 8px;border-top:1px solid #1e2a40;border-bottom:1px solid #1e2a40}
.chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--chip-b);padding:4px 8px;border-radius:999px;font-size:12px}
.muted{color:var(--muted)}
.hidden{display:none}
.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New",monospace}
.dup{color:var(--bad)!important;font-weight:700}
.tagbtn{border:1px dashed #2a3a55;padding:6px 10px;border-radius:8px;background:#121a2b}
.rowops{display:flex;gap:6px;align-items:center}
.exp-row{background:#0d1526;border-left:3px solid #2e4a7a}
.footer{margin-top:10px;color:#8b9ab3;text-align:center;font-size:12px}
.k{color:#7aa2f7}
.badge{font-size:11px;border:1px solid #2a3a55;background:#101726;padding:2px 6px;border-radius:999px}
hr.sep{border:none;border-top:1px dashed #26334a;margin:6px 0}
.modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
.modal{width:860px;max-width:96vw;background:#0e1624;border:1px solid #2a3a55;border-radius:14px;box-shadow:0 10px 35px rgba(0,0,0,.45)}
.modal .mh{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #24334c}
.modal .mb{padding:14px}
.modal .ft{display:flex;justify-content:flex-end;gap:8px;padding:12px 14px;border-top:1px solid #24334c}
.col{display:flex;flex-direction:column;gap:8px}
input[type="file"]{height:auto}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <div class="logo"></div><h1>æ‰«ç å¹³å° Â· v1.4</h1>
    <span class="pill">æœ¬åœ°è¿è¡Œ</span>
    <div class="right toolbar">
      <button class="btn sm" id="btnAssoc">ğŸ”— æ‰‹åŠ¨å…³è”</button>
      <button class="btn sm" id="btnExportAll">ğŸ’¾ å¯¼å‡ºå…¨éƒ¨</button>
      <label for="impAll" class="btn sm accent" style="cursor:pointer">ğŸ“¥ å¯¼å…¥CSV</label>
      <input id="impAll" type="file" accept=".csv" class="hidden">
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="tracking">è¿å•ç™»è®°</div>
    <div class="tab" data-tab="device">è®¾å¤‡ç™»è®°</div>
    <div class="tab" data-tab="summary">æ±‡æ€» / æ˜ç»†</div>
    <div class="tab" data-tab="settings">è®¾ç½® & SKU</div>
  </div>

  <!-- è¿å• -->
  <section id="panel-tracking" class="panel">
    <div class="head">
      <h2>ğŸšš è¿å•ç™»è®°ï¼ˆFedEx è‡ªåŠ¨æˆªå12ä½ / UPS ä¿ç•™å®Œæ•´ï¼‰</h2>
      <div class="toolbar">
        <button class="btn sm" id="btnExportTracking">å¯¼å‡ºCSV</button>
        <label class="btn sm accent" for="impT" style="cursor:pointer">å¯¼å…¥CSV</label>
        <input id="impT" type="file" accept=".csv" class="hidden">
        <button class="btn sm bad" id="btnClearTracking">æ¸…ç©ºè¿å•</button>
      </div>
    </div>
    <div class="form">
      <input id="t_tag" placeholder="æ ‡è®°ï¼ˆå¦‚ A001ï¼‰">
      <input id="t_input" placeholder="æ‰«ç æˆ–é”®å…¥è¿å•å·ï¼ˆç„¦ç‚¹æ”¾è¿™é‡Œï¼Œç”¨æ‰«ç æªå›è½¦ï¼‰">
      <select id="t_type">
        <option value="auto">è‡ªåŠ¨è¯†åˆ«</option>
        <option value="FedEx">FedEx</option>
        <option value="UPS">UPS</option>
      </select>
      <input id="t_note" placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰">
      <button id="btnAddTracking" class="btn primary">ç™»è®°è¿å•</button>
      <button id="btnFocusT" class="btn">èšç„¦</button>
    </div>
    <div class="stat">
      <div class="card"><div class="muted">è¿å•æ€»æ•°</div><div class="v" id="tCount">0</div></div>
      <div class="card"><div class="muted">FedEx</div><div class="v" id="tFedex">0</div></div>
      <div class="card"><div class="muted">UPS</div><div class="v" id="tUps">0</div></div>
      <div class="card"><div class="muted">æ ‡è®°ç§ç±»</div><div class="v" id="tTags">0</div></div>
    </div>
    <table>
      <thead><tr><th>æ ‡è®°</th><th>è¿å•å·</th><th>ç±»å‹</th><th>æ—¶é—´</th><th>å¤‡æ³¨</th><th>ç»‘å®šè®¾å¤‡æ•°</th><th>æ“ä½œ</th></tr></thead>
      <tbody id="tBody"></tbody>
    </table>
  </section>

  <!-- è®¾å¤‡ -->
  <section id="panel-device" class="panel hidden">
    <div class="head">
      <h2>ğŸ“± è®¾å¤‡ç™»è®°ï¼ˆåºåˆ—å· / UPC / SKUè‡ªåŠ¨åŒ¹é…ï¼‰</h2>
      <div class="toolbar">
        <button class="btn sm" id="btnExportDevice">å¯¼å‡ºCSV</button>
        <label class="btn sm accent" for="impD" style="cursor:pointer">å¯¼å…¥CSV</label>
        <input id="impD" type="file" accept=".csv" class="hidden">
        <button class="btn sm bad" id="btnClearDevice">æ¸…ç©ºè®¾å¤‡</button>
      </div>
    </div>
    <div class="form">
      <input id="d_tag" placeholder="æ ‡è®°ï¼ˆå¦‚ A001ï¼‰">
      <input id="d_serial" placeholder="åºåˆ—å·ï¼ˆæ‰«ç æˆ–é”®å…¥ï¼Œå›è½¦è·³è½¬åˆ°UPCï¼‰">
      <input id="d_upc" placeholder="UPCï¼ˆè‡ªåŠ¨åŒ¹é… SKUï¼‰">
      <input id="d_device" placeholder="Deviceï¼ˆSKUæ˜ å°„ï¼‰">
      <input id="d_capacity" placeholder="Capacityï¼ˆSKUæ˜ å°„ï¼‰">
      <input id="d_color" placeholder="Colorï¼ˆSKUæ˜ å°„ï¼‰">
      <div class="full muted">æç¤ºï¼šåºåˆ—å·é‡å¤å°† <b class="k">çº¢è‰²é«˜äº® + å£°éŸ³æé†’</b>ï¼ˆå¯åœ¨è®¾ç½®å…³é—­ï¼‰</div>
      <button id="btnAddDevice" class="btn primary">ç™»è®°è®¾å¤‡</button>
      <button id="btnFocusD" class="btn">èšç„¦</button>
    </div>
    <div class="stat">
      <div class="card"><div class="muted">è®¾å¤‡æ€»æ•°</div><div class="v" id="dCount">0</div></div>
      <div class="card"><div class="muted">å”¯ä¸€åºåˆ—å·</div><div class="v" id="dUnique">0</div></div>
      <div class="card"><div class="muted">æ ‡è®°ç§ç±»</div><div class="v" id="dTags">0</div></div>
      <div class="card"><div class="muted">æœ€è¿‘ç™»è®°</div><div class="v" id="dLast">-</div></div>
    </div>
    <table>
      <thead><tr><th>æ ‡è®°</th><th>åºåˆ—å·</th><th>UPC</th><th>Device</th><th>Capacity</th><th>Color</th><th>æ—¶é—´</th><th>çŠ¶æ€</th><th>ç»‘å®šè¿å•</th><th>æ“ä½œ</th></tr></thead>
      <tbody id="dBody"></tbody>
    </table>
  </section>

  <!-- æ±‡æ€» -->
  <section id="panel-summary" class="panel hidden">
    <div class="head">
      <h2>ğŸ“Š æ±‡æ€» / æ˜ç»†ï¼ˆæŒ‰ Tagï¼‰</h2>
      <div class="toolbar">
        <button id="btnExpandAll" class="btn sm">å…¨éƒ¨å±•å¼€</button>
        <button id="btnCollapseAll" class="btn sm">å…¨éƒ¨æ”¶èµ·</button>
      </div>
    </div>
    <div class="grid-2">
      <div>
        <div style="padding:12px 14px"><span class="badge">è¿å•æ±‡æ€»</span> <span class="muted">ï¼ˆâ–¶ å±•å¼€æŸ¥çœ‹æ˜ç»†/å…³è”ï¼‰</span></div>
        <table><thead><tr><th>æ ‡è®°</th><th>è¿å•æ•°é‡</th><th>æœ€è¿‘æ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody id="sumT"></tbody></table>
      </div>
      <div>
        <div style="padding:12px 14px"><span class="badge">è®¾å¤‡æ±‡æ€»</span> <span class="muted">ï¼ˆâ–¶ å±•å¼€æŸ¥çœ‹æ˜ç»†/å…³è”ï¼‰</span></div>
        <table><thead><tr><th>æ ‡è®°</th><th>è®¾å¤‡æ•°é‡</th><th>æœ€è¿‘æ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody id="sumD"></tbody></table>
      </div>
    </div>
  </section>

  <!-- è®¾ç½® & SKU -->
  <section id="panel-settings" class="panel hidden">
    <div class="head"><h2>âš™ï¸ è®¾ç½® & SKU æ˜ å°„</h2></div>
    <div class="form">
      <label class="full"><input type="checkbox" id="setFedexTail" checked> FedEx ä»…ä¿ç•™å 12 ä½</label>
      <label class="full"><input type="checkbox" id="setSound" checked> å¯ç”¨æç¤ºéŸ³</label>
      <label class="full"><input type="checkbox" id="setConfirmDelete" checked> åˆ é™¤å‰ç¡®è®¤</label>
      <div class="full">
        <div class="rowops" style="display:flex;gap:8px;align-items:center">
          <span class="badge">SKU æ˜ å°„è¡¨</span>
          <button id="btnSkuUpload" class="btn sm accent" type="button">ä¸Šä¼  CSV</button>
          <input type="file" id="skuUpload" accept=".csv" class="hidden">
          <button id="btnSkuClear" class="btn sm bad" type="button">æ¸…ç©ºæ˜ å°„</button>
          <span id="skuStatus" class="muted"></span>
        </div>
        <hr class="sep">
        <div class="rowops">
          <input id="sku_upc" placeholder="UPC">
          <input id="sku_dev" placeholder="Device">
          <input id="sku_cap" placeholder="Capacity">
          <input id="sku_col" placeholder="Color">
          <button id="btnSkuAdd" class="btn sm good" type="button">æ·»åŠ /æ›´æ–°æ˜ å°„</button>
        </div>
      </div>
      <div class="full muted">æ•°æ®ä¸è®¾ç½®å‡ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ï¼ˆlocalStorageï¼‰ã€‚</div>
    </div>
  </section>

  <div class="footer">Â© v1.4 Â· æ”¯æŒæ‰«ç æªï¼ˆå›è½¦æäº¤ï¼‰ Â· å¯éƒ¨ç½²åˆ° GitHub Pages</div>
</div>

<!-- å…³è” å¼¹çª— -->
<div class="modal-mask" id="assocMask">
  <div class="modal">
    <div class="mh"><b>ğŸ”— æ‰‹åŠ¨å…³è”ï¼ˆæŒ‰æ ‡è®°ï¼‰</b><button class="btn sm" id="assocClose">å…³é—­</button></div>
    <div class="mb">
      <div class="rowops" style="gap:10px;margin-bottom:10px">
        <input id="assocTag" placeholder="æ ‡è®°ï¼ˆå¦‚ A001ï¼‰" style="width:200px">
        <button id="assocLoad" class="btn sm">è½½å…¥</button>
        <span class="muted" id="assocHint"></span>
      </div>
      <div class="grid-2">
        <div class="col">
          <div class="badge">æœªç»‘å®šè®¾å¤‡ï¼ˆè¯¥æ ‡è®°ï¼‰</div>
          <select id="assocDevice" size="8" style="height:220px"></select>
        </div>
        <div class="col">
          <div class="badge">å¯ç”¨è¿å•ï¼ˆè¯¥æ ‡è®°ï¼‰</div>
          <select id="assocTracking" size="8" style="height:220px"></select>
        </div>
      </div>
      <div class="rowops" style="gap:8px;margin-top:10px">
        <button id="assocBind" class="btn good">â‡„ ç»‘å®š</button>
        <button id="assocUnbind" class="btn bad">âœ– è§£ç»‘</button>
      </div>
    </div>
    <div class="ft">
      <button class="btn sm" id="assocDone">å®Œæˆ</button>
    </div>
  </div>
</div>

<script>
/* ====== å­˜å‚¨ ====== */
const store = {
  load(){ return Object.assign({settings:{fedexTail12:true,sound:true,confirmDelete:true},tracking:[],device:[],sku:{}}, JSON.parse(localStorage.getItem('SCAN_V14')||'{}')); },
  save(d){ localStorage.setItem('SCAN_V14', JSON.stringify(d)); }
};
let DB = store.load();

/* ====== å·¥å…· ====== */
const $ = s=>document.querySelector(s);
const el = (t,a={},h='')=>{const n=document.createElement(t);for(const k in a){k==='class'?n.className=a[k]:n.setAttribute(k,a[k])}if(h)n.innerHTML=h;return n;}
const now = ()=> new Date().toLocaleString('zh-CN',{hour12:false});
const URL_OK='data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAABkAAAA';
const URL_WARN=URL_OK, URL_ERR=URL_OK;
function beep(kind){ if(!DB.settings.sound) return; const a=new Audio(); a.src=kind==='warn'?URL_WARN:kind==='err'?URL_ERR:URL_OK; a.volume=.5; a.play(); }

function uid(){ return Date.now()+Math.random(); }

/* ====== é€‰é¡¹å¡ ====== */
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const name=t.dataset.tab;
  ['tracking','device','summary','settings'].forEach(id=>$('#panel-'+id).classList.toggle('hidden', id!==name));
}));

/* ====== è¯†åˆ«è¿å• ====== */
function normalizeTracking(raw, forceType){
  let s=(raw||'').trim().toUpperCase().replace(/\s+/g,'');
  let type='Unknown';
  if(forceType && forceType!=='auto') type=forceType;
  if(!forceType || forceType==='auto'){
    if(/^1Z[0-9A-Z]{16}$/.test(s)) type='UPS';
    else if(/^\d{12,22}$/.test(s)) type='FedEx';
  }
  if(type==='FedEx' && DB.settings.fedexTail12 && /^\d+$/.test(s) && s.length>12) s=s.slice(-12);
  return {tracking:s,type};
}

/* ====== æ¸²æŸ“è¿å• ====== */
function renderTracking(){
  const body=$('#tBody'); body.innerHTML='';
  $('#tCount').textContent=DB.tracking.length;
  $('#tFedex').textContent=DB.tracking.filter(x=>x.type==='FedEx').length;
  $('#tUps').textContent=DB.tracking.filter(x=>x.type==='UPS').length;
  $('#tTags').textContent=new Set(DB.tracking.map(x=>x.tag||'')).size;

  const boundCountByTracking=new Map();
  DB.device.forEach(d=>{ if(d.tracking_id){ boundCountByTracking.set(d.tracking_id,(boundCountByTracking.get(d.tracking_id)||0)+1);} });

  DB.tracking.slice().reverse().forEach(r=>{
    const tr=el('tr');
    tr.append(el('td',{},`<span class="chip mono">${r.tag||'-'}</span>`));
    tr.append(el('td',{},`<span class="mono">${r.tracking}</span>`));
    tr.append(el('td',{},r.type));
    tr.append(el('td',{},r.created_at));
    tr.append(el('td',{},r.note||''));
    tr.append(el('td',{},String(boundCountByTracking.get(r.id)||0)));
    const ops=el('td');
    const assoc=el('button',{class:'btn sm'},'å…³è”');
    assoc.onclick=()=> openAssoc(r.tag||'');
    const del=el('button',{class:'btn sm bad'},'åˆ é™¤');
    del.onclick=()=>{ if(!DB.settings.confirmDelete||confirm('åˆ é™¤è¯¥è¿å•è®°å½•ï¼Ÿ')){ DB.tracking=DB.tracking.filter(x=>x.id!==r.id); DB.device.forEach(d=>{ if(d.tracking_id===r.id) d.tracking_id=null;}); store.save(DB); renderAll(); }};
    ops.append(assoc,del);
    tr.append(ops);
    body.append(tr);
  });
}

/* ====== æ¸²æŸ“è®¾å¤‡ ====== */
function renderDevice(){
  const body=$('#dBody'); body.innerHTML='';
  const uniq=new Set(DB.device.map(x=>x.serial).filter(Boolean));
  $('#dCount').textContent=DB.device.length;
  $('#dUnique').textContent=uniq.size;
  $('#dTags').textContent=new Set(DB.device.map(x=>x.tag||'')).size;
  $('#dLast').textContent=DB.device.length? DB.device[DB.device.length-1].created_at : '-';

  DB.device.slice().reverse().forEach(r=>{
    const tr=el('tr');
    tr.append(el('td',{},`<span class="chip mono">${r.tag||'-'}</span>`));
    const s=el('td',{}, r.serial?`<span class="mono">${r.serial}</span>`:'-');
    if(r.serial && DB.device.filter(x=>x.serial===r.serial).length>1) s.classList.add('dup');
    tr.append(s);
    tr.append(el('td',{}, r.upc?`<span class="mono">${r.upc}</span>`:'-'));
    tr.append(el('td',{}, r.device||'-'));
    tr.append(el('td',{}, r.capacity||'-'));
    tr.append(el('td',{}, r.color||'-'));
    tr.append(el('td',{}, r.created_at));
    tr.append(el('td',{}, r.status||'OK'));
    const bound = r.tracking_id ? (DB.tracking.find(t=>t.id===r.tracking_id)?.tracking || '(å·²ç»‘)') : '-';
    tr.append(el('td',{}, bound ? `<span class="mono">${bound}</span>`:'-'));
    const ops=el('td');
    const assoc=el('button',{class:'btn sm'},'å…³è”');
    assoc.onclick=()=> openAssoc(r.tag||'');
    const del=el('button',{class:'btn sm bad'},'åˆ é™¤');
    del.onclick=()=>{ if(!DB.settings.confirmDelete||confirm('åˆ é™¤è¯¥è®¾å¤‡è®°å½•ï¼Ÿ')){ DB.device=DB.device.filter(x=>x.id!==r.id); store.save(DB); renderAll(); } };
    ops.append(assoc,del);
    tr.append(ops);
    body.append(tr);
  });
}

/* ====== æ±‡æ€»/æ˜ç»† ====== */
function groupByTag(list){ const m=new Map(); list.forEach(x=>{const k=x.tag||''; if(!m.has(k)) m.set(k,[]); m.get(k).push(x)}); return m; }

function renderSummary(){
  // è¿å•
  const sumT=$('#sumT'); sumT.innerHTML='';
  const gT=groupByTag(DB.tracking);
  [...gT.entries()].sort((a,b)=>(a[0]||'').localeCompare(b[0]||'')).forEach(([tag,arr])=>{
    const last=arr[arr.length-1]?.created_at||'-';
    const tr=el('tr');
    tr.append(el('td',{},`<span class="chip mono">${tag||'-'}</span>`));
    tr.append(el('td',{},String(arr.length)));
    tr.append(el('td',{},last));
    const op=el('td');
    const btn=el('button',{class:'btn sm'},'â–¶ å±•å¼€');
    let open=false; let detail=[];
    btn.onclick=()=>{ open=!open; btn.textContent=open?'â–¼ æ”¶èµ·':'â–¶ å±•å¼€';
      if(open){
        arr.forEach(r=>{
          const dr=el('tr',{class:'exp-row'});
          dr.append(el('td',{},''));
          dr.append(el('td',{}, `<span class="mono">${r.type}</span> Â· <span class="mono">${r.tracking}</span>`));
          dr.append(el('td',{}, r.created_at));
          const td=el('td');
          const abtn=el('button',{class:'btn sm'},'å…³è”');
          abtn.onclick=()=> openAssoc(tag);
          const dbtn=el('button',{class:'btn sm bad'},'åˆ é™¤');
          dbtn.onclick=()=>{ if(!DB.settings.confirmDelete||confirm('åˆ é™¤è¯¥è¿å•ï¼Ÿ')){ DB.tracking=DB.tracking.filter(x=>x.id!==r.id); DB.device.forEach(d=>{ if(d.tracking_id===r.id) d.tracking_id=null; }); store.save(DB); renderAll(); } };
          td.append(abtn,dbtn); dr.append(td);
          tr.parentNode.insertBefore(dr,tr.nextSibling); detail.push(dr);
        });
      }else{ detail.forEach(n=>n.remove()); detail=[]; }
    };
    const x=el('button',{class:'btn sm'},'å¯¼å‡ºæ­¤æ ‡è®°');
    x.onclick=()=> exportCSVTag('tracking',tag);
    const assoc=el('button',{class:'btn sm'},'å…³è”');
    assoc.onclick=()=> openAssoc(tag);
    op.append(btn,assoc,x); tr.append(op); sumT.append(tr);
  });

  // è®¾å¤‡
  const sumD=$('#sumD'); sumD.innerHTML='';
  const gD=groupByTag(DB.device);
  [...gD.entries()].sort((a,b)=>(a[0]||'').localeCompare(b[0]||'')).forEach(([tag,arr])=>{
    const last=arr[arr.length-1]?.created_at||'-';
    const tr=el('tr');
    tr.append(el('td',{},`<span class="chip mono">${tag||'-'}</span>`));
    tr.append(el('td',{},String(arr.length)));
    tr.append(el('td',{},last));
    const op=el('td');
    const btn=el('button',{class:'btn sm'},'â–¶ å±•å¼€');
    let open=false; let detail=[];
    btn.onclick=()=>{ open=!open; btn.textContent=open?'â–¼ æ”¶èµ·':'â–¶ å±•å¼€';
      if(open){
        arr.forEach(r=>{
          const dr=el('tr',{class:'exp-row'});
          dr.append(el('td',{},''));
          dr.append(el('td',{}, `SN <span class="mono">${r.serial||'-'}</span> Â· UPC <span class="mono">${r.upc||'-'}</span>${r.tracking_id? ' Â· ç»‘å®š ' + (DB.tracking.find(t=>t.id===r.tracking_id)?.tracking||''):''}`));
          dr.append(el('td',{}, r.created_at));
          const td=el('td');
          const abtn=el('button',{class:'btn sm'},'å…³è”');
          abtn.onclick=()=> openAssoc(tag);
          const dbtn=el('button',{class:'btn sm bad'},'åˆ é™¤');
          dbtn.onclick=()=>{ if(!DB.settings.confirmDelete||confirm('åˆ é™¤è¯¥è®¾å¤‡ï¼Ÿ')){ DB.device=DB.device.filter(x=>x.id!==r.id); store.save(DB); renderAll(); } };
          td.append(abtn,dbtn); dr.append(td);
          tr.parentNode.insertBefore(dr,tr.nextSibling); detail.push(dr);
        });
      }else{ detail.forEach(n=>n.remove()); detail=[]; }
    };
    const x=el('button',{class:'btn sm'},'å¯¼å‡ºæ­¤æ ‡è®°');
    x.onclick=()=> exportCSVTag('device',tag);
    const assoc=el('button',{class:'btn sm'},'å…³è”');
    assoc.onclick=()=> openAssoc(tag);
    op.append(btn,assoc,x); tr.append(op); sumD.append(tr);
  });
}

/* ====== æ·»åŠ /å¯¼å…¥/å¯¼å‡ºï¼ˆè¿å•ï¼‰ ====== */
const tTag=$('#t_tag'), tInput=$('#t_input'), tType=$('#t_type'), tNote=$('#t_note');
$('#btnFocusT').onclick=()=> tInput.focus();
tInput.addEventListener('keydown',e=>{ if(e.key==='Enter') addTracking(); });
$('#btnAddTracking').onclick=addTracking;
$('#btnClearTracking').onclick=()=>{ if(!DB.settings.confirmDelete||confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è¿å•è®°å½•ï¼Ÿ')){ DB.tracking=[]; DB.device.forEach(d=>d.tracking_id=null); store.save(DB); renderAll(); }};
$('#btnExportTracking').onclick=()=> exportCSV('tracking');
$('#impT').addEventListener('change',e=> importCSV(e,'tracking'));

function addTracking(){
  const tag=tTag.value.trim();
  const raw=tInput.value.trim();
  if(!raw){ tInput.focus(); return; }
  const {tracking,type}=normalizeTracking(raw,tType.value);
  DB.tracking.push({id:uid(),tag,tracking,type,note:tNote.value.trim(),created_at:now()});
  store.save(DB);
  tInput.value=''; tNote.value=''; beep('ok'); renderAll();
}

/* ====== æ·»åŠ /å¯¼å…¥/å¯¼å‡ºï¼ˆè®¾å¤‡ï¼‰ ====== */
const dTag=$('#d_tag'), dSerial=$('#d_serial'), dUPC=$('#d_upc'), dDev=$('#d_device'), dCap=$('#d_capacity'), dCol=$('#d_color');
$('#btnFocusD').onclick=()=> (dSerial.value? dUPC : dSerial).focus();
dSerial.addEventListener('keydown',e=>{ if(e.key==='Enter') dUPC.focus(); });
dUPC.addEventListener('input', trySkuFill);
dUPC.addEventListener('keydown',e=>{ if(e.key==='Enter') addDevice(); });
$('#btnAddDevice').onclick=addDevice;
$('#btnClearDevice').onclick=()=>{ if(!DB.settings.confirmDelete||confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è®¾å¤‡è®°å½•ï¼Ÿ')){ DB.device=[]; store.save(DB); renderAll(); }};
$('#btnExportDevice').onclick=()=> exportCSV('device');
$('#impD').addEventListener('change',e=> importCSV(e,'device'));

function trySkuFill(){
  const upc=(dUPC.value||'').trim();
  const sku=DB.sku[upc];
  if(sku){ dDev.value=sku.device||''; dCap.value=sku.capacity||''; dCol.value=sku.color||''; }
}

function addDevice(){
  const tag=dTag.value.trim();
  const serial=(dSerial.value||'').trim().toUpperCase();
  const upc=(dUPC.value||'').trim();
  if(!serial && !upc){ dSerial.focus(); return; }
  const dup = serial && DB.device.some(x=>x.serial===serial);
  if(dup){ beep('warn'); }
  // è‡ªåŠ¨SKU
  const sku=DB.sku[upc]; const dev=dDev.value|| (sku?sku.device:''); const cap=dCap.value||(sku?sku.capacity:''); const col=dCol.value||(sku?sku.color:'');
  DB.device.push({id:uid(),tag,serial,upc,device:dev,capacity:cap,color:col,status: dup?'é‡å¤':'OK',created_at:now(),tracking_id:null});
  store.save(DB);
  dSerial.value=''; dUPC.value=''; if(!dDev.value) dDev.value=''; if(!dCap.value) dCap.value=''; if(!dCol.value) dCol.value='';
  renderAll();
}

/* ====== å¯¼å…¥/å¯¼å‡ºï¼ˆé€šç”¨ä¸åˆ†Tagï¼‰ ====== */
function toCSV(rows){ return rows.map(r=>r.map(v=>{ const s=(v==null?'':String(v)); return /[",\n]/.test(s)? '"'+s.replace(/"/g,'""')+'"' : s; }).join(',')).join('\n'); }

function exportCSV(kind){
  let rows=[], name='';
  if(kind==='tracking'){
    rows=[['id','tag','tracking','type','note','created_at']].concat(DB.tracking.map(r=>[r.id,r.tag||'',r.tracking,r.type,r.note||'',r.created_at]));
    name='tracking';
  }else{
    rows=[['id','tag','serial','upc','device','capacity','color','status','created_at','tracking_id']]
      .concat(DB.device.map(r=>[r.id,r.tag||'',r.serial||'',r.upc||'',r.device||'',r.capacity||'',r.color||'',r.status||'',r.created_at, r.tracking_id||'']));
    name='device';
  }
  const blob=new Blob(["\ufeff"+toCSV(rows)],{type:'text/csv;charset=utf-8;'});
  const a=el('a',{download:`${name}_${Date.now()}.csv`}); a.href=URL.createObjectURL(blob); a.click();
}

function exportCSVTag(kind,tag){
  let rows=[],name='';
  if(kind==='tracking'){
    const arr=DB.tracking.filter(r=>(r.tag||'')===tag);
    rows=[['id','tag','tracking','type','note','created_at']].concat(arr.map(r=>[r.id,r.tag||'',r.tracking,r.type,r.note||'',r.created_at]));
    name='tracking_'+(tag||'blank');
  }else{
    const arr=DB.device.filter(r=>(r.tag||'')===tag);
    rows=[['id','tag','serial','upc','device','capacity','color','status','created_at','tracking_id']]
      .concat(arr.map(r=>[r.id,r.tag||'',r.serial||'',r.upc||'',r.device||'',r.capacity||'',r.color||'',r.status||'',r.created_at, r.tracking_id||'']));
    name='device_'+(tag||'blank');
  }
  const blob=new Blob(["\ufeff"+toCSV(rows)],{type:'text/csv;charset=utf-8;'});
  const a=el('a',{download:`${name}_${Date.now()}.csv`}); a.href=URL.createObjectURL(blob); a.click();
}

$('#btnExportAll').onclick=()=>{
  // å¯¼å‡ºä¸ºä¸¤ä¸ªCSVæ–‡ä»¶
  exportCSV('tracking');
  exportCSV('device');
};

$('#impAll').addEventListener('change', e=> importCSV(e,'auto'));

function importCSV(evt,kind){
  const f=evt.target.files[0]; if(!f) return;
  const rd=new FileReader();
  rd.onload=()=>{
    const text=rd.result.replace(/^\uFEFF/,''); const lines=text.split(/\r?\n/).filter(x=>x.trim().length);
    const head=lines.shift().split(',').map(x=>x.replace(/^"|"$/g,''));
    const rows=lines.map(l=> l.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s=>s.replace(/^"|"$/g,'').replace(/""/g,'"')));
    const H = Object.fromEntries(head.map((h,i)=>[h,i]));
    const has=(k)=> Number.isInteger(H[k]);

    if(kind==='tracking' || (kind==='auto' && has('tracking'))){
      rows.forEach(r=>{
        const id = has('id')? r[H.id] : uid();
        const obj={ id,
          tag: has('tag')?r[H.tag]:'', tracking:r[H.tracking], type: has('type')?r[H.type]:'Unknown',
          note: has('note')?r[H.note]:'', created_at: has('created_at')?r[H.created_at]:now()
        };
        // å»é‡ç›¸åŒ id
        DB.tracking = DB.tracking.filter(x=>x.id!==obj.id);
        DB.tracking.push(obj);
      });
    }else if(kind==='device' || (kind==='auto' && has('serial'))){
      rows.forEach(r=>{
        const id= has('id')? r[H.id] : uid();
        const obj={ id,
          tag: has('tag')?r[H.tag]:'', serial: has('serial')? (r[H.serial]||'').toUpperCase() : '',
          upc: has('upc')? r[H.upc] : '', device: has('device')? r[H.device] : '',
          capacity: has('capacity')? r[H.capacity] : '', color: has('color')? r[H.color] : '',
          status: has('status')? r[H.status] : 'OK', created_at: has('created_at')? r[H.created_at] : now(),
          tracking_id: has('tracking_id')? (r[H.tracking_id]||'') : ''
        };
        DB.device = DB.device.filter(x=>x.id!==obj.id);
        DB.device.push(obj);
      });
    }else{
      alert('æ— æ³•è¯†åˆ«çš„CSVï¼šç¼ºå°‘å…³é”®åˆ—ï¼ˆtracking/serialï¼‰ã€‚');
    }
    store.save(DB); renderAll();
    evt.target.value='';
  };
  rd.readAsText(f,'utf-8');
}

/* ====== è®¾ç½® & SKU ====== */
const setFedexTail=$('#setFedexTail'), setSound=$('#setSound'), setConfirm=$('#setConfirmDelete');
setFedexTail.checked=!!DB.settings.fedexTail12;
setSound.checked=!!DB.settings.sound;
setConfirm.checked=!!DB.settings.confirmDelete;
setFedexTail.onchange=()=>{ DB.settings.fedexTail12=setFedexTail.checked; store.save(DB); };
setSound.onchange=()=>{ DB.settings.sound=setSound.checked; store.save(DB); };
setConfirm.onchange=()=>{ DB.settings.confirmDelete=setConfirm.checked; store.save(DB); };

function renderSkuStatus(){ $('#skuStatus').textContent = `æ˜ å°„æ¡æ•°ï¼š${Object.keys(DB.sku||{}).length}`; }
$('#btnSkuUpload').onclick=()=> $('#skuUpload').click();
$('#skuUpload').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader();
  rd.onload=()=>{
    const lines=rd.result.split(/\r?\n/).filter(x=>x.trim().length);
    lines.shift(); // header
    lines.forEach(row=>{
      const [upc,device,capacity,color]=row.split(',').map(x=> (x||'').trim());
      if(upc) DB.sku[upc]={device,capacity,color};
    });
    store.save(DB); renderSkuStatus(); alert('âœ… SKU æ˜ å°„å¯¼å…¥å®Œæˆ');
    e.target.value='';
  };
  rd.readAsText(f,'utf-8');
});
$('#btnSkuAdd').onclick=()=>{
  const u=$('#sku_upc').value.trim();
  if(!u) return alert('è¯·è¾“å…¥ UPC');
  DB.sku[u]={device:$('#sku_dev').value.trim(),capacity:$('#sku_cap').value.trim(),color:$('#sku_col').value.trim()};
  store.save(DB); renderSkuStatus(); alert('âœ… å·²æ·»åŠ /æ›´æ–° SKU æ˜ å°„');
};
$('#btnSkuClear').onclick=()=>{
  if(!DB.settings.confirmDelete||confirm('æ¸…ç©ºæ‰€æœ‰ SKU æ˜ å°„ï¼Ÿ')){
    DB.sku={}; store.save(DB); renderSkuStatus();
  }
};

/* ====== æ‰‹åŠ¨å…³è” å¼¹çª— ====== */
const mask=$('#assocMask'), assocClose=$('#assocClose'), assocDone=$('#assocDone');
$('#btnAssoc').onclick=()=> openAssoc('');
assocClose.onclick=closeAssoc; assocDone.onclick=closeAssoc;
$('#assocLoad').onclick=()=> loadAssoc($('#assocTag').value.trim());

function openAssoc(tag){ mask.style.display='flex'; $('#assocTag').value=tag||''; loadAssoc(tag||''); }
function closeAssoc(){ mask.style.display='none'; }

function loadAssoc(tag){
  const devSel=$('#assocDevice'), trSel=$('#assocTracking'); devSel.innerHTML=''; trSel.innerHTML='';
  const devices=DB.device.filter(d=>(d.tag||'')===tag && !d.tracking_id);
  const tracks=DB.tracking.filter(t=>(t.tag||'')===tag);
  devices.forEach(d=>{ const opt=el('option',{value:d.id}, `SN:${d.serial||'-'} Â· UPC:${d.upc||'-'} Â· ${d.device||''} ${d.capacity||''} ${d.color||''}`); devSel.append(opt); });
  tracks.forEach(t=>{ const cnt=DB.device.filter(d=>d.tracking_id===t.id).length; const opt=el('option',{value:t.id}, `[${t.type}] ${t.tracking} Â· å·²ç»‘:${cnt}`); trSel.append(opt); });
  $('#assocHint').textContent=`è®¾å¤‡å¯é€‰ï¼š${devices.length} Â· è¿å•å¯é€‰ï¼š${tracks.length}`;
}

$('#assocBind').onclick=()=>{
  const dId=$('#assocDevice').value, tId=$('#assocTracking').value;
  if(!dId || !tId) return alert('è¯·é€‰æ‹©è®¾å¤‡å’Œè¿å•');
  const d=DB.device.find(x=>x.id==dId);
  d.tracking_id=tId;
  store.save(DB); loadAssoc($('#assocTag').value.trim()); renderAll();
};
$('#assocUnbind').onclick=()=>{
  const dId=$('#assocDevice').value;
  if(!dId) return alert('è¯·é€‰æ‹©è®¾å¤‡');
  const d=DB.device.find(x=>x.id==dId);
  d.tracking_id=null;
  store.save(DB); loadAssoc($('#assocTag').value.trim()); renderAll();
};

/* ====== æ±‡æ€»åŒº å±•å¼€/æ”¶èµ· ====== */
$('#btnExpandAll').onclick=()=> document.querySelectorAll('#sumT .btn.sm, #sumD .btn.sm').forEach(b=>{ if(b.textContent==='â–¶ å±•å¼€') b.click(); });
$('#btnCollapseAll').onclick=()=> document.querySelectorAll('#sumT .btn.sm, #sumD .btn.sm').forEach(b=>{ if(b.textContent==='â–¼ æ”¶èµ·') b.click(); });

/* ====== åˆå§‹åŒ– ====== */
function renderAll(){ renderTracking(); renderDevice(); renderSummary(); renderSkuStatus(); }
renderAll();
</script>
</body>
</html>
