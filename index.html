<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>天道扫码 v3.7 · 运单 / 设备 / 汇总 / SKU / 标签 / 设置</title>
<style>
:root{
  --bg:#0b0f14;--panel:#121822;--card:#0f1520;--muted:#98a2b3;--text:#e8eef6;--accent:#4cc9f0;--accent2:#7c5cff;--good:#16a34a;--warn:#f59e0b;--bad:#ef4444;--line:#223049;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0a0e14 0%,#0b111a 100%);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif}
.wrap{max-width:1200px;margin:0 auto;padding:22px}
.title{display:flex;gap:10px;align-items:center;margin-bottom:14px}
.logo{width:14px;height:14px;border-radius:4px;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 0 0 2px #111 inset}
h1{font-size:18px;margin:0;font-weight:700}
.pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2a3a55;background:#121a2b;color:#c6d6f0}
.right{margin-left:auto;color:#8ca3c7}
.tabs{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 18px}
.tab{cursor:pointer;padding:10px 14px;border-radius:10px;background:#101827;border:1px solid #20314b;opacity:.85}
.tab.active{background:linear-gradient(180deg,#151d2b,#0f1623);border-color:#2a3a55;opacity:1;box-shadow:0 0 0 1px #2a3a55 inset}
.panel{background:linear-gradient(180deg,#0c1220,#0a111c);border:1px solid #1e2a3f;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);margin-bottom:14px}
.head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #1f2a40}
.head h2{font-size:14px;margin:0;color:#cdd6e5}
.flex{display:flex;gap:8px;align-items:center}
.btn{height:32px;padding:0 12px;border-radius:10px;border:1px solid #2a3448;background:linear-gradient(180deg,#1a2232,#121a28);color:var(--text);cursor:pointer}
.btn.sm{height:28px;border-radius:8px;font-size:12px}
.btn.acc{background:linear-gradient(180deg,#214155,#163042);border-color:#2e5a76}
.btn.good{background:linear-gradient(180deg,#12361f,#0f2a19);border-color:#1d4d2b}
.btn.bad{background:linear-gradient(180deg,#3a1212,#2a0f0f);border-color:#5a1f1f}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.form{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;padding:14px}
.form .full{grid-column:1/-1}
input,select,textarea{height:38px;padding:0 10px;border-radius:10px;border:1px solid #2a3448;background:#0e1522;color:var(--text);outline:none}
textarea{height:110px;padding:10px}
input::placeholder{color:#6b7280}
table{width:100%;border-collapse:separate;border-spacing:0 8px;padding:0 14px 14px}
thead th{font-size:12px;font-weight:600;color:#9fb0c7;text-align:left;padding:0 8px}
tbody tr{background:linear-gradient(180deg,#0c1320,#0b101a);border:1px solid #1e2a40}
tbody td{padding:8px 8px;border-top:1px solid #1e2a40;border-bottom:1px solid #1e2a40}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
.chip{display:inline-flex;align-items:center;gap:6px;background:#1b2331;border:1px solid #2b364a;padding:3px 8px;border-radius:999px;font-size:12px}
.stat{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;padding:12px 14px;border-top:1px dashed #23334d;background:linear-gradient(180deg,#0b111c,#0a0f18)}
.card{background:linear-gradient(180deg,#0d1320,#0b111a);border:1px solid #1e2940;border-radius:12px;padding:10px}
.card .v{font-size:18px;font-weight:700}
/* 关键修复：hidden 强制隐藏覆盖 flex */
.hidden{display:none !important;}
.exp{background:#0d1526;border-left:3px solid #2e4a7a}
.warn{animation:flash 0.6s linear 2}
.err{animation:flashR 0.6s linear 2}
@keyframes flash{0%,100%{box-shadow:0 0 0 0 rgba(245,158,11,.0)}50%{box-shadow:0 0 0 3px rgba(245,158,11,.35)}}
@keyframes flashR{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.0)}50%{box-shadow:0 0 0 3px rgba(239,68,68,.35)}}
.footer{margin-top:10px;color:#8b9ab3;text-align:center;font-size:12px}
.k{color:#7aa2f7}

/* 标签管理表 */
.tag-table thead th{font-size:12px}
.tag-table tbody td{font-size:13px}

/* 固定窗口列表 */
.list-window,
.tracking-window{
  border-radius:12px;
  border:1px solid #1e293b;
  background:linear-gradient(180deg,#0b1120,#020617);
  box-shadow:0 12px 30px rgba(0,0,0,.45);
  overflow:hidden;
  margin:0 14px 14px;
}
.list-header-row,
.tracking-header-row{
  background:linear-gradient(180deg,#0f172a,#020617);
}
.list-header-row th,
.tracking-header-row th{
  font-size:12px;
  font-weight:600;
  color:#9ca3af;
  padding:8px 12px;
  text-align:left;
}
.list-body-wrapper,
.tracking-body-wrapper{
  max-height:480px;
  overflow-y:auto;
}
.list-body-wrapper::-webkit-scrollbar,
.tracking-body-wrapper::-webkit-scrollbar,
.sum-body-wrapper::-webkit-scrollbar{
  width:6px;
}
.list-body-wrapper::-webkit-scrollbar-track,
.tracking-body-wrapper::-webkit-scrollbar-track,
.sum-body-wrapper::-webkit-scrollbar-track{
  background:#020617;
}
.list-body-wrapper::-webkit-scrollbar-thumb,
.tracking-body-wrapper::-webkit-scrollbar-thumb,
.sum-body-wrapper::-webkit-scrollbar-thumb{
  background:#374151;
  border-radius:3px;
}
.tracking-row td,
.sum-row td{
  padding:8px 12px;
  border-top:1px solid #111827;
  border-bottom:1px solid #020617;
  font-size:13px;
}

/* 原 v3.6 汇总容器基础样式复用 */
.sum-window{
  border-radius:0 0 12px 12px;
  border:1px solid #1e293b;
  background:linear-gradient(180deg,#0b1120,#020617);
  box-shadow:0 8px 24px rgba(0,0,0,.45);
  overflow:hidden;
}
.sum-header-row{
  background:#020617;
}
.sum-header-row th{
  font-size:12px;
  font-weight:600;
  color:#9fb0c7;
  padding:6px 10px;
  text-align:left;
}
.sum-body-wrapper{
  max-height:320px;
  overflow-y:auto;
}
.sum-row{
  background:linear-gradient(180deg,#020617,#020617);
}

/* ===== v3.7 新导出弹窗 ===== */
.export-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.75);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:60;
}
.export-modal{
  width:720px;
  max-width:96%;
  height:70vh;
  max-height:520px;
  background:#050816;
  border-radius:14px;
  border:1px solid #1e293b;
  box-shadow:0 24px 60px rgba(0,0,0,.8);
  display:flex;
  flex-direction:column;
}
.export-header{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 14px;
  border-bottom:1px solid #1e293b;
  background:#020617;
}
.export-title{
  font-size:14px;
  font-weight:500;
  color:#e5e7eb;
}
.export-date{
  font-size:12px;
  color:#9ca3af;
  margin-left:auto;
}
.export-close{
  border:none;
  background:transparent;
  color:#9ca3af;
  font-size:18px;
  cursor:pointer;
  padding:2px 6px;
  border-radius:999px;
}
.export-close:hover{
  background:#111827;
  color:#e5e7eb;
}
.export-body{
  flex:1;
  display:flex;
  gap:10px;
  padding:10px 14px;
  overflow:hidden;
}
.export-column{
  flex:1;
  display:flex;
  flex-direction:column;
  border-radius:10px;
  border:1px solid #1e293b;
  background:#020617;
}
.export-column-title{
  padding:6px 10px;
  font-size:12px;
  color:#9ca3af;
  border-bottom:1px solid #1e293b;
}
.export-column-list{
  flex:1;
  padding:6px 10px;
  overflow-y:auto;
  font-size:13px;
}
.export-tag-item{
  display:flex;
  align-items:center;
  gap:6px;
  padding:2px 0;
}
.export-tag-item input{accent-color:#3b82f6;}
.export-empty{
  font-size:12px;
  color:#6b7280;
}
.export-footer{
  padding:8px 14px;
  border-top:1px solid #1e293b;
  background:#020617;
  display:flex;
  align-items:center;
  justify-content:space-between;
  font-size:12px;
  color:#9ca3af;
}
.export-footer-buttons{
  display:flex;
  gap:8px;
}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <div class="logo"></div><h1>天道扫码 v3.7</h1>
    <span class="pill">本地运行 / GitHub Pages 可用</span>
    <span class="right">UPS/FedEx 自动识别 · FedEx 尾 12 位 · SN 去重纠错 · 标签管理 · 新汇总按标签导出</span>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="tracking">运单登记</div>
    <div class="tab" data-tab="device">设备登记</div>
    <div class="tab" data-tab="summary">汇总 / 明细</div>
    <div class="tab" data-tab="sku">SKU 录入</div>
    <div class="tab" data-tab="tags">标签管理</div>
    <div class="tab" data-tab="settings">设置</div>
  </div>

  <!-- 运单 -->
  <section id="panel-tracking" class="panel">
    <div class="head">
      <h2>运单登记（UPS / FedEx 自动识别；FedEx 保存尾 12 位；错误+重复语音提示）</h2>
      <div class="flex">
        <button class="btn sm" id="tExport">导出全部运单 CSV</button>
        <label class="btn sm acc" for="tImport">导入CSV</label>
        <input id="tImport" type="file" accept=".csv" class="hidden"/>
        <button class="btn sm bad" id="tClear">清空</button>
      </div>
    </div>
    <div class="form">
      <input id="t_tag" list="tagList" placeholder="标签（如 U1/U2，支持下拉选择）"/>
      <input id="t_input" placeholder="扫描或输入运单（UPS 1Z... / FedEx 数字）" class="mono"/>
      <select id="t_type">
        <option value="auto">自动识别</option>
        <option value="UPS">UPS</option>
        <option value="FedEx">FedEx</option>
      </select>
      <input id="t_note" placeholder="备注（可选）"/>
      <button class="btn" id="tAdd">登记</button>
      <button class="btn" id="tFocus">聚焦</button>
    </div>
    <div class="stat">
      <div class="card"><div class="k">UPS</div><div class="v" id="tUPS">0</div></div>
      <div class="card"><div class="k">FedEx（尾 12 位）</div><div class="v" id="tFedEx">0</div></div>
      <div class="card"><div class="k">总计</div><div class="v" id="tCount">0</div></div>
      <div class="card"><div class="k">标签种类</div><div class="v" id="tTags">0</div></div>
    </div>

    <div class="tracking-window">
      <table style="width:100%;border-collapse:collapse;border-spacing:0;">
        <thead>
          <tr class="tracking-header-row">
            <th style="width:140px;">标签</th>
            <th>运单号</th>
            <th style="width:80px;">类型</th>
            <th style="width:180px;">时间</th>
            <th>备注</th>
            <th style="width:80px;">操作</th>
          </tr>
        </thead>
      </table>
      <div class="tracking-body-wrapper">
        <table style="width:100%;border-collapse:collapse;border-spacing:0;">
          <tbody id="tBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 设备 -->
  <section id="panel-device" class="panel hidden">
    <div class="head">
      <h2>设备登记（先标签 → SN → 自动跳 UPC → SKU 自动匹配；SN 11 位校验+去重）</h2>
      <div class="flex">
        <button class="btn sm" id="dExport">导出全部设备 CSV</button>
        <label class="btn sm acc" for="dImport">导入CSV</label>
        <input id="dImport" type="file" accept=".csv" class="hidden"/>
        <button class="btn sm bad" id="dClear">清空</button>
      </div>
    </div>
    <div class="form">
      <input id="d_tag" list="tagList" placeholder="标签（如 U1/U2，支持下拉选择）"/>
      <input id="d_serial" placeholder="序列号 Serial（必须 11 位字母+数字）" class="mono"/>
      <input id="d_upc" placeholder="UPC（停顿自动入库；允许重复）" class="mono"/>
      <input id="d_device" placeholder="Device（SKU 自动填）"/>
      <input id="d_capacity" placeholder="Capacity（SKU 自动填）"/>
      <input id="d_color" placeholder="Color（SKU 自动填）"/>
      <div class="full" style="display:flex;gap:8px;align-items:center;color:#9fb0c7;padding-top:0">
        <span>提示：SN 非 11 位或包含非法字符 → 红闪 + 语音“序列号错误”，停止保存；SN 重复可选阻止；UPC 重复仅警告不阻止。</span>
      </div>
    </div>
    <div class="stat">
      <div class="card"><div class="k">设备总数</div><div class="v" id="dCount">0</div></div>
      <div class="card"><div class="k">唯一序列号</div><div class="v" id="dUnique">0</div></div>
      <div class="card"><div class="k">标签种类</div><div class="v" id="dTags">0</div></div>
      <div class="card"><div class="k">最近登记</div><div class="v" id="dLast">-</div></div>
    </div>

    <div class="tracking-window">
      <table style="width:100%;border-collapse:collapse;border-spacing:0;">
        <thead>
          <tr class="tracking-header-row">
            <th style="width:120px;">标签</th>
            <th style="width:130px;">序列号</th>
            <th style="width:130px;">UPC</th>
            <th>Device</th>
            <th style="width:80px;">容量</th>
            <th style="width:80px;">颜色</th>
            <th style="width:170px;">时间</th>
            <th style="width:70px;">状态</th>
            <th style="width:80px;">操作</th>
          </tr>
        </thead>
      </table>
      <div class="tracking-body-wrapper">
        <table style="width:100%;border-collapse:collapse;border-spacing:0;">
          <tbody id="dBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 汇总 / 明细 v3.7 -->
  <section id="panel-summary" class="panel hidden">
    <div class="head">
      <h2>汇总 / 明细（按日期 · 按标签）</h2>
      <div class="flex">
        <span style="font-size:12px;color:#9ca3af;">工作日期：</span>
        <input type="date" id="sumDate" style="height:28px;border-radius:8px;border:1px solid #273549;background:#020617;color:#e5e7eb;padding:0 8px;font-size:12px"/>
        <button class="btn sm acc" id="btnExportByTag">按标签导出 CSV</button>
      </div>
    </div>

    <div class="stat">
      <div class="card">
        <div class="k">当日运单数量</div>
        <div class="v" id="sumWaybillCount">0</div>
      </div>
      <div class="card">
        <div class="k">当日设备数量</div>
        <div class="v" id="sumDeviceCount">0</div>
      </div>
      <div class="card">
        <div class="k">当日标签数</div>
        <div class="v" id="sumTagCount">0</div>
      </div>
      <div class="card">
        <div class="k">说明</div>
        <div class="v" style="font-size:12px;">仅统计所选日期的 DB.tracking / DB.device</div>
      </div>
    </div>

    <div class="sum-window" style="margin:10px 14px 14px;">
      <table style="width:100%;border-collapse:collapse;border-spacing:0;">
        <thead>
          <tr class="sum-header-row">
            <th style="width:160px;">标签</th>
            <th style="width:120px;">运单数量</th>
            <th style="width:120px;">设备数量</th>
          </tr>
        </thead>
      </table>
      <div class="sum-body-wrapper">
        <table style="width:100%;border-collapse:collapse;border-spacing:0;">
          <tbody id="summaryByTagBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- SKU -->
  <section id="panel-sku" class="panel hidden">
    <div class="head">
      <h2>SKU 录入 / 查看（UPC → Device/Capacity/Color；支持手动 + 批量）</h2>
      <div class="flex">
        <button class="btn sm" id="skuExport">导出 SKU 映射 CSV</button>
        <button class="btn sm bad" id="skuClear">清空映射</button>
      </div>
    </div>
    <div class="form">
      <input id="sku_upc" placeholder="UPC（必填）" class="mono"/>
      <input id="sku_device" placeholder="Device"/>
      <input id="sku_capacity" placeholder="Capacity"/>
      <input id="sku_color" placeholder="Color"/>
      <button class="btn good" id="skuAdd">添加/更新一条</button>
      <label class="btn acc" for="skuFile">导入CSV</label>
      <input id="skuFile" type="file" accept=".csv" class="hidden"/>
      <div class="full">
        <textarea id="skuPaste" placeholder="从 Google 表格复制四列（UPC,Device,Capacity,Color）后粘贴到这里，每行一条"></textarea>
      </div>
      <button class="btn" id="skuPasteBtn">从文本批量导入</button>
      <div class="full" style="color:#9fb0c7">提示：重复 UPC 会覆盖更新；导入支持 CSV 或直接粘贴。</div>
    </div>
    <table>
      <thead><tr><th>UPC</th><th>Device</th><th>Capacity</th><th>Color</th><th>操作</th></tr></thead>
      <tbody id="skuBody"></tbody>
    </table>
  </section>

  <!-- 标签管理 -->
  <section id="panel-tags" class="panel hidden">
    <div class="head">
      <h2>标签管理（打标签页面：扫描时可直接下拉选择）</h2>
      <div class="flex">
        <button class="btn sm" id="tagRefresh">刷新标签列表</button>
      </div>
    </div>
    <div class="form">
      <input id="tagNew" placeholder="新标签（如 tiand cai / U1 等）"/>
      <button class="btn good" id="tagAdd">添加标签</button>
      <div class="full" style="color:#9fb0c7">
        说明：这里维护可选标签列表。扫描运单/设备时，如果输入了新的标签，也会自动加入到标签列表（A+B+C+D）。
      </div>
    </div>

    <div class="tracking-window">
      <table style="width:100%;border-collapse:collapse;border-spacing:0;" class="tag-table">
        <thead>
          <tr class="tracking-header-row">
            <th style="width:260px;">标签</th>
            <th style="width:120px;">运单数量</th>
            <th style="width:120px;">设备数量</th>
            <th style="width:140px;">操作</th>
          </tr>
        </thead>
      </table>
      <div class="tracking-body-wrapper">
        <table style="width:100%;border-collapse:collapse;border-spacing:0;" class="tag-table">
          <tbody id="tagBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 设置 -->
  <section id="panel-settings" class="panel hidden">
    <div class="head"><h2>设置</h2></div>
    <div class="form">
      <label class="full" style="display:flex;gap:10px;align-items:center">
        <input type="checkbox" id="setFedTail"> FedEx 运单只保留后 12 位
      </label>
      <label class="full" style="display:flex;gap:10px;align-items:center">
        <input type="checkbox" id="setVoice"> 启用中文语音提示（错误时播报）
      </label>
      <label class="full" style="display:flex;gap:10px;align-items:center">
        <input type="checkbox" id="setBeep"> 启用提示音（成功/警告）
      </label>
      <label class="full" style="display:flex;gap:10px;align-items:center">
        <input type="checkbox" id="setBlockDupSN"> 序列号重复阻止保存（否则仅警告）
      </label>
      <label class="full" style="display:flex;gap:10px;align-items:center">
        <input type="checkbox" id="setAutoScan"> 启用“无回车自动入库”（扫描停止 ~180ms 自动保存）
      </label>
      <label class="full" style="display:flex;gap:10px;align-items:center">
        <input type="checkbox" id="setConfirmDel" checked> 删除前确认
      </label>
      <div class="full" style="color:#9fb0c7">所有数据与设置均保存在本机浏览器 localStorage（键名：<span class="mono">TIANDAO_SCAN_V34</span>）；可随时导出 CSV 备份。</div>
    </div>
  </section>

  <div class="footer">© 天道扫码 v3.7 · 本地运行</div>
</div>

<datalist id="tagList"></datalist>

<!-- 新导出弹窗 -->
<div id="exportOverlay"
     class="export-overlay hidden"
     onclick="if(event.target===this) closeExportByTag();">
  <div class="export-modal">
    <div class="export-header">
      <div class="export-title">按标签导出 CSV</div>
      <div class="export-date">日期：<span id="exportDateText"></span></div>
      <button class="export-close" id="exportCloseBtn"
              onclick="closeExportByTag();">×</button>
    </div>
    <div class="export-body">
      <div class="export-column">
        <div class="export-column-title">运单标签</div>
        <div class="export-column-list" id="waybillTagList"></div>
      </div>
      <div class="export-column">
        <div class="export-column-title">设备标签</div>
        <div class="export-column-list" id="deviceTagList"></div>
      </div>
    </div>
    <div class="export-footer">
      <div class="export-selected">
        已选择：运单标签 <span id="countWaybill">0</span> 个，
        设备标签 <span id="countDevice">0</span> 个
      </div>
      <div class="export-footer-buttons">
        <button class="btn sm" id="btnExportCancel"
                onclick="closeExportByTag();">取消</button>
        <button class="btn sm acc" id="btnExportWaybillCSV">导出运单 CSV</button>
        <button class="btn sm acc" id="btnExportDeviceCSV">导出设备 CSV</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== 数据存储 ===== */
const storeKey='TIANDAO_SCAN_V34';
const DB=loadDB();
function loadDB(){
  try{
    const d=JSON.parse(localStorage.getItem(storeKey)||'{}');
    return Object.assign({
      settings:{fedTail:true,voice:true,beep:true,blockDupSN:true,autoScan:true,confirmDel:true},
      tags:[],
      tracking:[],
      device:[],
      sku:{}
    },d);
  }catch(e){
    return {
      settings:{fedTail:true,voice:true,beep:true,blockDupSN:true,autoScan:true,confirmDel:true},
      tags:[],
      tracking:[],
      device:[],
      sku:{}
    };
  }
}
function save(){ localStorage.setItem(storeKey,JSON.stringify(DB)); }

/* ===== 工具函数 ===== */
const $=s=>document.querySelector(s);
const el=(t,a={},h='')=>{const n=document.createElement(t);for(const k in a){k==='class'?n.className=a[k]:n.setAttribute(k,a[k])}if(h)n.innerHTML=h;return n;}
function nowPair(){
  const dt=new Date();
  return {
    created_at:dt.toLocaleString('zh-CN',{hour12:false}),
    created_date:dt.toISOString().slice(0,10)
  };
}
function beep(kind='ok'){
  if(!DB.settings.beep) return;
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const o=ctx.createOscillator(), g=ctx.createGain();
  o.type='sine';
  o.frequency.value= kind==='ok'?880: kind==='warn'?440:220;
  g.gain.value=0.05; o.connect(g); g.connect(ctx.destination);
  o.start(); setTimeout(()=>{o.stop();ctx.close()},160);
}

/* ===== 中文语音播报 ===== */
function speakTextZh(text){
  if(!('speechSynthesis' in window)) return;
  const u=new SpeechSynthesisUtterance(text);
  u.lang='zh-CN';
  window.speechSynthesis.speak(u);
}

function playVoice(kind, fallbackText){
  if(!DB.settings.voice) return;
  let text='';
  switch(kind){
    case 'trackingErr':
      text='运单号错误';
      break;
    case 'dupTracking':
      text='运单号重复，未保存';
      break;
    case 'serialErr':
      text='序列号错误';
      break;
    case 'dupSerial':
      text='序列号重复';
      break;
    default:
      text='';
  }
  if(text) speakTextZh(text);
}

/* 高亮闪烁 */
function flash(node, cls){
  node.classList.remove('warn','err'); void node.offsetWidth;
  node.classList.add(cls); setTimeout(()=>node.classList.remove(cls),700);
}

/* ===== Tab 切换 ===== */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const n=t.dataset.tab;
    ['tracking','device','summary','sku','tags','settings'].forEach(id=>{
      $('#panel-'+id).classList.toggle('hidden',id!==n);
    });
    if(n==='summary'){ renderSummary(); }
    if(n==='sku'){ renderSKU(); }
    if(n==='tags'){ renderTags(); }
  });
});

/* ===== FedEx / UPS 识别 ===== */
function normalizeTracking(raw, forceType){
  let s=(raw||'').toUpperCase().trim().replace(/\s+/g,'');
  let type='Unknown';
  if(forceType && forceType!=='auto') type=forceType;
  if(!forceType || forceType==='auto'){
    if(/^1Z[0-9A-Z]{16}$/.test(s)) type='UPS';
    else if(/^\d{12,34}$/.test(s)) type='FedEx';
  }
  if(type==='FedEx' && DB.settings.fedTail && /^\d+$/.test(s) && s.length>12){
    s=s.slice(-12);
  }
  return {tracking:s,type};
}
function validTracking(tracking,type){
  if(!tracking) return false;
  if(type==='UPS') return /^1Z[0-9A-Z]{16}$/.test(tracking);
  if(type==='FedEx') return /^\d{12}$/.test(tracking);
  return false;
}

/* ===== 标签工具 ===== */
function ensureTagExists(tag){
  const t=(tag||'').trim();
  if(!t) return;
  if(!DB.tags.includes(t)){
    DB.tags.push(t);
    save();
    refreshTagDatalist();
  }
}
function allTagsFromData(){
  const set=new Set(DB.tags || []);
  DB.tracking.forEach(r=>{ if(r.tag) set.add(r.tag); });
  DB.device.forEach(r=>{ if(r.tag) set.add(r.tag); });
  return [...set].sort((a,b)=>a.localeCompare(b,'zh-CN'));
}
function refreshTagDatalist(){
  const dl=$('#tagList'); if(!dl) return;
  dl.innerHTML='';
  allTagsFromData().forEach(t=>{
    const opt=document.createElement('option');
    opt.value=t;
    dl.appendChild(opt);
  });
}

/* ===== 运单模块 ===== */
const tTag=$('#t_tag'), tInput=$('#t_input'), tType=$('#t_type'), tNote=$('#t_note');
$('#tFocus').onclick=()=>tInput.focus();
$('#tAdd').onclick=()=>addTracking(tInput.value);
$('#tClear').onclick=()=>{
  if(!DB.settings.confirmDel || confirm('确定清空全部运单？')){
    DB.tracking=[]; save(); renderTracking(); renderSummary(); renderTags();
  }
};
$('#tExport').onclick=()=>exportCSVAll('tracking');
$('#tImport').addEventListener('change',e=>importCSV(e,'tracking'));
let tDeb;
tInput.addEventListener('input',()=>{
  if(!DB.settings.autoScan) return;
  clearTimeout(tDeb);
  tDeb=setTimeout(()=>addTracking(tInput.value,true),180);
});
tInput.addEventListener('keydown',e=>{
  if(e.key==='Enter') addTracking(tInput.value);
});
function addTracking(raw, fromAuto=false){
  raw=(raw||'').trim();
  if(!raw) return;
  const {tracking,type}=normalizeTracking(raw,tType.value);
  if(!tracking || !validTracking(tracking,type)){
    flash(tInput,'err');
    beep('bad');
    playVoice('trackingErr','');
    return;
  }
  const dup=DB.tracking.some(x=>x.tracking===tracking);
  if(dup){
    flash(tInput,'err');
    beep('bad');
    playVoice('dupTracking','');
    return;
  }
  const tag=tTag.value.trim();
  const {created_at,created_date}=nowPair();
  DB.tracking.push({
    id:Date.now()+Math.random(),
    tag,
    tracking,
    type,
    note:tNote.value.trim(),
    created_at,
    created_date
  });
  ensureTagExists(tag);
  save();
  tInput.value='';
  tNote.value='';
  beep('ok');
  renderTracking();
  renderSummary();
  renderTags();
  if(!fromAuto) tInput.focus();
}
function renderTracking(){
  const body=$('#tBody'); body.innerHTML='';
  const ups=DB.tracking.filter(x=>x.type==='UPS').length;
  const fed=DB.tracking.filter(x=>x.type==='FedEx').length;
  $('#tUPS').textContent=ups;
  $('#tFedEx').textContent=fed;
  $('#tCount').textContent=DB.tracking.length;
  $('#tTags').textContent=new Set(DB.tracking.map(x=>x.tag||'')).size;
  DB.tracking.slice().reverse().forEach(r=>{
    const tr=el('tr',{class:'tracking-row'});
    tr.appendChild(el('td',{},`<span class="chip mono">${r.tag||'-'}</span>`));
    tr.appendChild(el('td',{},`<span class="mono">${r.tracking}</span>`));
    tr.appendChild(el('td',{},r.type));
    tr.appendChild(el('td',{},r.created_at));
    tr.appendChild(el('td',{},r.note||'')); 
    const ops=el('td');
    const del=el('button',{class:'btn sm bad'},'删除');
    del.onclick=()=>{
      if(!DB.settings.confirmDel || confirm('删除该运单？')){
        DB.tracking=DB.tracking.filter(x=>x.id!==r.id);
        save(); renderTracking(); renderSummary(); renderTags();
      }
    };
    ops.appendChild(del);
    tr.appendChild(ops);
    body.appendChild(tr);
  });
}

/* ===== 设备模块 ===== */
const dTag=$('#d_tag'), dSerial=$('#d_serial'), dUPC=$('#d_upc'),
      dDev=$('#d_device'), dCap=$('#d_capacity'), dCol=$('#d_color');
$('#dClear').onclick=()=>{
  if(!DB.settings.confirmDel || confirm('确定清空全部设备？')){
    DB.device=[]; save(); renderDevice(); renderSummary(); renderTags();
  }
};
$('#dExport').onclick=()=>exportCSVAll('device');
$('#dImport').addEventListener('change',e=>importCSV(e,'device'));
dSerial.addEventListener('keydown',e=>{
  if(e.key==='Enter'){ dUPC.focus(); }
});
let upcDeb;
dUPC.addEventListener('input',()=>{
  const upc=dUPC.value.trim();
  if(upc && DB.sku[upc]){
    const {device,capacity,color}=DB.sku[upc];
    dDev.value=device||''; dCap.value=capacity||''; dCol.value=color||'';
  }
  if(!DB.settings.autoScan) return;
  clearTimeout(upcDeb);
  upcDeb=setTimeout(()=>addDevice(true),180);
});
dUPC.addEventListener('keydown',e=>{
  if(e.key==='Enter'){ addDevice(false); }
});
function isValidSerial(sn){
  return /^[0-9A-Z]{11}$/.test(sn);
}
function addDevice(fromAuto){
  const tag=dTag.value.trim();
  const serial=(dSerial.value||'').trim().toUpperCase();
  const upc=(dUPC.value||'').trim();
  if(!serial && !upc){
    dSerial.focus(); return;
  }
  if(serial && !isValidSerial(serial)){
    flash(dSerial,'err');
    beep('bad');
    playVoice('serialErr','');
    return;
  }
  if(serial){
    const dup=DB.device.some(x=>x.serial===serial);
    if(dup){
      flash(dSerial,'err');
      beep('bad');
      playVoice('dupSerial','');
      if(DB.settings.blockDupSN) return;
    }
  }
  if(upc && DB.device.some(x=>x.upc===upc)){
    flash(dUPC,'warn');
    beep('warn');
  }
  if(upc && (!dDev.value || !dCap.value || !dCol.value) && DB.sku[upc]){
    const s=DB.sku[upc];
    if(!dDev.value) dDev.value=s.device||'';
    if(!dCap.value) dCap.value=s.capacity||'';
    if(!dCol.value) dCol.value=s.color||'';
  }else if(upc && !DB.sku[upc]){
    flash(dUPC,'warn');
    beep('warn');
  }
  const {created_at,created_date}=nowPair();
  DB.device.push({
    id:Date.now()+Math.random(),
    tag,
    serial,
    upc,
    device:dDev.value.trim(),
    capacity:dCap.value.trim(),
    color:dCol.value.trim(),
    status:'OK',
    created_at,
    created_date
  });
  ensureTagExists(tag);
  save();
  dSerial.value=''; dUPC.value=''; dDev.value=''; dCap.value=''; dCol.value='';
  beep('ok');
  renderDevice();
  renderSummary();
  renderTags();
  dSerial.focus();
}
function renderDevice(){
  const body=$('#dBody'); body.innerHTML='';
  const uniq=new Set(DB.device.map(x=>x.serial).filter(Boolean));
  $('#dCount').textContent=DB.device.length;
  $('#dUnique').textContent=uniq.size;
  $('#dTags').textContent=new Set(DB.device.map(x=>x.tag||'')).size;
  $('#dLast').textContent=DB.device.length? DB.device[DB.device.length-1].created_at : '-';
  DB.device.slice().reverse().forEach(r=>{
    const tr=el('tr',{class:'tracking-row'});
    tr.appendChild(el('td',{},`<span class="chip mono">${r.tag||'-'}</span>`));
    const sCell=el('td',{}, r.serial?`<span class="mono">${r.serial}</span>`:'-');
    if(r.serial && DB.device.filter(x=>x.serial===r.serial).length>1){
      sCell.style.color='var(--bad)'; sCell.style.fontWeight='700';
    }
    tr.appendChild(sCell);
    tr.appendChild(el('td',{}, r.upc?`<span class="mono">${r.upc}</span>`:'-'));
    tr.appendChild(el('td',{}, r.device||'')); 
    tr.appendChild(el('td',{}, r.capacity||'')); 
    tr.appendChild(el('td',{}, r.color||'')); 
    tr.appendChild(el('td',{}, r.created_at)); 
    tr.appendChild(el('td',{}, r.status||'')); 
    const ops=el('td');
    const del=el('button',{class:'btn sm bad'},'删除');
    del.onclick=()=>{
      if(!DB.settings.confirmDel || confirm('删除该设备？')){
        DB.device=DB.device.filter(x=>x.id!==r.id);
        save(); renderDevice(); renderSummary(); renderTags();
      }
    };
    ops.appendChild(del);
    tr.appendChild(ops);
    body.appendChild(tr);
  });
}

/* ===== 汇总 / 明细 v3.7 ===== */
function getSummaryDate(){
  const input=$('#sumDate');
  return input && input.value ? input.value : '';
}
function renderSummary(){
  const date=getSummaryDate();
  const dayT=DB.tracking.filter(r=>!date || r.created_date===date);
  const dayD=DB.device.filter(r=>!date || r.created_date===date);
  $('#sumWaybillCount').textContent=dayT.length;
  $('#sumDeviceCount').textContent=dayD.length;
  const map=new Map();
  function addTag(tag,kind){
    const key=(tag && tag.trim()) || '(未填标签)';
    if(!map.has(key)) map.set(key,{t:0,d:0});
    const obj=map.get(key);
    if(kind==='t') obj.t++; else obj.d++;
  }
  dayT.forEach(r=>addTag(r.tag,'t'));
  dayD.forEach(r=>addTag(r.tag,'d'));
  const tbody=$('#summaryByTagBody');
  tbody.innerHTML='';
  const tags=[...map.keys()].sort((a,b)=>a.localeCompare(b,'zh-CN'));
  $('#sumTagCount').textContent=tags.length;
  if(tags.length===0){
    const tr=document.createElement('tr');
    const td=document.createElement('td');
    td.colSpan=3;
    td.style.fontSize='12px';
    td.style.color='#9ca3af';
    td.textContent=date ? '该日期暂无数据' : '暂无数据';
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }
  tags.forEach(tag=>{
    const rec=map.get(tag);
    const tr=document.createElement('tr');
    tr.className='sum-row';
    tr.innerHTML=
      `<td><span class="chip mono">${tag}</span></td>`+
      `<td>${rec.t}</td>`+
      `<td>${rec.d}</td>`;
    tbody.appendChild(tr);
  });
}

/* 导出弹窗：按标签导出 */
function openExportByTag(){
  const date=getSummaryDate();
  if(!date){
    alert('请先选择日期'); return;
  }
  $('#exportDateText').textContent=date;
  buildExportTagLists(date);
  $('#exportOverlay').classList.remove('hidden');
}
function closeExportByTag(){
  $('#exportOverlay').classList.add('hidden');
}
function buildExportTagLists(date){
  const wWrap=$('#waybillTagList');
  const dWrap=$('#deviceTagList');
  wWrap.innerHTML='';
  dWrap.innerHTML='';
  const dayT=DB.tracking.filter(r=>r.created_date===date);
  const dayD=DB.device.filter(r=>r.created_date===date);
  const tTags=[...new Set(dayT.map(r=>(r.tag||'').trim()).filter(Boolean))]
    .sort((a,b)=>a.localeCompare(b,'zh-CN'));
  const dTags=[...new Set(dayD.map(r=>(r.tag||'').trim()).filter(Boolean))]
    .sort((a,b)=>a.localeCompare(b,'zh-CN'));
  if(!tTags.length){
    const div=document.createElement('div');
    div.className='export-empty';
    div.textContent='当前日期无运单标签';
    wWrap.appendChild(div);
  }else{
    tTags.forEach(tag=>wWrap.appendChild(createExportTagItem(tag,'tracking')));
  }
  if(!dTags.length){
    const div=document.createElement('div');
    div.className='export-empty';
    div.textContent='当前日期无设备标签';
    dWrap.appendChild(div);
  }else{
    dTags.forEach(tag=>dWrap.appendChild(createExportTagItem(tag,'device')));
  }
  updateExportSelectedCount();
}
function createExportTagItem(tag,type){
  const label=document.createElement('label');
  label.className='export-tag-item';
  const input=document.createElement('input');
  input.type='checkbox';
  input.dataset.type=type;
  input.dataset.label=tag;
  input.addEventListener('change',updateExportSelectedCount);
  const span=document.createElement('span');
  span.textContent=tag;
  label.appendChild(input);
  label.appendChild(span);
  return label;
}
function updateExportSelectedCount(){
  const all=document.querySelectorAll('.export-tag-item input[type="checkbox"]');
  let ct=0, cd=0;
  all.forEach(i=>{
    if(i.checked){
      if(i.dataset.type==='tracking') ct++;
      if(i.dataset.type==='device') cd++;
    }
  });
  $('#countWaybill').textContent=ct;
  $('#countDevice').textContent=cd;
}
function getSelectedExportTags(type){
  return [...document.querySelectorAll(`.export-tag-item input[data-type="${type}"]:checked`)]
    .map(i=>i.dataset.label);
}
function exportTrackingByTag(){
  const date=getSummaryDate();
  if(!date){ alert('请先选择日期'); return; }
  const tags=getSelectedExportTags('tracking');
  const data=DB.tracking.filter(r=>{
    if(r.created_date!==date) return false;
    if(!tags.length) return true;
    return tags.includes(r.tag||'');
  });
  if(!data.length){
    alert('当前日期下所选标签没有运单数据'); return;
  }
  const rows=[['日期','运单号','客户标签','备注']];
  data.forEach(r=>{
    rows.push([
      r.created_date||'',
      r.tracking||'',
      r.tag||'',
      r.note||''
    ]);
  });
  downloadCSV('tracking_'+date,rows);
}
function exportDeviceByTag(){
  const date=getSummaryDate();
  if(!date){ alert('请先选择日期'); return; }
  const tags=getSelectedExportTags('device');
  const data=DB.device.filter(r=>{
    if(r.created_date!==date) return false;
    if(!tags.length) return true;
    return tags.includes(r.tag||'');
  });
  if(!data.length){
    alert('当前日期下所选标签没有设备数据'); return;
  }
  const rows=[['日期','序列号','UPC','Device','颜色','容量','标签','状态']];
  data.forEach(r=>{
    rows.push([
      r.created_date||'',
      r.serial||'',
      r.upc||'',
      r.device||'',
      r.color||'',
      r.capacity||'',
      r.tag||'',
      r.status||''
    ]);
  });
  downloadCSV('device_'+date,rows);
}

/* ===== SKU 模块 ===== */
const skuUpc=$('#sku_upc'), skuDev=$('#sku_device'),
      skuCap=$('#sku_capacity'), skuCol=$('#sku_color');
$('#skuAdd').onclick=()=>{
  const upc=(skuUpc.value||'').trim();
  if(!upc) return;
  DB.sku[upc]={
    device:skuDev.value.trim(),
    capacity:skuCap.value.trim(),
    color:skuCol.value.trim()
  };
  save();
  skuUpc.value=''; skuDev.value=''; skuCap.value=''; skuCol.value='';
  beep('ok');
  renderSKU();
};
$('#skuFile').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    const lines=r.result.split(/\r?\n/).filter(x=>x.trim());
    lines.slice(1).forEach(row=>{
      const cells=row.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(x=>x.replace(/^"|"$/g,'').replace(/""/g,'"'));
      const [u,d,c,co]=cells;
      if(u) DB.sku[u.trim()]={device:(d||'').trim(),capacity:(c||'').trim(),color:(co||'').trim()};
    });
    save(); renderSKU(); beep('ok'); e.target.value='';
  };
  r.readAsText(f,'utf-8');
});
$('#skuPasteBtn').onclick=()=>{
  const txt=$('#skuPaste').value||''; if(!txt.trim()) return;
  txt.split(/\r?\n/).forEach(line=>{
    if(!line.trim()) return;
    const cells=line.split(/\t|,/);
    const [u,d,c,co]=[cells[0],cells[1],cells[2],cells[3]].map(x=>(x||'').trim());
    if(u) DB.sku[u]={device:d||'',capacity:c||'',color:co||''};
  });
  save(); renderSKU(); beep('ok');
};
$('#skuExport').onclick=()=>{
  const rows=[['upc','device','capacity','color']];
  Object.entries(DB.sku).forEach(([u,v])=>{
    rows.push([u,v.device||'',v.capacity||'',v.color||'']);
  });
  downloadCSV('sku_map',rows);
};
$('#skuClear').onclick=()=>{
  if(!DB.settings.confirmDel || confirm('清空全部 SKU 映射？')){
    DB.sku={}; save(); renderSKU();
  }
};
function renderSKU(){
  const body=$('#skuBody'); body.innerHTML='';
  const arr=Object.entries(DB.sku).map(([u,v])=>({upc:u,...v}))
    .sort((a,b)=>a.upc.localeCompare(b.upc));
  arr.forEach(row=>{
    const tr=el('tr');
    tr.appendChild(el('td',{},`<span class="mono">${row.upc}</span>`));
    tr.appendChild(el('td',{},row.device||'')); 
    tr.appendChild(el('td',{},row.capacity||'')); 
    tr.appendChild(el('td',{},row.color||'')); 
    const ops=el('td');
    const del=el('button',{class:'btn sm bad'},'删除');
    del.onclick=()=>{
      if(!DB.settings.confirmDel || confirm('删除此 SKU？')){
        delete DB.sku[row.upc]; save(); renderSKU();
      }
    };
    ops.appendChild(del);
    tr.appendChild(ops);
    body.appendChild(tr);
  });
}

/* ===== 标签管理 ===== */
$('#tagAdd').onclick=()=>{
  const t=($('#tagNew').value||'').trim();
  if(!t) return;
  if(!DB.tags.includes(t)) DB.tags.push(t);
  $('#tagNew').value='';
  save();
  refreshTagDatalist();
  renderTags();
};
$('#tagRefresh').onclick=()=>{ renderTags(); };
function renderTags(){
  const body=$('#tagBody'); body.innerHTML='';
  const tags=allTagsFromData();
  tags.forEach(tag=>{
    const tCount=DB.tracking.filter(r=>r.tag===tag).length;
    const dCount=DB.device.filter(r=>r.tag===tag).length;
    const tr=el('tr',{class:'tracking-row'});
    tr.appendChild(el('td',{},`<span class="chip mono">${tag}</span>`));
    tr.appendChild(el('td',{},String(tCount)));
    tr.appendChild(el('td',{},String(dCount)));
    const ops=el('td');
    const btnEdit=el('button',{class:'btn sm'},'重命名');
    const btnDel=el('button',{class:'btn sm bad'},'删除');
    btnEdit.onclick=()=>{
      const next=prompt('输入新的标签名称：',tag);
      if(!next) return;
      const newTag=next.trim();
      if(!newTag || newTag===tag) return;
      DB.tracking.forEach(r=>{ if(r.tag===tag) r.tag=newTag; });
      DB.device.forEach(r=>{ if(r.tag===tag) r.tag=newTag; });
      DB.tags=DB.tags.filter(x=>x!==tag);
      if(!DB.tags.includes(newTag)) DB.tags.push(newTag);
      save();
      refreshTagDatalist();
      renderTracking();
      renderDevice();
      renderSummary();
      renderTags();
    };
    btnDel.onclick=()=>{
      if(!DB.settings.confirmDel || confirm('仅从“标签列表”中删除，不会修改历史记录，确定？')){
        DB.tags=DB.tags.filter(x=>x!==tag);
        save();
        refreshTagDatalist();
        renderTags();
      }
    };
    ops.appendChild(btnEdit);
    ops.appendChild(btnDel);
    tr.appendChild(ops);
    body.appendChild(tr);
  });
}

/* ===== 导入导出通用 ===== */
function toCSV(arr){
  return arr.map(r=>r.map(c=>{
    const s=(c==null?'':String(c));
    return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s;
  }).join(',')).join('\n');
}
function downloadCSV(name, rows){
  const blob=new Blob(["\uFEFF"+toCSV(rows)],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.download=`${name}_${Date.now()}.csv`;
  a.href=URL.createObjectURL(blob);
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),500);
}
function exportCSVAll(kind){
  if(kind==='tracking'){
    const rows=[['tag','tracking','type','note','created_at','created_date']];
    DB.tracking.forEach(r=>{
      rows.push([r.tag||'',r.tracking||'',r.type||'',r.note||'',r.created_at||'',r.created_date||'']);
    });
    downloadCSV('tracking_all',rows);
  }else{
    const rows=[['tag','serial','upc','device','capacity','color','status','created_at','created_date']];
    DB.device.forEach(r=>{
      rows.push([r.tag||'',r.serial||'',r.upc||'',r.device||'',r.capacity||'',r.color||'',r.status||'',r.created_at||'',r.created_date||'']);
    });
    downloadCSV('device_all',rows);
  }
}
function importCSV(evt,kind){
  const f=evt.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    const lines=r.result.split(/\r?\n/).filter(x=>x.trim());
    if(!lines.length){ evt.target.value=''; return; }
    lines.shift();
    const today=new Date().toISOString().slice(0,10);
    lines.forEach(line=>{
      const cells=line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s=>s.replace(/^"|"$/g,'').replace(/""/g,'"'));
      if(kind==='tracking'){
        const [tag,tracking,type,note,created_at,created_date]=cells;
        const norm=normalizeTracking(tracking,type==='auto'?'auto':type);
        const dDate=(created_date||'').trim()||today;
        DB.tracking.push({
          id:Date.now()+Math.random(),
          tag:(tag||'').trim(),
          tracking:norm.tracking,
          type:norm.type||'Unknown',
          note:(note||'').trim(),
          created_at:created_at||nowPair().created_at,
          created_date:dDate
        });
        ensureTagExists(tag);
      }else{
        const [tag,serial,upc,device,capacity,color,status,created_at,created_date]=cells;
        const dDate=(created_date||'').trim()||today;
        DB.device.push({
          id:Date.now()+Math.random(),
          tag:(tag||'').trim(),
          serial:(serial||'').trim().toUpperCase(),
          upc:(upc||'').trim(),
          device:(device||'').trim(),
          capacity:(capacity||'').trim(),
          color:(color||'').trim(),
          status:(status||'').trim() || 'OK',
          created_at:created_at||nowPair().created_at,
          created_date:dDate
        });
        ensureTagExists(tag);
      }
    });
    save();
    if(kind==='tracking'){ renderTracking(); }
    else{ renderDevice(); }
    renderSummary();
    renderTags();
    evt.target.value='';
  };
  r.readAsText(f,'utf-8');
}

/* ===== 设置 ===== */
const setFedTail=$('#setFedTail'),
      setVoice=$('#setVoice'),
      setBeep=$('#setBeep'),
      setBlockDupSN=$('#setBlockDupSN'),
      setAutoScan=$('#setAutoScan'),
      setConfirm=$('#setConfirmDel');
function loadSettingsUI(){
  setFedTail.checked=!!DB.settings.fedTail;
  setVoice.checked=!!DB.settings.voice;
  setBeep.checked=!!DB.settings.beep;
  setBlockDupSN.checked=!!DB.settings.blockDupSN;
  setAutoScan.checked=!!DB.settings.autoScan;
  setConfirm.checked=!!DB.settings.confirmDel;
}
[setFedTail,setVoice,setBeep,setBlockDupSN,setAutoScan,setConfirm].forEach(inp=>{
  inp.addEventListener('change',()=>{
    DB.settings.fedTail=setFedTail.checked;
    DB.settings.voice=setVoice.checked;
    DB.settings.beep=setBeep.checked;
    DB.settings.blockDupSN=setBlockDupSN.checked;
    DB.settings.autoScan=setAutoScan.checked;
    DB.settings.confirmDel=setConfirm.checked;
    save();
  });
});

/* ===== 初始化 ===== */
refreshTagDatalist();
renderTracking();
renderDevice();
renderSKU();
renderTags();
loadSettingsUI();

// 汇总日期默认今天
const sumDateInput=$('#sumDate');
if(sumDateInput){
  sumDateInput.value=new Date().toISOString().slice(0,10);
  sumDateInput.addEventListener('change',renderSummary);
}
renderSummary();

// 绑定导出相关事件
(function bindExportEvents(){
  const b1=$('#btnExportByTag');        if(b1) b1.onclick=openExportByTag;
  const b2=$('#btnExportCancel');      if(b2) b2.onclick=closeExportByTag;
  const b3=$('#exportCloseBtn');       if(b3) b3.onclick=closeExportByTag;
  const b4=$('#btnExportWaybillCSV');  if(b4) b4.onclick=exportTrackingByTag;
  const b5=$('#btnExportDeviceCSV');   if(b5) b5.onclick=exportDeviceByTag;
})();

// Esc 关闭弹窗
document.addEventListener('keydown',e=>{
  const ov=$('#exportOverlay');
  if(e.key==='Escape' && ov && !ov.classList.contains('hidden')){
    closeExportByTag();
  }
});
</script>
</body>
</html>
