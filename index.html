<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>扫码平台 · Apple自动识别 + 汇总</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body { background: #f7f9fb; font-family: ui-sans-serif, system-ui; }
.card { background: #fff; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 1.5rem; margin-top: 1.5rem; }
.btn { background: #2563eb; color: #fff; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
.btn:hover { background: #1d4ed8; }
input, select { border: 1px solid #ddd; border-radius: 0.375rem; padding: 0.4rem; }
table { width: 100%; border-collapse: collapse; }
th, td { border: 1px solid #ddd; padding: 0.5rem; text-align: center; }
th { background: #f3f4f6; }
tr:nth-child(even) { background: #fafafa; }
</style>
</head>

<body class="p-6">
  <h1 class="text-2xl font-bold text-gray-800 mb-2">📦 Apple 扫码登记平台</h1>
  <p class="text-gray-600 mb-6">支持：UPC 自动识别型号/容量/颜色（数据来自 Google Sheet）</p>

  <div class="card">
    <h2 class="text-xl font-semibold mb-3">🔗 SKU 映射连接</h2>
    <input type="text" id="sheetUrl" class="w-full mb-2" placeholder="请输入你的 Google Sheet 链接" value="https://docs.google.com/spreadsheets/d/1lalx-2-FhcH0dM7_60DQotTmWaZojaPxn955MLXDaTk/edit#gid=0">
    <button class="btn" onclick="loadSKU()">加载 SKU 映射</button>
    <span id="skuStatus" class="ml-3 text-sm text-gray-600"></span>
  </div>

  <div class="card">
    <h2 class="text-xl font-semibold mb-3">📱 设备登记</h2>
    <div class="flex gap-2 mb-3">
      <input type="text" id="upc" placeholder="UPC" class="flex-1">
      <input type="text" id="device" placeholder="Device" class="w-1/4 device">
      <input type="text" id="capacity" placeholder="Capacity" class="w-1/4 capacity">
      <input type="text" id="color" placeholder="Color" class="w-1/4 color">
      <button class="btn" onclick="addRow()">登记</button>
    </div>

    <table id="dataTable">
      <thead>
        <tr><th>UPC</th><th>Device</th><th>Capacity</th><th>Color</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
// --- SKU_MAP 自动识别逻辑 ---
let skuMap = {};

async function loadSKU() {
  const url = document.getElementById('sheetUrl').value.trim();
  const csvUrl = url.replace('/edit#gid=', '/gviz/tq?tqx=out:csv&gid=');
  document.getElementById('skuStatus').innerText = '加载中...';

  try {
    const res = await fetch(csvUrl);
    const text = await res.text();
    const rows = text.split(/\r?\n/).slice(1);
    skuMap = {};
    rows.forEach(row => {
      const [upc, device, capacity, color] = row.split(',');
      if (upc) skuMap[upc.trim()] = { device, capacity, color };
    });

    localStorage.setItem('skuMap', JSON.stringify(skuMap));
    document.getElementById('skuStatus').innerText = `✅ 已加载 ${Object.keys(skuMap).length} 条 SKU 映射`;
  } catch (err) {
    document.getElementById('skuStatus').innerText = '❌ 加载失败，请检查链接是否公开';
  }
}

window.addEventListener('load', () => {
  const cache = localStorage.getItem('skuMap');
  if (cache) {
    skuMap = JSON.parse(cache);
    document.getElementById('skuStatus').innerText = `✅ 已加载缓存映射 ${Object.keys(skuMap).length} 条`;
  }
});

document.getElementById('upc').addEventListener('input', e => {
  const upc = e.target.value.trim();
  const sku = skuMap[upc];
  if (sku) {
    document.getElementById('device').value = sku.device || '';
    document.getElementById('capacity').value = sku.capacity || '';
    document.getElementById('color').value = sku.color || '';
  }
});

function addRow() {
  const upc = document.getElementById('upc').value.trim();
  const device = document.getElementById('device').value.trim();
  const capacity = document.getElementById('capacity').value.trim();
  const color = document.getElementById('color').value.trim();
  if (!upc) return alert('请填写 UPC');

  const tbody = document.querySelector('#dataTable tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${upc}</td><td>${device}</td><td>${capacity}</td><td>${color}</td>`;
  tbody.appendChild(tr);

  document.getElementById('upc').value = '';
  document.getElementById('device').value = '';
  document.getElementById('capacity').value = '';
  document.getElementById('color').value = '';
  document.getElementById('upc').focus();
}
</script>

</body>
</html>
