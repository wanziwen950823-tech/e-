<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>扫码平台 v1.8 · 运单/设备 · 暗色</title>
<style>
:root{
  --bg:#0b0f14;--panel:#121822;--card:#0f1520;--muted:#98a2b3;--text:#e8eef6;--accent:#4cc9f0;--accent2:#7c5cff;--good:#22c55e;--warn:#f59e0b;--bad:#ef4444;--line:#1f2937;
  --chip:#1b2331; --chip-b:#2b364a; --btn:#1a2232; --btn-b:#2a3448;
}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0a0e14 0%,#0b111a 100%);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;}
.wrap{max-width:1200px;margin:0 auto;padding:24px}
.title{display:flex;gap:12px;align-items:center;margin-bottom:16px}
.logo{width:14px;height:14px;border-radius:4px;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 0 0 2px #111 inset}
h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
.pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2a3a55;background:#121a2b;color:#c6d6f0}
.right{margin-left:auto}.muted{color:var(--muted)}
.tabs{display:flex;gap:8px;margin:8px 0 20px}
.tab{cursor:pointer;padding:10px 14px;border-radius:10px;background:var(--btn);border:1px solid var(--btn-b);opacity:.9}
.tab.active{background:linear-gradient(180deg,#151d2b,#0f1623);border-color:#2a3a55;opacity:1;box-shadow:0 0 0 1px #2a3a55 inset}
.panel{background:linear-gradient(180deg,#0c1220,#0a111c);border:1px solid #1e2a3f;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);margin-bottom:14px}
.head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #1f2a40}
.head h2{font-size:14px;margin:0;color:#cdd6e5}
.form{display:grid;grid-template-columns:repeat(8,1fr);gap:10px;padding:16px}
.form .full{grid-column:1/-1}
input,select,button{height:38px;padding:0 10px;border-radius:10px;border:1px solid #2a3448;background:#0e1522;color:var(--text);outline:none}
input::placeholder{color:#6b7280}
button{cursor:pointer;background:linear-gradient(180deg,#1a2232,#121a28);border-color:#2a3448}
.btn-sm{height:30px;padding:0 10px;border-radius:8px;font-size:12px}
.primary{background:linear-gradient(180deg,#1d2a40,#132135);border-color:#2f405e}
.accent{background:linear-gradient(180deg,#214155,#163042);border-color:#2e5a76;color:#dbeafe}
.good{background:linear-gradient(180deg,#12361f,#0f2a19);border-color:#1d4d2b}
.bad{background:linear-gradient(180deg,#3a1212,#2a0f0f);border-color:#5a1f1f}
.flex{display:flex;gap:10px;align-items:center}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:0 16px 16px}
.stat{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;padding:12px 16px;border-top:1px dashed #23334d;background:linear-gradient(180deg,#0b111c,#0a0f18)}
.card{background:linear-gradient(180deg,#0d1320,#0b111a);border:1px solid #1e2940;border-radius:12px;padding:12px}
.card .v{font-size:20px;font-weight:700}
table{width:100%;border-collapse:separate;border-spacing:0 8px;padding:0 16px 16px}
thead th{font-size:12px;font-weight:600;color:#9fb0c7;text-align:left;padding:0 8px}
tbody tr{background:linear-gradient(180deg,#0c1320,#0b101a);border:1px solid #1e2a40}
tbody td{padding:10px 8px;border-top:1px solid #1e2a40;border-bottom:1px solid #1e2a40}
.chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--chip-b);padding:4px 8px;border-radius:999px;font-size:12px}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
.row-bad{outline:2px solid var(--bad)}
.exp-row{background:#0d1526;border-left:3px solid #2e4a7a}
.hidden{display:none}
.footer{margin-top:22px;color:#8b9ab3;text-align:center;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <div class="logo"></div><h1>扫码平台 · v1.8</h1>
    <span class="pill">本地运行 / 可部署 GitHub Pages</span>
    <span class="right muted">暗色科技风</span>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="tracking">运单登记</div>
    <div class="tab" data-tab="device">设备登记</div>
    <div class="tab" data-tab="summary">汇总 / 明细</div>
    <div class="tab" data-tab="settings">设置 / SKU</div>
  </div>

  <!-- 运单 -->
  <section id="panel-tracking" class="panel">
    <div class="head">
      <h2>运单登记（FedEx 截取后 12 位 / UPS 保留完整）</h2>
      <div class="flex">
        <button class="btn-sm" id="btnExportTracking">导出CSV</button>
        <label class="btn-sm accent" for="impT">导入CSV</label>
        <input id="impT" type="file" accept=".csv" class="hidden"/>
        <button class="btn-sm bad" id="btnClearTracking">清空运单</button>
      </div>
    </div>
    <div class="form">
      <input id="t_tag" placeholder="标记（如 A001）"/>
      <input id="t_input" placeholder="扫描或输入运单号（FedEx/UPS）"/>
      <select id="t_type">
        <option value="auto">自动识别</option><option value="FedEx">FedEx</option><option value="UPS">UPS</option>
      </select>
      <input id="t_note" placeholder="备注（可选）"/>
      <button id="btnAddTracking" class="primary">登记运单</button>
      <button id="btnFocusT">聚焦</button>
      <div class="full muted">提示：扫描枪回车也可入库；支持 CSV 导入/导出。</div>
    </div>
    <div class="stat" id="tStat">
      <div class="card"><div class="muted">运单总数</div><div class="v" id="tCount">0</div></div>
      <div class="card"><div class="muted">FedEx</div><div class="v" id="tFedex">0</div></div>
      <div class="card"><div class="muted">UPS</div><div class="v" id="tUps">0</div></div>
      <div class="card"><div class="muted">标记种类</div><div class="v" id="tTags">0</div></div>
    </div>
    <table>
      <thead><tr><th>标记</th><th>运单号</th><th>类型</th><th>时间</th><th>备注</th><th>操作</th></tr></thead>
      <tbody id="tBody"></tbody>
    </table>
  </section>

  <!-- 设备 -->
  <section id="panel-device" class="panel hidden">
    <div class="head">
      <h2>设备登记（Serial / UPC · 自动匹配 SKU · 无需回车）</h2>
      <div class="flex">
        <button class="btn-sm" id="btnExportDevice">导出CSV</button>
        <label class="btn-sm accent" for="impD">导入CSV</label>
        <input id="impD" type="file" accept=".csv" class="hidden"/>
        <button class="btn-sm bad" id="btnClearDevice">清空设备</button>
      </div>
    </div>
    <div class="form">
      <input id="d_tag" placeholder="标记（如 A001）"/>
      <input id="d_serial" placeholder="序列号（Serial）"/>
      <input id="d_upc" placeholder="UPC（停输入自动匹配+保存）"/>
      <input id="d_device" placeholder="Device"/>
      <input id="d_capacity" placeholder="Capacity"/>
      <input id="d_color" placeholder="Color"/>
      <button id="btnAddDevice" class="primary">登记设备</button>
      <button id="btnFocusD">聚焦</button>
      <div class="full muted">逻辑：Serial 扫完→自动跳到 UPC；UPC 停止输入 <span id="delayHint">400</span>ms → 自动匹配 SKU + 保存 + 回到 Serial。</div>
    </div>
    <div class="stat" id="dStat">
      <div class="card"><div class="muted">设备总数</div><div class="v" id="dCount">0</div></div>
      <div class="card"><div class="muted">唯一序列号</div><div class="v" id="dUnique">0</div></div>
      <div class="card"><div class="muted">标记种类</div><div class="v" id="dTags">0</div></div>
      <div class="card"><div class="muted">最近登记</div><div class="v" id="dLast">-</div></div>
    </div>
    <table>
      <thead><tr><th>标记</th><th>序列号</th><th>UPC</th><th>Device</th><th>Capacity</th><th>Color</th><th>时间</th><th>状态</th><th>操作</th></tr></thead>
      <tbody id="dBody"></tbody>
    </table>
  </section>

  <!-- 汇总 -->
  <section id="panel-summary" class="panel hidden">
    <div class="head">
      <h2>汇总 / 明细（按 Tag 手动关联：同 Tag 的运单与设备归集）</h2>
      <div class="flex">
        <button id="btnExpandAll" class="btn-sm">全部展开</button>
        <button id="btnCollapseAll" class="btn-sm">全部收起</button>
      </div>
    </div>
    <div class="grid2">
      <div>
        <div style="padding:12px 16px"><span class="chip">运单汇总</span> <span class="muted">（点击 ▶ 展开）</span></div>
        <table><thead><tr><th>Tag</th><th>运单数</th><th>最近时间</th><th>操作</th></tr></thead><tbody id="sumT"></tbody></table>
      </div>
      <div>
        <div style="padding:12px 16px"><span class="chip">设备汇总</span> <span class="muted">（点击 ▶ 展开）</span></div>
        <table><thead><tr><th>Tag</th><th>设备数</th><th>最近时间</th><th>操作</th></tr></thead><tbody id="sumD"></tbody></table>
      </div>
    </div>
  </section>

  <!-- 设置 / SKU -->
  <section id="panel-settings" class="panel hidden">
    <div class="head"><h2>设置 & SKU 映射</h2></div>
    <div class="form">
      <div class="full"><b>SKU 映射来源</b>（三选一，都会缓存）</div>
      <div class="full">
        <button class="btn-sm accent" id="btnPickCsv">上传本地 CSV</button>
        <input id="skuCsv" type="file" accept=".csv" class="hidden"/>
      </div>
      <input id="skuUrl" class="full" placeholder="Google 表格 CSV 链接（建议使用 gviz 导出：.../gviz/tq?tqx=out:csv）"/>
      <button id="btnLoadSkuUrl" class="btn-sm">从链接加载</button>
      <div class="full muted" id="skuStatus">SKU 映射：未加载</div>

      <div class="full"><b>行为设置</b></div>
      <label class="flex"><input type="checkbox" id="setFedexTail" checked style="width:18px;height:18px;margin-right:8px">FedEx 仅保留后 12 位</label>
      <label class="flex"><input type="checkbox" id="setSound" checked style="width:18px;height:18px;margin-right:8px">启用提示音</label>
      <label class="flex"><input type="checkbox" id="setConfirmDelete" checked style="width:18px;height:18px;margin-right:8px">删除前确认</label>
      <div class="full">
        <label class="muted">UPC 智能保存延迟（ms）</label>
        <input type="range" id="setDelay" min="200" max="800" step="50" value="400">
        <div class="muted">当前：<span id="delayShow">400</span> ms</div>
      </div>
    </div>
  </section>

  <div class="footer">© 扫码平台 v1.8 · 本地存储（localStorage）· 支持 GitHub Pages 部署</div>
</div>

<script>
/* ====== 存储 ====== */
const store = {
  load(){
    const d = JSON.parse(localStorage.getItem('SCAN_PLATFORM_V18')||'{}');
    return Object.assign({
      settings:{ fedexTail12:true, sound:true, confirmDelete:true, smartDelay:400 },
      tracking:[], // {id, tag, tracking, type, note, created_at}
      device:[],   // {id, tag, serial, upc, device, capacity, color, status, created_at}
      skuMap:{}    // { upc: {device,capacity,color} }
    }, d);
  },
  save(data){ localStorage.setItem('SCAN_PLATFORM_V18', JSON.stringify(data)); }
};
let DB = store.load();

/* ====== 工具 ====== */
const $ = s => document.querySelector(s);
const el = (t,a={},h='')=>{const n=document.createElement(t);for(const k in a){k==='class'?n.className=a[k]:n.setAttribute(k,a[k]);}if(h)n.innerHTML=h;return n;}
const now = ()=> new Date().toLocaleString('zh-CN',{hour12:false});
const beep = (kind)=>{ if(!DB.settings.sound) return; const a=new Audio(); a.src = kind==='ok'? BEEP_OK : kind==='warn'? BEEP_WARN : BEEP_ERR; a.volume=.5; a.play(); };
const BEEP_OK='data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAABkAAAA';
const BEEP_WARN='data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAABkAAAA';
const BEEP_ERR='data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAABkAAAA';

/* ====== Tabs ====== */
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const name=t.dataset.tab;
  ['tracking','device','summary','settings'].forEach(id=>{
    $('#panel-'+id).classList.toggle('hidden', id!==name);
  });
}));

/* ====== 运单规范化 ====== */
function normalizeTracking(raw, forceType){
  let s=(raw||'').trim().toUpperCase().replace(/\s+/g,''); let type='Unknown';
  if(forceType && forceType!=='auto') type=forceType;
  if(!forceType || forceType==='auto'){
    if(/^1Z[0-9A-Z]{16}$/.test(s)) type='UPS';
    else if(/^\d{12,22}$/.test(s)) type='FedEx';
  }
  if(type==='FedEx' && DB.settings.fedexTail12 && /^\d+$/.test(s) && s.length>12) s=s.slice(-12);
  return {tracking:s,type};
}

/* ====== 运单模块 ====== */
const tTag=$('#t_tag'), tInput=$('#t_input'), tType=$('#t_type'), tNote=$('#t_note');
$('#btnAddTracking').onclick=addTracking;
$('#btnFocusT').onclick=()=>tInput.focus();
$('#btnClearTracking').onclick=()=>{ if(!DB.settings.confirmDelete||confirm('确定清空所有运单记录？')){ DB.tracking=[]; store.save(DB); renderTracking(); renderSummary(); }};
$('#btnExportTracking').onclick=()=>exportCSV('tracking');
$('#impT').addEventListener('change',e=>importCSV(e,'tracking'));
tInput.addEventListener('keydown',e=>{ if(e.key==='Enter') addTracking(); });

function addTracking(){
  const tag=tTag.value.trim(); const raw=tInput.value.trim(); if(!raw){ tInput.focus(); return; }
  const {tracking,type}=normalizeTracking(raw,tType.value);
  DB.tracking.push({ id:Date.now()+Math.random(), tag, tracking, type, note:tNote.value.trim(), created_at:now() });
  store.save(DB); tInput.value=''; tNote.value=''; beep('ok'); renderTracking(); renderSummary();
}
function renderTracking(){
  $('#tBody').innerHTML='';
  $('#tCount').textContent=DB.tracking.length;
  $('#tFedex').textContent=DB.tracking.filter(x=>x.type==='FedEx').length;
  $('#tUps').textContent=DB.tracking.filter(x=>x.type==='UPS').length;
  $('#tTags').textContent=new Set(DB.tracking.map(x=>x.tag||'')).size;
  DB.tracking.slice().reverse().forEach(r=>{
    const tr=el('tr');
    tr.appendChild(el('td',{},`<span class="chip mono">${r.tag||'-'}</span>`));
    tr.appendChild(el('td',{},`<span class="mono">${r.tracking}</span>`));
    tr.appendChild(el('td',{},r.type));
    tr.appendChild(el('td',{},r.created_at));
    tr.appendChild(el('td',{},r.note||'')); 
    const ops=el('td'); const del=el('button',{class:'btn-sm bad'},'删除');
    del.onclick=()=>{ if(!DB.settings.confirmDelete||confirm('删除该运单记录？')){ DB.tracking=DB.tracking.filter(x=>x.id!==r.id); store.save(DB); renderTracking(); renderSummary(); }};
    ops.appendChild(del); tr.appendChild(ops); $('#tBody').appendChild(tr);
  });
}

/* ====== 设备模块（智能：Serial→UPC，UPC 停止输入自动保存） ====== */
const dTag=$('#d_tag'), dSerial=$('#d_serial'), dUPC=$('#d_upc');
const dDevice=$('#d_device'), dCap=$('#d_capacity'), dColor=$('#d_color');
$('#btnAddDevice').onclick=addDeviceManual;
$('#btnFocusD').onclick=()=> (dSerial.value? dUPC : dSerial).focus();
$('#btnClearDevice').onclick=()=>{ if(!DB.settings.confirmDelete||confirm('确定清空所有设备记录？')){ DB.device=[]; store.save(DB); renderDevice(); renderSummary(); }};
$('#btnExportDevice').onclick=()=>exportCSV('device');
$('#impD').addEventListener('change',e=>importCSV(e,'device'));

// Serial 扫完回车 → 跳 UPC
dSerial.addEventListener('keydown',e=>{ if(e.key==='Enter'){ dUPC.focus(); } });

// UPC 智能停顿 → 自动匹配 SKU + 自动保存并回到 Serial
let upcTimer=null;
dUPC.addEventListener('input', ()=>{
  clearTimeout(upcTimer);
  upcTimer=setTimeout(()=>{ autoMatchAndSave(); }, DB.settings.smartDelay||400);
});

function autoMatchAndSave(){
  // 有 UPC 时尝试匹配后保存
  const upc=(dUPC.value||'').trim();
  const sku=DB.skuMap[upc];
  if(sku){ dDevice.value=sku.device||''; dCap.value=sku.capacity||''; dColor.value=sku.color||''; }
  // 自动保存
  if((dSerial.value||dUPC.value).trim()){
    addDeviceRecord();
    // 清空&回到 Serial
    dSerial.value=''; dUPC.value=''; dDevice.value=''; dCap.value=''; dColor.value='';
    dSerial.focus();
  }
}

function addDeviceManual(){ // 手动按钮
  autoFillFromSkuField(); addDeviceRecord(); dSerial.value=''; dUPC.value=''; dDevice.value=''; dCap.value=''; dColor.value=''; dSerial.focus();
}
function autoFillFromSkuField(){
  const upc=(dUPC.value||'').trim(); const sku=DB.skuMap[upc];
  if(sku){ dDevice.value=sku.device||''; dCap.value=sku.capacity||''; dColor.value=sku.color||''; }
}
function addDeviceRecord(){
  const tag=dTag.value.trim();
  const serial=(dSerial.value||'').trim().toUpperCase();
  const upc=(dUPC.value||'').trim();
  const dev=(dDevice.value||'').trim();
  const cap=(dCap.value||'').trim();
  const col=(dColor.value||'').trim();
  if(!serial && !upc){ dSerial.focus(); return; }
  let status='OK';
  if(serial && DB.device.some(x=>x.serial===serial)){ status='重复'; }
  DB.device.push({ id:Date.now()+Math.random(), tag, serial, upc, device:dev, capacity:cap, color:col, status, created_at:now() });
  store.save(DB); beep(status==='重复'?'warn':'ok'); renderDevice(); renderSummary();
}

function renderDevice(){
  const body=$('#dBody'); body.innerHTML='';
  const uniq=new Set(DB.device.map(x=>x.serial).filter(Boolean));
  $('#dCount').textContent=DB.device.length;
  $('#dUnique').textContent=uniq.size;
  $('#dTags').textContent=new Set(DB.device.map(x=>x.tag||'')).size;
  $('#dLast').textContent=DB.device.length? DB.device[DB.device.length-1].created_at : '-';

  DB.device.slice().reverse().forEach(r=>{
    const tr=el('tr'); if(r.status==='重复') tr.classList.add('row-bad');
    tr.appendChild(el('td',{},`<span class="chip mono">${r.tag||'-'}</span>`));
    tr.appendChild(el('td',{}, r.serial?`<span class="mono">${r.serial}</span>`:'-'));
    tr.appendChild(el('td',{}, r.upc?`<span class="mono">${r.upc}</span>`:'-'));
    tr.appendChild(el('td',{}, r.device||'')); tr.appendChild(el('td',{}, r.capacity||'')); tr.appendChild(el('td',{}, r.color||''));
    tr.appendChild(el('td',{}, r.created_at));
    tr.appendChild(el('td',{}, r.status));
    const ops=el('td'); const del=el('button',{class:'btn-sm bad'},'删除');
    del.onclick=()=>{ if(!DB.settings.confirmDelete||confirm('删除该设备记录？')){ DB.device=DB.device.filter(x=>x.id!==r.id); store.save(DB); renderDevice(); renderSummary(); }};
    ops.appendChild(del); tr.appendChild(ops); body.appendChild(tr);
  });
}

/* ====== 汇总/明细（按 Tag 手动关联归集） ====== */
function groupByTag(arr){ const m=new Map(); arr.forEach(r=>{const k=r.tag||''; if(!m.has(k)) m.set(k,[]); m.get(k).push(r);}); return m; }
function renderSummary(){
  // 运单
  const sumT=$('#sumT'); sumT.innerHTML='';
  const gT=groupByTag(DB.tracking);
  [...gT.entries()].sort((a,b)=>(a[0]||'').localeCompare(b[0]||'')).forEach(([tag,arr])=>{
    const last=arr.at(-1)?.created_at||'-'; const tr=el('tr');
    tr.appendChild(el('td',{},`<span class="chip mono">${tag||'-'}</span>`));
    tr.appendChild(el('td',{}, String(arr.length)));
    tr.appendChild(el('td',{}, last));
    const op=el('td'); const btn=el('button',{class:'btn-sm'},'▶ 展开'); let open=false; let detail=[];
    btn.onclick=()=>{ open=!open; btn.textContent=open?'▼ 收起':'▶ 展开';
      if(open){ arr.forEach(r=>{ const dr=el('tr',{class:'exp-row'});
        dr.appendChild(el('td',{},'')); dr.appendChild(el('td',{},`${r.type} · <span class="mono">${r.tracking}</span>`));
        dr.appendChild(el('td',{},r.created_at));
        const td=el('td'); const dbtn=el('button',{class:'btn-sm bad'},'删除');
        dbtn.onclick=()=>{ if(!DB.settings.confirmDelete||confirm('删除该运单记录？')){ DB.tracking=DB.tracking.filter(x=>x.id!==r.id); store.save(DB); renderTracking(); renderSummary(); } };
        td.appendChild(dbtn); dr.appendChild(td); tr.parentNode.insertBefore(dr,tr.nextSibling); detail.push(dr); }); }
      else { detail.forEach(n=>n.remove()); detail=[]; }
    };
    const xbtn=el('button',{class:'btn-sm right'},'导出此Tag'); xbtn.onclick=()=>exportCSVTag('tracking',tag);
    op.appendChild(btn); op.appendChild(xbtn); tr.appendChild(op); sumT.appendChild(tr);
  });

  // 设备
  const sumD=$('#sumD'); sumD.innerHTML='';
  const gD=groupByTag(DB.device);
  [...gD.entries()].sort((a,b)=>(a[0]||'').localeCompare(b[0]||'')).forEach(([tag,arr])=>{
    const last=arr.at(-1)?.created_at||'-'; const tr=el('tr');
    tr.appendChild(el('td',{},`<span class="chip mono">${tag||'-'}</span>`));
    tr.appendChild(el('td',{}, String(arr.length)));
    tr.appendChild(el('td',{}, last));
    const op=el('td'); const btn=el('button',{class:'btn-sm'},'▶ 展开'); let open=false; let detail=[];
    btn.onclick=()=>{ open=!open; btn.textContent=open?'▼ 收起':'▶ 展开';
      if(open){ arr.forEach(r=>{ const dr=el('tr',{class:'exp-row'});
        dr.appendChild(el('td',{},'')); dr.appendChild(el('td',{},`SN <span class="mono">${r.serial||'-'}</span> · UPC <span class="mono">${r.upc||'-'}</span> · ${r.device||''} ${r.capacity||''} ${r.color||''}`));
        dr.appendChild(el('td',{},r.created_at));
        const td=el('td'); const dbtn=el('button',{class:'btn-sm bad'},'删除');
        dbtn.onclick=()=>{ if(!DB.settings.confirmDelete||confirm('删除该设备记录？')){ DB.device=DB.device.filter(x=>x.id!==r.id); store.save(DB); renderDevice(); renderSummary(); } };
        td.appendChild(dbtn); dr.appendChild(td); tr.parentNode.insertBefore(dr,tr.nextSibling); detail.push(dr); }); }
      else { detail.forEach(n=>n.remove()); detail=[]; }
    };
    const xbtn=el('button',{class:'btn-sm right'},'导出此Tag'); xbtn.onclick=()=>exportCSVTag('device',tag);
    op.appendChild(btn); op.appendChild(xbtn); tr.appendChild(op); sumD.appendChild(tr);
  });
}
$('#btnExpandAll').onclick=()=>{ document.querySelectorAll('#sumT .btn-sm, #sumD .btn-sm').forEach(b=>{ if(b.textContent==='▶ 展开') b.click(); }); };
$('#btnCollapseAll').onclick=()=>{ document.querySelectorAll('#sumT .btn-sm, #sumD .btn-sm').forEach(b=>{ if(b.textContent==='▼ 收起') b.click(); }); };

/* ====== CSV 导入/导出 ====== */
function toCSV(rows){ return rows.map(r=>r.map(v=>{const s=(v==null?'':String(v)); return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s;}).join(',')).join('\n'); }
function exportCSV(kind){
  let rows=[], name='';
  if(kind==='tracking'){ rows=[['tag','tracking','type','note','created_at']].concat(DB.tracking.map(r=>[r.tag||'',r.tracking,r.type,r.note||'',r.created_at])); name='tracking'; }
  else { rows=[['tag','serial','upc','device','capacity','color','status','created_at']].concat(DB.device.map(r=>[r.tag||'',r.serial||'',r.upc||'',r.device||'',r.capacity||'',r.color||'',r.status||'',r.created_at])); name='device'; }
  const blob=new Blob(["\ufeff"+toCSV(rows)],{type:'text/csv;charset=utf-8;'}); const a=el('a',{download:`${name}_${Date.now()}.csv`}); a.href=URL.createObjectURL(blob); a.click();
}
function exportCSVTag(kind,tag){
  let rows=[], name='';
  if(kind==='tracking'){ const arr=DB.tracking.filter(r=>(r.tag||'')===tag);
    rows=[['tag','tracking','type','note','created_at']].concat(arr.map(r=>[r.tag||'',r.tracking,r.type,r.note||'',r.created_at])); name='tracking_'+(tag||'blank'); }
  else { const arr=DB.device.filter(r=>(r.tag||'')===tag);
    rows=[['tag','serial','upc','device','capacity','color','status','created_at']].concat(arr.map(r=>[r.tag||'',r.serial||'',r.upc||'',r.device||'',r.capacity||'',r.color||'',r.status||'',r.created_at])); name='device_'+(tag||'blank'); }
  const blob=new Blob(["\ufeff"+toCSV(rows)],{type:'text/csv;charset=utf-8;'}); const a=el('a',{download:`${name}_${Date.now()}.csv`}); a.href=URL.createObjectURL(blob); a.click();
}
function importCSV(evt,kind){
  const file=evt.target.files[0]; if(!file) return; const reader=new FileReader();
  reader.onload=()=>{ const text=reader.result; const lines=text.split(/\r?\n/).filter(x=>x.trim().length); lines.shift(); // drop header
    lines.forEach(line=>{
      const cols=line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s=>s.replace(/^"|"$/g,'').replace(/""/g,'"'));
      if(kind==='tracking'){ const [tag,tracking,type,note,created_at]=cols; const norm=normalizeTracking(tracking,type==='auto'?'auto':type);
        DB.tracking.push({ id:Date.now()+Math.random(), tag:tag||'', tracking:norm.tracking, type:norm.type||'Unknown', note:note||'', created_at:created_at||now() });
      }else{ const [tag,serial,upc,device,capacity,color,status,created_at]=cols;
        DB.device.push({ id:Date.now()+Math.random(), tag:tag||'', serial:(serial||'').toUpperCase(), upc:upc||'', device:device||'', capacity:capacity||'', color:color||'', status:status||'OK', created_at:created_at||now() });
      }
    });
    store.save(DB); renderTracking(); renderDevice(); renderSummary(); evt.target.value='';
  };
  reader.readAsText(file,'utf-8');
}

/* ====== SKU 映射（上传 / URL） ====== */
const skuStatus=$('#skuStatus');
$('#btnPickCsv').onclick=()=>$('#skuCsv').click();
$('#skuCsv').addEventListener('change',e=>{ const f=e.target.files[0]; if(!f) return; loadSkuFromFile(f); });
$('#btnLoadSkuUrl').onclick=async()=>{ const url=$('#skuUrl').value.trim(); if(!url){ alert('请输入 CSV 链接'); return; } await loadSkuFromUrl(url); };

async function loadSkuFromUrl(url){
  try{
    skuStatus.textContent='加载中…';
    const res=await fetch(url,{cache:'no-store'}); const text=await res.text();
    const map=parseSkuCsv(text); DB.skuMap=map; store.save(DB);
    skuStatus.textContent=`✅ 已从链接加载映射 ${Object.keys(map).length} 条（已缓存）`;
    beep('ok');
  }catch(e){
    skuStatus.textContent='❌ 加载失败（可能跨域/CORS）。可先下载为 CSV 再使用“上传本地 CSV”。';
    beep('warn');
  }
}
function loadSkuFromFile(file){
  const reader=new FileReader();
  reader.onload=()=>{ const text=reader.result; const map=parseSkuCsv(text); DB.skuMap=map; store.save(DB);
    skuStatus.textContent=`✅ 已加载本地映射 ${Object.keys(map).length} 条（已缓存）`; beep('ok'); };
  reader.readAsText(file,'utf-8');
}
function parseSkuCsv(text){
  const rows=text.split(/\r?\n/).filter(Boolean); rows.shift(); // header
  const map={};
  rows.forEach(r=>{
    const [upc,device,capacity,color]=r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s=>s?.replace(/^"|"$/g,'').replace(/""/g,'"')||'');
    if(upc) map[upc.trim()]=({device,capacity,color});
  });
  return map;
}

/* ====== 设置绑定 ====== */
const setFedex=$('#setFedexTail'), setSound=$('#setSound'), setConfirm=$('#setConfirmDelete'), setDelay=$('#setDelay'), delayShow=$('#delayShow'), delayHint=$('#delayHint');
setFedex.checked=!!DB.settings.fedexTail12; setSound.checked=!!DB.settings.sound; setConfirm.checked=!!DB.settings.confirmDelete;
setDelay.value=DB.settings.smartDelay||400; delayShow.textContent=setDelay.value; delayHint.textContent=setDelay.value;
setFedex.onchange=()=>{ DB.settings.fedexTail12=setFedex.checked; store.save(DB); };
setSound.onchange=()=>{ DB.settings.sound=setSound.checked; store.save(DB); };
setConfirm.onchange=()=>{ DB.settings.confirmDelete=setConfirm.checked; store.save(DB); };
setDelay.oninput=()=>{ delayShow.textContent=setDelay.value; delayHint.textContent=setDelay.value; };
setDelay.onchange=()=>{ DB.settings.smartDelay=+setDelay.value; store.save(DB); };

/* ====== 初始化 ====== */
function renderAll(){ renderTracking(); renderDevice(); renderSummary(); }
(function init(){
  // 恢复 SKU 状态
  const count=Object.keys(DB.skuMap||{}).length;
  skuStatus.textContent = count? `✅ 已缓存映射 ${count} 条` : 'SKU 映射：未加载';
  renderAll();
})();
</script>
</body>
</html>
